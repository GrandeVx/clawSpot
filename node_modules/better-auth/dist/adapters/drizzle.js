import{and as U,asc as j,desc as C,eq as F,inArray as N,like as k,or as K}from"drizzle-orm";import{z as a}from"zod";var J=a.object({id:a.string(),providerId:a.string(),accountId:a.string(),userId:a.string(),accessToken:a.string().nullish(),refreshToken:a.string().nullish(),idToken:a.string().nullish(),expiresAt:a.date().nullish(),password:a.string().nullish()}),G=a.object({id:a.string(),email:a.string().transform(e=>e.toLowerCase()),emailVerified:a.boolean().default(!1),name:a.string(),image:a.string().nullish(),createdAt:a.date().default(new Date),updatedAt:a.date().default(new Date)}),Q=a.object({id:a.string(),userId:a.string(),expiresAt:a.date(),ipAddress:a.string().nullish(),userAgent:a.string().nullish()}),Z=a.object({id:a.string(),value:a.string(),createdAt:a.date(),expiresAt:a.date(),identifier:a.string()});import{nanoid as ee}from"nanoid";var v=Object.create(null),x=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?v:globalThis),S=new Proxy(v,{get(e,i){return x()[i]??v[i]},has(e,i){let f=x();return i in f||i in v},set(e,i,f){let p=x(!0);return p[i]=f,!0},deleteProperty(e,i){if(!i)return!1;let f=x(!0);return delete f[i],!0},ownKeys(){let e=x(!0);return Object.keys(e)}});function q(e){return e?e!=="false":!1}var R=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var B=R==="test"||q(S.TEST);var T=e=>{let i=e.plugins?.reduce((s,l)=>{let n=l.schema;if(!n)return s;for(let[t,o]of Object.entries(n))s[t]={fields:{...s[t]?.fields,...o.fields},modelName:o.modelName||t};return s},{}),f=e.rateLimit?.storage==="database",p={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:u,session:y,account:m,...w}=i||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...u?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...y?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...m?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...w,...f?p:{}}};import{z as Fe}from"zod";var A=class extends Error{constructor(i,f){super(i),this.name="BetterAuthError",this.message=i,this.cause=f,this.stack=""}};import{Kysely as Ne,MssqlDialect as De}from"kysely";import{MysqlDialect as qe,PostgresDialect as Re,SqliteDialect as Be}from"kysely";import{createConsola as P}from"consola";var O=["info","success","warn","error","debug"];function V(e,i){return O.indexOf(i)<=O.indexOf(e)}var L=P({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),I=e=>{let i=e?.disabled!==!0,f=e?.level??"error",p=(u,y,m=[])=>{if(!(!i||!V(f,u))){if(!e||typeof e.log!="function"){L[u]("",y,...m);return}e.log(u==="success"?"info":u,y,m)}};return Object.fromEntries(O.map(u=>[u,(...[y,...m])=>p(u,y,m)]))},Ge=I();var z=(e,i,f)=>{let p=T(f);function u(s,l){return l==="id"?l:p[s].fields[l].fieldName||l}function y(s){let l=i.schema||e._.fullSchema;if(!l)throw new A("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");let n=m(s),t=l[n];if(!t)throw new A(`[# Drizzle Adapter]: The model "${s}" was not found in the schema object. Please pass the schema directly to the adapter options.`);return t}let m=s=>p[s].modelName!==s?p[s].modelName:i.usePlural?`${s}s`:s,w=i?.generateId!==!1;return{getSchema:y,transformInput(s,l){let n=s.id&&w?{id:i?.generateId?i.generateId():s.id}:{};for(let t in s){let o=p[l].fields[t];o&&(n[o.fieldName||t]=s[t])}return n},transformOutput(s,l,n=[]){if(!s)return null;let t=s.id||s._id?n.length===0||n.includes("id")?{id:s.id}:{}:{},o=p[l].fields;for(let d in o){if(n.length&&!n.includes(d))continue;let c=o[d];c&&(t[d]=s[c.fieldName||d])}return t},convertWhereClause(s,l){let n=y(l);if(!s)return[];if(s.length===1){let r=s[0];if(!r)return[];let g=u(l,r.field);if(!n[g])throw new A(`The field "${r.field}" does not exist in the schema for the model "${l}". Please update your schema.`);if(r.operator==="in"){if(!Array.isArray(r.value))throw new A(`The value for the field "${r.field}" must be an array when using the "in" operator.`);return[N(n[g],r.value)]}return r.operator==="contains"?[k(n[g],`%${r.value}%`)]:r.operator==="starts_with"?[k(n[g],`${r.value}%`)]:r.operator==="ends_with"?[k(n[g],`%${r.value}`)]:[F(n[g],r.value)]}let t=s.filter(r=>r.connector==="AND"||!r.connector),o=s.filter(r=>r.connector==="OR"),d=U(...t.map(r=>{let g=u(l,r.field);if(r.operator==="in"){if(!Array.isArray(r.value))throw new A(`The value for the field "${r.field}" must be an array when using the "in" operator.`);return N(n[g],r.value)}return F(n[g],r.value)})),c=K(...o.map(r=>{let g=u(l,r.field);return F(n[g],r.value)})),h=[];return t.length&&h.push(d),o.length&&h.push(c),h},withReturning:async(s,l,n)=>{if(i.provider!=="mysql")return(await l.returning())[0];await l;let t=y(m(s));return(await e.select().from(t).where(F(t.id,n.id)))[0]},getField:u,getModelName:m}};function E(e,i,f){if(!e)throw new A("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");for(let p in f)if(!e[p])throw new A(`The field "${p}" does not exist in the "${i}" schema. Please update your drizzle schema or re-generate using "npx @better-auth/cli generate".`)}var ht=(e,i)=>f=>{let{transformInput:p,transformOutput:u,convertWhereClause:y,getSchema:m,withReturning:w,getField:s,getModelName:l}=z(e,i,f);return{id:"drizzle",async create(n){let{model:t,data:o}=n,d=p(o,t),c=m(t);E(c,l(t),d);let h=e.insert(c).values(d),r=await w(t,h,d);return u(r,t)},async findOne(n){let{model:t,where:o,select:d}=n,c=m(t),h=y(o,t),r=await e.select().from(c).where(...h);return r.length?u(r[0],t,d):null},async findMany(n){let{model:t,where:o,sortBy:d,limit:c,offset:h}=n,r=m(t),g=o?y(o,t):[],b=d?.direction==="desc"?C:j;return(await e.select().from(r).limit(c||100).offset(h||0).orderBy(b(r[d?.field?s(t,d?.field):"id"])).where(...g)).map(D=>u(D,t))},async update(n){let{model:t,where:o,update:d}=n,c=m(t),h=y(o,t),r=p(d,t),g=e.update(c).set(r).where(...h),b=await w(t,g,r);return u(b,t)},async updateMany(n){let{model:t,where:o,update:d}=n,c=m(t),h=y(o,t),r=p(d,t),b=await e.update(c).set(r).where(...h);return b?b.changes:0},async delete(n){let{model:t,where:o}=n,d=m(t),c=y(o,t);await e.delete(d).where(...c)},async deleteMany(n){let{model:t,where:o}=n,d=m(t),c=y(o,t),r=await e.delete(d).where(...c);return r?r.length:0},options:i}};export{ht as drizzleAdapter};
