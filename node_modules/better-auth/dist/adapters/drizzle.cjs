"use strict";var O=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var P=(e,n)=>{for(var c in n)O(e,c,{get:n[c],enumerable:!0})},V=(e,n,c,f)=>{if(n&&typeof n=="object"||typeof n=="function")for(let d of B(n))!M.call(e,d)&&d!==c&&O(e,d,{get:()=>n[d],enumerable:!(f=R(n,d))||f.enumerable});return e};var L=e=>V(O({},"__esModule",{value:!0}),e);var Q={};P(Q,{drizzleAdapter:()=>G});module.exports=L(Q);var p=require("drizzle-orm");var a=require("zod"),te=a.z.object({id:a.z.string(),providerId:a.z.string(),accountId:a.z.string(),userId:a.z.string(),accessToken:a.z.string().nullish(),refreshToken:a.z.string().nullish(),idToken:a.z.string().nullish(),expiresAt:a.z.date().nullish(),password:a.z.string().nullish()}),re=a.z.object({id:a.z.string(),email:a.z.string().transform(e=>e.toLowerCase()),emailVerified:a.z.boolean().default(!1),name:a.z.string(),image:a.z.string().nullish(),createdAt:a.z.date().default(new Date),updatedAt:a.z.date().default(new Date)}),ne=a.z.object({id:a.z.string(),userId:a.z.string(),expiresAt:a.z.date(),ipAddress:a.z.string().nullish(),userAgent:a.z.string().nullish()}),se=a.z.object({id:a.z.string(),value:a.z.string(),createdAt:a.z.date(),expiresAt:a.z.date(),identifier:a.z.string()});var U=require("nanoid");var T=Object.create(null),v=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?T:globalThis),j=new Proxy(T,{get(e,n){return v()[n]??T[n]},has(e,n){let c=v();return n in c||n in T},set(e,n,c){let f=v(!0);return f[n]=c,!0},deleteProperty(e,n){if(!n)return!1;let c=v(!0);return delete c[n],!0},ownKeys(){let e=v(!0);return Object.keys(e)}});function C(e){return e?e!=="false":!1}var K=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var z=K==="test"||C(j.TEST);var F=e=>{let n=e.plugins?.reduce((i,u)=>{let s=u.schema;if(!s)return i;for(let[t,o]of Object.entries(s))i[t]={fields:{...i[t]?.fields,...o.fields},modelName:o.modelName||t};return i},{}),c=e.rateLimit?.storage==="database",f={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:d,session:g,account:y,...b}=n||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...d?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...g?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...y?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...b,...c?f:{}}};var E=require("zod");var w=class extends Error{constructor(n,c){super(n),this.name="BetterAuthError",this.message=n,this.cause=c,this.stack=""}};var N=require("kysely"),k=require("kysely");var D=require("consola"),I=["info","success","warn","error","debug"];function W(e,n){return I.indexOf(n)<=I.indexOf(e)}var _=(0,D.createConsola)({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),S=e=>{let n=e?.disabled!==!0,c=e?.level??"error",f=(d,g,y=[])=>{if(!(!n||!W(c,d))){if(!e||typeof e.log!="function"){_[d]("",g,...y);return}e.log(d==="success"?"info":d,g,y)}};return Object.fromEntries(I.map(d=>[d,(...[g,...y])=>f(d,g,y)]))},$e=S();var H=(e,n,c)=>{let f=F(c);function d(i,u){return u==="id"?u:f[i].fields[u].fieldName||u}function g(i){let u=n.schema||e._.fullSchema;if(!u)throw new w("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");let s=y(i),t=u[s];if(!t)throw new w(`[# Drizzle Adapter]: The model "${i}" was not found in the schema object. Please pass the schema directly to the adapter options.`);return t}let y=i=>f[i].modelName!==i?f[i].modelName:n.usePlural?`${i}s`:i,b=n?.generateId!==!1;return{getSchema:g,transformInput(i,u){let s=i.id&&b?{id:n?.generateId?n.generateId():i.id}:{};for(let t in i){let o=f[u].fields[t];o&&(s[o.fieldName||t]=i[t])}return s},transformOutput(i,u,s=[]){if(!i)return null;let t=i.id||i._id?s.length===0||s.includes("id")?{id:i.id}:{}:{},o=f[u].fields;for(let l in o){if(s.length&&!s.includes(l))continue;let m=o[l];m&&(t[l]=i[m.fieldName||l])}return t},convertWhereClause(i,u){let s=g(u);if(!i)return[];if(i.length===1){let r=i[0];if(!r)return[];let h=d(u,r.field);if(!s[h])throw new w(`The field "${r.field}" does not exist in the schema for the model "${u}". Please update your schema.`);if(r.operator==="in"){if(!Array.isArray(r.value))throw new w(`The value for the field "${r.field}" must be an array when using the "in" operator.`);return[(0,p.inArray)(s[h],r.value)]}return r.operator==="contains"?[(0,p.like)(s[h],`%${r.value}%`)]:r.operator==="starts_with"?[(0,p.like)(s[h],`${r.value}%`)]:r.operator==="ends_with"?[(0,p.like)(s[h],`%${r.value}`)]:[(0,p.eq)(s[h],r.value)]}let t=i.filter(r=>r.connector==="AND"||!r.connector),o=i.filter(r=>r.connector==="OR"),l=(0,p.and)(...t.map(r=>{let h=d(u,r.field);if(r.operator==="in"){if(!Array.isArray(r.value))throw new w(`The value for the field "${r.field}" must be an array when using the "in" operator.`);return(0,p.inArray)(s[h],r.value)}return(0,p.eq)(s[h],r.value)})),m=(0,p.or)(...o.map(r=>{let h=d(u,r.field);return(0,p.eq)(s[h],r.value)})),A=[];return t.length&&A.push(l),o.length&&A.push(m),A},withReturning:async(i,u,s)=>{if(n.provider!=="mysql")return(await u.returning())[0];await u;let t=g(y(i));return(await e.select().from(t).where((0,p.eq)(t.id,s.id)))[0]},getField:d,getModelName:y}};function J(e,n,c){if(!e)throw new w("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");for(let f in c)if(!e[f])throw new w(`The field "${f}" does not exist in the "${n}" schema. Please update your drizzle schema or re-generate using "npx @better-auth/cli generate".`)}var G=(e,n)=>c=>{let{transformInput:f,transformOutput:d,convertWhereClause:g,getSchema:y,withReturning:b,getField:i,getModelName:u}=H(e,n,c);return{id:"drizzle",async create(s){let{model:t,data:o}=s,l=f(o,t),m=y(t);J(m,u(t),l);let A=e.insert(m).values(l),r=await b(t,A,l);return d(r,t)},async findOne(s){let{model:t,where:o,select:l}=s,m=y(t),A=g(o,t),r=await e.select().from(m).where(...A);return r.length?d(r[0],t,l):null},async findMany(s){let{model:t,where:o,sortBy:l,limit:m,offset:A}=s,r=y(t),h=o?g(o,t):[],x=l?.direction==="desc"?p.desc:p.asc;return(await e.select().from(r).limit(m||100).offset(A||0).orderBy(x(r[l?.field?i(t,l?.field):"id"])).where(...h)).map(q=>d(q,t))},async update(s){let{model:t,where:o,update:l}=s,m=y(t),A=g(o,t),r=f(l,t),h=e.update(m).set(r).where(...A),x=await b(t,h,r);return d(x,t)},async updateMany(s){let{model:t,where:o,update:l}=s,m=y(t),A=g(o,t),r=f(l,t),x=await e.update(m).set(r).where(...A);return x?x.changes:0},async delete(s){let{model:t,where:o}=s,l=y(t),m=g(o,t);await e.delete(l).where(...m)},async deleteMany(s){let{model:t,where:o}=s,l=y(t),m=g(o,t),r=await e.delete(l).where(...m);return r?r.length:0},options:n}};0&&(module.exports={drizzleAdapter});
