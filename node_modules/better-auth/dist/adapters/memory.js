import{z as n}from"zod";var R=n.object({id:n.string(),providerId:n.string(),accountId:n.string(),userId:n.string(),accessToken:n.string().nullish(),refreshToken:n.string().nullish(),idToken:n.string().nullish(),expiresAt:n.date().nullish(),password:n.string().nullish()}),B=n.object({id:n.string(),email:n.string().transform(e=>e.toLowerCase()),emailVerified:n.boolean().default(!1),name:n.string(),image:n.string().nullish(),createdAt:n.date().default(new Date),updatedAt:n.date().default(new Date)}),V=n.object({id:n.string(),userId:n.string(),expiresAt:n.date(),ipAddress:n.string().nullish(),userAgent:n.string().nullish()}),M=n.object({id:n.string(),value:n.string(),createdAt:n.date(),expiresAt:n.date(),identifier:n.string()});import{nanoid as U}from"nanoid";var g=Object.create(null),y=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?g:globalThis),w=new Proxy(g,{get(e,u){return y()[u]??g[u]},has(e,u){let f=y();return u in f||u in g},set(e,u,f){let a=y(!0);return a[u]=f,!0},deleteProperty(e,u){if(!u)return!1;let f=y(!0);return delete f[u],!0},ownKeys(){let e=y(!0);return Object.keys(e)}});function v(e){return e?e!=="false":!1}var T=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var F=T==="test"||v(w.TEST);var h=e=>{let u=e.plugins?.reduce((r,d)=>{let l=d.schema;if(!l)return r;for(let[s,p]of Object.entries(l))r[s]={fields:{...r[s]?.fields,...p.fields},modelName:p.modelName||s};return r},{}),f=e.rateLimit?.storage==="database",a={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:i,session:c,account:t,...o}=u||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...i?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...c?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...t?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...o,...f?a:{}}};import{z as de}from"zod";import{Kysely as fe,MssqlDialect as pe}from"kysely";import{MysqlDialect as me,PostgresDialect as ge,SqliteDialect as he}from"kysely";import{createConsola as k}from"consola";var A=["info","success","warn","error","debug"];function I(e,u){return A.indexOf(u)<=A.indexOf(e)}var N=k({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),x=e=>{let u=e?.disabled!==!0,f=e?.level??"error",a=(i,c,t=[])=>{if(!(!u||!I(f,i))){if(!e||typeof e.log!="function"){N[i]("",c,...t);return}e.log(i==="success"?"info":i,c,t)}};return Object.fromEntries(A.map(i=>[i,(...[c,...t])=>a(i,c,t)]))},Ve=x();var q=e=>{let u=h(e);function f(a,i){return i==="id"?i:u[a].fields[i].fieldName||i}return{transformInput(a,i){let c=a.id?{id:a.id}:{};for(let t in a){let o=u[i].fields[t];o&&(c[o.fieldName||t]=a[t])}return c},transformOutput(a,i,c=[]){if(!a)return null;let t=a.id||a._id?c.length===0||c.includes("id")?{id:a.id}:{}:{},o=u[i].fields;for(let r in o){if(c.length&&!c.includes(r))continue;let d=o[r];d&&(t[r]=a[d.fieldName||r])}return t},convertWhereClause(a,i,c){return i.filter(t=>a.every(o=>{let{field:r,value:d,operator:l}=o,s=f(c,r);if(l==="in"){if(!Array.isArray(d))throw new Error("Value must be an array");return d.includes(t[s])}else return l==="contains"?t[s].includes(d):l==="starts_with"?t[s].startsWith(d):l==="ends_with"?t[s].endsWith(d):t[s]===d}))},getField:f}},Ye=e=>u=>{let{transformInput:f,transformOutput:a,convertWhereClause:i,getField:c}=q(u);return{id:"memory",create:async({model:t,data:o})=>{let r=f(o,t);return e[t].push(r),a(r,t)},findOne:async({model:t,where:o,select:r})=>{let d=e[t],s=i(o,d,t)[0]||null;return a(s,t,r)},findMany:async({model:t,where:o,sortBy:r,limit:d,offset:l})=>{let s=e[t];return o&&(s=i(o,s,t)),r&&(s=s.sort((p,b)=>{let m=c(t,r.field);return r.direction==="asc"?p[m]>b[m]?1:-1:p[m]<b[m]?1:-1})),l!==void 0&&(s=s.slice(l)),d!==void 0&&(s=s.slice(0,d)),s.map(p=>a(p,t))},update:async({model:t,where:o,update:r})=>{let d=e[t],l=i(o,d,t);return l.forEach(s=>{Object.assign(s,f(r,t))}),a(l[0],t)},delete:async({model:t,where:o})=>{let r=e[t],d=i(o,r,t);e[t]=r.filter(l=>!d.includes(l))},deleteMany:async({model:t,where:o})=>{let r=e[t],d=i(o,r,t),l=0;return e[t]=r.filter(s=>d.includes(s)?(l++,!1):!d.includes(s)),l},updateMany(t){let{model:o,where:r,update:d}=t,l=e[o],s=i(r,l,o);return s.forEach(p=>{Object.assign(p,d)}),s[0]||null}}};export{Ye as memoryAdapter};
