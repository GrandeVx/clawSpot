import{z as s}from"zod";var V=s.object({id:s.string(),providerId:s.string(),accountId:s.string(),userId:s.string(),accessToken:s.string().nullish(),refreshToken:s.string().nullish(),idToken:s.string().nullish(),expiresAt:s.date().nullish(),password:s.string().nullish()}),L=s.object({id:s.string(),email:s.string().transform(e=>e.toLowerCase()),emailVerified:s.boolean().default(!1),name:s.string(),image:s.string().nullish(),createdAt:s.date().default(new Date),updatedAt:s.date().default(new Date)}),C=s.object({id:s.string(),userId:s.string(),expiresAt:s.date(),ipAddress:s.string().nullish(),userAgent:s.string().nullish()}),U=s.object({id:s.string(),value:s.string(),createdAt:s.date(),expiresAt:s.date(),identifier:s.string()});import{nanoid as E}from"nanoid";var b=Object.create(null),A=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?b:globalThis),F=new Proxy(b,{get(e,d){return A()[d]??b[d]},has(e,d){let u=A();return d in u||d in b},set(e,d,u){let l=A(!0);return l[d]=u,!0},deleteProperty(e,d){if(!d)return!1;let u=A(!0);return delete u[d],!0},ownKeys(){let e=A(!0);return Object.keys(e)}});function O(e){return e?e!=="false":!1}var I=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var k=I==="test"||O(F.TEST);var w=e=>{let d=e.plugins?.reduce((n,f)=>{let a=f.schema;if(!a)return n;for(let[t,o]of Object.entries(a))n[t]={fields:{...n[t]?.fields,...o.fields},modelName:o.modelName||t};return n},{}),u=e.rateLimit?.storage==="database",l={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:c,session:m,account:p,...i}=d||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...c?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...m?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...p?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...i,...u?l:{}}};import{z as fe}from"zod";import{Kysely as ge,MssqlDialect as he}from"kysely";import{MysqlDialect as be,PostgresDialect as we,SqliteDialect as xe}from"kysely";import{createConsola as q}from"consola";var x=["info","success","warn","error","debug"];function S(e,d){return x.indexOf(d)<=x.indexOf(e)}var D=q({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),v=e=>{let d=e?.disabled!==!0,u=e?.level??"error",l=(c,m,p=[])=>{if(!(!d||!S(u,c))){if(!e||typeof e.log!="function"){D[c]("",m,...p);return}e.log(c==="success"?"info":c,m,p)}};return Object.fromEntries(x.map(c=>[c,(...[m,...p])=>l(c,m,p)]))},Ce=v();var R=(e,d)=>{let u=w(d);function l(i,n){return n==="id"?n:u[i].fields[n].fieldName||n}function c(i){switch(i){case"starts_with":return"startsWith";case"ends_with":return"endsWith";default:return i}}function m(i){return u[i].modelName}let p=e?.generateId!==!1;return{transformInput(i,n){let f=i.id&&p?{id:e?.generateId?e.generateId():i.id}:{};for(let a in i){let t=u[n].fields[a];t&&(f[t.fieldName||a]=i[a])}return f},transformOutput(i,n,f=[]){if(!i)return null;let a=i.id||i._id?f.length===0||f.includes("id")?{id:i.id}:{}:{},t=u[n].fields;for(let o in t){if(f.length&&!f.includes(o))continue;let r=t[o];r&&(a[o]=i[r.fieldName||o])}return a},convertWhereClause(i,n){if(!n)return{};if(n.length===1){let r=n[0];return r?{[l(i,r.field)]:r.operator==="eq"||!r.operator?r.value:{[c(r.operator)]:r.value}}:void 0}let f=n.filter(r=>r.connector==="AND"||!r.connector),a=n.filter(r=>r.connector==="OR"),t=f.map(r=>({[l(i,r.field)]:r.operator==="eq"||!r.operator?r.value:{[c(r.operator)]:r.value}})),o=a.map(r=>({[l(i,r.field)]:{[r.operator||"eq"]:r.value}}));return{AND:t.length?t:void 0,OR:o.length?o:void 0}},convertSelect:(i,n)=>{if(!(!i||!n))return i.reduce((f,a)=>({...f,[l(n,a)]:!0}),{})},getModelName:m,getField:l}},nt=(e,d)=>u=>{let l=e,{transformInput:c,transformOutput:m,convertWhereClause:p,convertSelect:i,getModelName:n,getField:f}=R(d,u);return{id:"prisma",async create(a){let{model:t,data:o,select:r}=a,y=c(o,t),g=await l[n(t)].create({data:y,select:i(r,t)});return m(g,t,r)},async findOne(a){let{model:t,where:o,select:r}=a,y=p(t,o),g=await l[n(t)].findFirst({where:y,select:i(r,t)});return m(g,t,r)},async findMany(a){let{model:t,where:o,limit:r,offset:y,sortBy:g}=a,h=p(t,o);return(await l[n(t)].findMany({where:h,take:r||100,skip:y||0,orderBy:g?.field?{[f(t,g.field)]:g.direction==="desc"?"desc":"asc"}:void 0})).map(T=>m(T,t))},async update(a){let{model:t,where:o,update:r}=a,y=p(t,o),g=c(r,t),h=await l[n(t)].update({where:y,data:g});return m(h,t)},async updateMany(a){let{model:t,where:o,update:r}=a,y=p(t,o),g=c(r,t),h=await l[n(t)].updateMany({where:y,data:g});return h?h.count:0},async delete(a){let{model:t,where:o}=a,r=p(t,o);try{await l[n(t)].delete({where:r})}catch{}},async deleteMany(a){let{model:t,where:o}=a,r=p(t,o),y=await l[n(t)].deleteMany({where:r});return y?y.count:0},options:d}};export{nt as prismaAdapter};
