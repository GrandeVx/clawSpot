"use strict";var x=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var R=(e,o)=>{for(var i in o)x(e,i,{get:o[i],enumerable:!0})},B=(e,o,i,l)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of S(o))!q.call(e,r)&&r!==i&&x(e,r,{get:()=>o[r],enumerable:!(l=D(o,r))||l.enumerable});return e};var M=e=>B(x({},"__esModule",{value:!0}),e);var H={};R(H,{mongodbAdapter:()=>_});module.exports=M(H);var h=require("mongodb");var d=require("zod"),Z=d.z.object({id:d.z.string(),providerId:d.z.string(),accountId:d.z.string(),userId:d.z.string(),accessToken:d.z.string().nullish(),refreshToken:d.z.string().nullish(),idToken:d.z.string().nullish(),expiresAt:d.z.date().nullish(),password:d.z.string().nullish()}),G=d.z.object({id:d.z.string(),email:d.z.string().transform(e=>e.toLowerCase()),emailVerified:d.z.boolean().default(!1),name:d.z.string(),image:d.z.string().nullish(),createdAt:d.z.date().default(new Date),updatedAt:d.z.date().default(new Date)}),Q=d.z.object({id:d.z.string(),userId:d.z.string(),expiresAt:d.z.date(),ipAddress:d.z.string().nullish(),userAgent:d.z.string().nullish()}),X=d.z.object({id:d.z.string(),value:d.z.string(),createdAt:d.z.date(),expiresAt:d.z.date(),identifier:d.z.string()});var V=require("nanoid");var b=Object.create(null),A=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?b:globalThis),L=new Proxy(b,{get(e,o){return A()[o]??b[o]},has(e,o){let i=A();return o in i||o in b},set(e,o,i){let l=A(!0);return l[o]=i,!0},deleteProperty(e,o){if(!o)return!1;let i=A(!0);return delete i[o],!0},ownKeys(){let e=A(!0);return Object.keys(e)}});function P(e){return e?e!=="false":!1}var U=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var C=U==="test"||P(L.TEST);var w=e=>{let o=e.plugins?.reduce((s,c)=>{let u=c.schema;if(!u)return s;for(let[f,g]of Object.entries(u))s[f]={fields:{...s[f]?.fields,...g.fields},modelName:g.modelName||f};return s},{}),i=e.rateLimit?.storage==="database",l={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:r,session:n,account:t,...a}=o||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...r?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...n?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...t?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...a,...i?l:{}}};var $=require("zod");var O=require("kysely"),T=require("kysely");var k=require("consola"),v=["info","success","warn","error","debug"];function E(e,o){return v.indexOf(o)<=v.indexOf(e)}var K=(0,k.createConsola)({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),I=e=>{let o=e?.disabled!==!0,i=e?.level??"error",l=(r,n,t=[])=>{if(!(!o||!E(i,r))){if(!e||typeof e.log!="function"){K[r]("",n,...t);return}e.log(r==="success"?"info":r,n,t)}};return Object.fromEntries(v.map(r=>[r,(...[n,...t])=>l(r,n,t)]))},Ce=I();var W=e=>{let o=w(e);function i(n,t,a){if(n==="id"||n==="_id"||o[a].fields[n].references?.field==="id"){if(typeof t!="string"){if(t instanceof h.ObjectId)return t;if(Array.isArray(t))return t.map(s=>{if(typeof s=="string")try{return new h.ObjectId(s)}catch{return s}if(s instanceof h.ObjectId)return s;throw new Error("Invalid id value")});throw new Error("Invalid id value")}try{return new h.ObjectId(t)}catch{return t}}return t}function l(n,t,a){return n==="id"||o[a].fields[n].references?.field==="id"?t instanceof h.ObjectId?t.toHexString():Array.isArray(t)?t.map(s=>s instanceof h.ObjectId?s.toHexString():s):t:t}function r(n,t){return n==="id"?"_id":o[t].fields[n].fieldName||n}return{transformInput(n,t){let a={};for(let s in n){let c=o[t].fields[s];c&&(a[c.fieldName||s]=i(s,n[s],t))}return a},transformOutput(n,t,a=[]){let s=n.id||n._id?a.length===0||a.includes("id")?{id:n.id?n.id.toString():n._id.toString()}:{}:{},c=o[t].fields;for(let u in c){if(a.length&&!a.includes(u))continue;let f=c[u];f&&(s[u]=l(u,n[f.fieldName||u],t))}return s},convertWhereClause(n,t){if(!n.length)return{};let a=n.map(f=>{let{field:g,value:p,operator:F="eq",connector:N="AND"}=f,m,y=r(g,t);switch(F.toLowerCase()){case"eq":m={[y]:i(g,p,t)};break;case"in":m={[y]:{$in:Array.isArray(p)?i(g,p,t):[i(g,p,t)]}};break;case"gt":m={[y]:{$gt:p}};break;case"gte":m={[y]:{$gte:p}};break;case"lt":m={[y]:{$lt:p}};break;case"lte":m={[y]:{$lte:p}};break;case"ne":m={[y]:{$ne:p}};break;case"contains":m={[y]:{$regex:`.*${p}.*`}};break;case"starts_with":m={[y]:{$regex:`${p}.*`}};break;case"ends_with":m={[y]:{$regex:`.*${p}`}};break;default:throw new Error(`Unsupported operator: ${F}`)}return{condition:m,connector:N}});if(a.length===1)return a[0].condition;let s=a.filter(f=>f.connector==="AND").map(f=>f.condition),c=a.filter(f=>f.connector==="OR").map(f=>f.condition),u={};return s.length&&(u={...u,$and:s}),c.length&&(u={...u,$or:c}),u},getModelName:n=>o[n].modelName,getField:r}},_=e=>o=>{let i=W(o);return{id:"mongodb-adapter",async create(l){let{model:r,data:n,select:t}=l,a=i.transformInput(n,r);a.id&&delete a.id;let c=(await e.collection(i.getModelName(r)).insertOne(a)).insertedId,u={...a,id:c.toString()};return i.transformOutput(u,r,t)},async findOne(l){let{model:r,where:n,select:t}=l,a=i.convertWhereClause(n,r),s=await e.collection(i.getModelName(r)).findOne(a);return s?i.transformOutput(s,r,t):null},async findMany(l){let{model:r,where:n,limit:t,offset:a,sortBy:s}=l,c=n?i.convertWhereClause(n,r):{},u=e.collection(i.getModelName(r)).find(c);return t&&u.limit(t),a&&u.skip(a),s&&u.sort(i.getField(s.field,r),s.direction==="desc"?-1:1),(await u.toArray()).map(g=>i.transformOutput(g,r))},async update(l){let{model:r,where:n,update:t}=l,a=i.convertWhereClause(n,r),s=i.transformInput(t,r),c=await e.collection(i.getModelName(r)).findOneAndUpdate(a,{$set:s},{returnDocument:"after"});return c?i.transformOutput(c,r):null},async updateMany(l){let{model:r,where:n,update:t}=l,a=i.convertWhereClause(n,r),s=i.transformInput(t,r);return(await e.collection(i.getModelName(r)).updateMany(a,{$set:s})).modifiedCount},async delete(l){let{model:r,where:n}=l,t=i.convertWhereClause(n,r),a=await e.collection(i.getModelName(r)).findOneAndDelete(t);return a?i.transformOutput(a,r):null},async deleteMany(l){let{model:r,where:n}=l,t=i.convertWhereClause(n,r);return(await e.collection(i.getModelName(r)).deleteMany(t)).deletedCount}}};0&&(module.exports={mongodbAdapter});
