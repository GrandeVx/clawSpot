import{ObjectId as h}from"mongodb";import{z as o}from"zod";var L=o.object({id:o.string(),providerId:o.string(),accountId:o.string(),userId:o.string(),accessToken:o.string().nullish(),refreshToken:o.string().nullish(),idToken:o.string().nullish(),expiresAt:o.date().nullish(),password:o.string().nullish()}),P=o.object({id:o.string(),email:o.string().transform(e=>e.toLowerCase()),emailVerified:o.boolean().default(!1),name:o.string(),image:o.string().nullish(),createdAt:o.date().default(new Date),updatedAt:o.date().default(new Date)}),U=o.object({id:o.string(),userId:o.string(),expiresAt:o.date(),ipAddress:o.string().nullish(),userAgent:o.string().nullish()}),C=o.object({id:o.string(),value:o.string(),createdAt:o.date(),expiresAt:o.date(),identifier:o.string()});import{nanoid as E}from"nanoid";var b=Object.create(null),A=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?b:globalThis),O=new Proxy(b,{get(e,d){return A()[d]??b[d]},has(e,d){let i=A();return d in i||d in b},set(e,d,i){let l=A(!0);return l[d]=i,!0},deleteProperty(e,d){if(!d)return!1;let i=A(!0);return delete i[d],!0},ownKeys(){let e=A(!0);return Object.keys(e)}});function k(e){return e?e!=="false":!1}var I=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var N=I==="test"||k(O.TEST);var w=e=>{let d=e.plugins?.reduce((s,c)=>{let u=c.schema;if(!u)return s;for(let[f,g]of Object.entries(u))s[f]={fields:{...s[f]?.fields,...g.fields},modelName:g.modelName||f};return s},{}),i=e.rateLimit?.storage==="database",l={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:n,session:r,account:t,...a}=d||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...n?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...r?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...t?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...a,...i?l:{}}};import{z as fe}from"zod";import{Kysely as ge,MssqlDialect as he}from"kysely";import{MysqlDialect as be,PostgresDialect as we,SqliteDialect as xe}from"kysely";import{createConsola as S}from"consola";var x=["info","success","warn","error","debug"];function q(e,d){return x.indexOf(d)<=x.indexOf(e)}var R=S({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),v=e=>{let d=e?.disabled!==!0,i=e?.level??"error",l=(n,r,t=[])=>{if(!(!d||!q(i,n))){if(!e||typeof e.log!="function"){R[n]("",r,...t);return}e.log(n==="success"?"info":n,r,t)}};return Object.fromEntries(x.map(n=>[n,(...[r,...t])=>l(n,r,t)]))},Ue=v();var B=e=>{let d=w(e);function i(r,t,a){if(r==="id"||r==="_id"||d[a].fields[r].references?.field==="id"){if(typeof t!="string"){if(t instanceof h)return t;if(Array.isArray(t))return t.map(s=>{if(typeof s=="string")try{return new h(s)}catch{return s}if(s instanceof h)return s;throw new Error("Invalid id value")});throw new Error("Invalid id value")}try{return new h(t)}catch{return t}}return t}function l(r,t,a){return r==="id"||d[a].fields[r].references?.field==="id"?t instanceof h?t.toHexString():Array.isArray(t)?t.map(s=>s instanceof h?s.toHexString():s):t:t}function n(r,t){return r==="id"?"_id":d[t].fields[r].fieldName||r}return{transformInput(r,t){let a={};for(let s in r){let c=d[t].fields[s];c&&(a[c.fieldName||s]=i(s,r[s],t))}return a},transformOutput(r,t,a=[]){let s=r.id||r._id?a.length===0||a.includes("id")?{id:r.id?r.id.toString():r._id.toString()}:{}:{},c=d[t].fields;for(let u in c){if(a.length&&!a.includes(u))continue;let f=c[u];f&&(s[u]=l(u,r[f.fieldName||u],t))}return s},convertWhereClause(r,t){if(!r.length)return{};let a=r.map(f=>{let{field:g,value:p,operator:T="eq",connector:F="AND"}=f,m,y=n(g,t);switch(T.toLowerCase()){case"eq":m={[y]:i(g,p,t)};break;case"in":m={[y]:{$in:Array.isArray(p)?i(g,p,t):[i(g,p,t)]}};break;case"gt":m={[y]:{$gt:p}};break;case"gte":m={[y]:{$gte:p}};break;case"lt":m={[y]:{$lt:p}};break;case"lte":m={[y]:{$lte:p}};break;case"ne":m={[y]:{$ne:p}};break;case"contains":m={[y]:{$regex:`.*${p}.*`}};break;case"starts_with":m={[y]:{$regex:`${p}.*`}};break;case"ends_with":m={[y]:{$regex:`.*${p}`}};break;default:throw new Error(`Unsupported operator: ${T}`)}return{condition:m,connector:F}});if(a.length===1)return a[0].condition;let s=a.filter(f=>f.connector==="AND").map(f=>f.condition),c=a.filter(f=>f.connector==="OR").map(f=>f.condition),u={};return s.length&&(u={...u,$and:s}),c.length&&(u={...u,$or:c}),u},getModelName:r=>d[r].modelName,getField:n}},it=e=>d=>{let i=B(d);return{id:"mongodb-adapter",async create(l){let{model:n,data:r,select:t}=l,a=i.transformInput(r,n);a.id&&delete a.id;let c=(await e.collection(i.getModelName(n)).insertOne(a)).insertedId,u={...a,id:c.toString()};return i.transformOutput(u,n,t)},async findOne(l){let{model:n,where:r,select:t}=l,a=i.convertWhereClause(r,n),s=await e.collection(i.getModelName(n)).findOne(a);return s?i.transformOutput(s,n,t):null},async findMany(l){let{model:n,where:r,limit:t,offset:a,sortBy:s}=l,c=r?i.convertWhereClause(r,n):{},u=e.collection(i.getModelName(n)).find(c);return t&&u.limit(t),a&&u.skip(a),s&&u.sort(i.getField(s.field,n),s.direction==="desc"?-1:1),(await u.toArray()).map(g=>i.transformOutput(g,n))},async update(l){let{model:n,where:r,update:t}=l,a=i.convertWhereClause(r,n),s=i.transformInput(t,n),c=await e.collection(i.getModelName(n)).findOneAndUpdate(a,{$set:s},{returnDocument:"after"});return c?i.transformOutput(c,n):null},async updateMany(l){let{model:n,where:r,update:t}=l,a=i.convertWhereClause(r,n),s=i.transformInput(t,n);return(await e.collection(i.getModelName(n)).updateMany(a,{$set:s})).modifiedCount},async delete(l){let{model:n,where:r}=l,t=i.convertWhereClause(r,n),a=await e.collection(i.getModelName(n)).findOneAndDelete(t);return a?i.transformOutput(a,n):null},async deleteMany(l){let{model:n,where:r}=l,t=i.convertWhereClause(r,n);return(await e.collection(i.getModelName(n)).deleteMany(t)).deletedCount}}};export{it as mongodbAdapter};
