import{Kysely as k,MssqlDialect as B}from"kysely";import{MysqlDialect as I,PostgresDialect as N,SqliteDialect as q}from"kysely";function S(e){if("dialect"in e)return S(e.dialect);if("createDriver"in e){if(e instanceof q)return"sqlite";if(e instanceof I)return"mysql";if(e instanceof N)return"postgres";if(e instanceof B)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":null}var D=async e=>{let o=e.database;if("db"in o)return{kysely:o.db,databaseType:o.type};if("dialect"in o)return{kysely:new k({dialect:o.dialect}),databaseType:o.type};let f,m=S(o);return"createDriver"in o&&(f=o),"aggregate"in o&&(f=new q({database:o})),"getConnection"in o&&(f=new I(o)),"connect"in o&&(f=new N({pool:o})),{kysely:f?new k({dialect:f}):null,databaseType:m}};import{z as u}from"zod";var z=u.object({id:u.string(),providerId:u.string(),accountId:u.string(),userId:u.string(),accessToken:u.string().nullish(),refreshToken:u.string().nullish(),idToken:u.string().nullish(),expiresAt:u.date().nullish(),password:u.string().nullish()}),Z=u.object({id:u.string(),email:u.string().transform(e=>e.toLowerCase()),emailVerified:u.boolean().default(!1),name:u.string(),image:u.string().nullish(),createdAt:u.date().default(new Date),updatedAt:u.date().default(new Date)}),G=u.object({id:u.string(),userId:u.string(),expiresAt:u.date(),ipAddress:u.string().nullish(),userAgent:u.string().nullish()}),Q=u.object({id:u.string(),value:u.string(),createdAt:u.date(),expiresAt:u.date(),identifier:u.string()});import{nanoid as ee}from"nanoid";var T=Object.create(null),w=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?T:globalThis),V=new Proxy(T,{get(e,o){return w()[o]??T[o]},has(e,o){let f=w();return o in f||o in T},set(e,o,f){let m=w(!0);return m[o]=f,!0},deleteProperty(e,o){if(!o)return!1;let f=w(!0);return delete f[o],!0},ownKeys(){let e=w(!0);return Object.keys(e)}});function L(e){return e?e!=="false":!1}var P=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var M=P==="test"||L(V.TEST);var F=e=>{let o=e.plugins?.reduce((x,n)=>{let t=n.schema;if(!t)return x;for(let[i,d]of Object.entries(t))x[i]={fields:{...x[i]?.fields,...d.fields},modelName:d.modelName||i};return x},{}),f=e.rateLimit?.storage==="database",m={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:g,session:A,account:h,...b}=o||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...g?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...A?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...h?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...b,...f?m:{}}};import{z as Fe}from"zod";import{createConsola as j}from"consola";var O=["info","success","warn","error","debug"];function K(e,o){return O.indexOf(o)<=O.indexOf(e)}var E=j({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),R=e=>{let o=e?.disabled!==!0,f=e?.level??"error",m=(g,A,h=[])=>{if(!(!o||!K(f,g))){if(!e||typeof e.log!="function"){E[g]("",A,...h);return}e.log(g==="success"?"info":g,A,h)}};return Object.fromEntries(O.map(g=>[g,(...[A,...h])=>m(g,A,h)]))},Le=R();var C=(e,o,f)=>{let m=F(o);function g(n,t){if(t==="id")return t;let i=m[n].fields[t];return i||console.log("Field not found",n,t),i.fieldName||t}function A(n,t,i){let{type:d="sqlite"}=f||{},a=m[t].fields[i];return a.type==="boolean"&&d==="sqlite"?n?1:0:a.type==="date"&&n&&n instanceof Date&&d==="sqlite"?n.toISOString():n}function h(n,t,i){let{type:d="sqlite"}=f||{},a=m[t].fields[i];return a.type==="boolean"&&d==="sqlite"&&n!==null?n===1:a.type==="date"&&n?new Date(n):n}function b(n){return m[n].modelName}let x=f?.generateId!==!1;return{transformInput(n,t){let i=n.id&&x?{id:f?.generateId?f.generateId():n.id}:{};for(let d in n){let a=m[t].fields[d];a&&(i[a.fieldName||d]=A(n[d],t,d))}return i},transformOutput(n,t,i=[]){if(!n)return null;let d=n.id?i.length===0||i.includes("id")?{id:n.id}:{}:{},a=m[t].fields;for(let r in a){if(i.length&&!i.includes(r))continue;let s=a[r];s&&(d[r]=h(n[s.fieldName||r],t,r))}return d},convertWhereClause(n,t){if(!t)return{and:null,or:null};let i={and:[],or:[]};return t.forEach(d=>{let{field:a,value:r,operator:s="=",connector:c="AND"}=d,l=g(n,a),y=p=>s.toLowerCase()==="in"?p(l,"in",Array.isArray(r)?r:[r]):s==="contains"?p(l,"like",`%${r}%`):s==="starts_with"?p(l,"like",`${r}%`):s==="ends_with"?p(l,"like",`%${r}`):s==="eq"?p(l,"=",r):s==="ne"?p(l,"<>",r):s==="gt"?p(l,">",r):s==="gte"?p(l,">=",r):s==="lt"?p(l,"<",r):s==="lte"?p(l,"<=",r):p(l,s,r);c==="OR"?i.or.push(y):i.and.push(y)}),{and:i.and.length?i.and:null,or:i.or.length?i.or:null}},async withReturning(n,t,i,d){let a;if(f?.type!=="mysql")a=await t.returningAll().executeTakeFirst();else{await t.execute();let r=n.id?"id":d[0].field?d[0].field:"id",s=n[r]||d[0].value;a=await e.selectFrom(b(i)).selectAll().where(g(i,r),"=",s).executeTakeFirst()}return a},getModelName:b,getField:g}},U=(e,o)=>f=>{let{transformInput:m,withReturning:g,transformOutput:A,convertWhereClause:h,getModelName:b,getField:x}=C(e,f,o);return{id:"kysely",async create(n){let{model:t,data:i,select:d}=n,a=m(i,t),r=e.insertInto(b(t)).values(a);return A(await g(a,r,t,[]),t,d)},async findOne(n){let{model:t,where:i,select:d}=n,{and:a,or:r}=h(t,i),s=e.selectFrom(b(t)).selectAll();a&&(s=s.where(l=>l.and(a.map(y=>y(l))))),r&&(s=s.where(l=>l.or(r.map(y=>y(l)))));let c=await s.executeTakeFirst();return c?A(c,t,d):null},async findMany(n){let{model:t,where:i,limit:d,offset:a,sortBy:r}=n,{and:s,or:c}=h(t,i),l=e.selectFrom(b(t));s&&(l=l.where(p=>p.and(s.map(v=>v(p))))),c&&(l=l.where(p=>p.or(c.map(v=>v(p))))),l=l.limit(d||100),a&&(l=l.offset(a)),r&&(l=l.orderBy(x(t,r.field),r.direction));let y=await l.selectAll().execute();return y?y.map(p=>A(p,t)):[]},async update(n){let{model:t,where:i,update:d}=n,{and:a,or:r}=h(t,i),s=m(d,t),c=e.updateTable(b(t)).set(s);return a&&(c=c.where(l=>l.and(a.map(y=>y(l))))),r&&(c=c.where(l=>l.or(r.map(y=>y(l))))),A(await g(s,c,t,i),t)},async updateMany(n){let{model:t,where:i,update:d}=n,{and:a,or:r}=h(t,i),s=m(d,t),c=e.updateTable(b(t)).set(s);return a&&(c=c.where(y=>y.and(a.map(p=>p(y))))),r&&(c=c.where(y=>y.or(r.map(p=>p(y))))),(await c.execute()).length},async delete(n){let{model:t,where:i}=n,{and:d,or:a}=h(t,i),r=e.deleteFrom(b(t));d&&(r=r.where(s=>s.and(d.map(c=>c(s))))),a&&(r=r.where(s=>s.or(a.map(c=>c(s))))),await r.execute()},async deleteMany(n){let{model:t,where:i}=n,{and:d,or:a}=h(t,i),r=e.deleteFrom(b(t));return d&&(r=r.where(s=>s.and(d.map(c=>c(s))))),a&&(r=r.where(s=>s.or(a.map(c=>c(s))))),(await r.execute()).length},options:o}};export{D as createKyselyAdapter,U as kyselyAdapter};
