"use strict";var h=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var P=(e,t)=>{for(var r in t)h(e,r,{get:t[r],enumerable:!0})},A=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of E(t))!k.call(e,i)&&i!==r&&h(e,i,{get:()=>t[i],enumerable:!(n=v(t,i))||n.enumerable});return e};var O=e=>A(h({},"__esModule",{value:!0}),e);var D={};P(D,{createAuthorizationURL:()=>S,generateCodeChallenge:()=>_,generateState:()=>I,getOAuth2Tokens:()=>U,parseState:()=>j,validateAuthorizationCode:()=>C});module.exports=O(D);var y=require("oslo/crypto"),b=require("oslo/encoding");var x=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));async function _(e){let t=await(0,y.sha256)(new TextEncoder().encode(e));return b.base64url.encode(new Uint8Array(t),{includePadding:!1})}function U(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?x(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function S({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:i,scopes:l,claims:o,redirectURI:c}){let s=new URL(r);if(s.searchParams.set("response_type","code"),s.searchParams.set("client_id",t.clientId),s.searchParams.set("state",n),s.searchParams.set("scope",l.join(" ")),s.searchParams.set("redirect_uri",t.redirectURI||c),i){let d=await _(i);s.searchParams.set("code_challenge_method","S256"),s.searchParams.set("code_challenge",d)}if(o){let d=o.reduce((g,m)=>(g[m]=null,g),{});s.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...d}}))}return s}var w=require("@better-fetch/fetch");async function C({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:i,authentication:l}){let o=new URLSearchParams,c={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(o.set("grant_type","authorization_code"),o.set("code",e),t&&o.set("code_verifier",t),o.set("redirect_uri",r),l==="basic"){let m=btoa(`${n.clientId}:${n.clientSecret}`);c.authorization=`Basic ${m}`}else o.set("client_id",n.clientId),o.set("client_secret",n.clientSecret);let{data:s,error:d}=await(0,w.betterFetch)(i,{method:"POST",body:o,headers:c});if(d)throw d;return U(s)}var f=require("oslo/oauth2"),a=require("zod"),R=require("better-call");var u=Object.create(null),p=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?u:globalThis),L=new Proxy(u,{get(e,t){return p()[t]??u[t]},has(e,t){let r=p();return t in r||t in u},set(e,t,r){let n=p(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=p(!0);return delete r[t],!0},ownKeys(){let e=p(!0);return Object.keys(e)}});function V(e){return e?e!=="false":!1}var B=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var X=B==="test"||V(L.TEST);function T(e){try{return new URL(e).origin}catch{return null}}async function I(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?T(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new R.APIError("BAD_REQUEST",{message:"callbackURL is required"});let n=(0,f.generateCodeVerifier)(),i=(0,f.generateState)(),l=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,link:t,expiresAt:Date.now()+10*60*1e3}),o=new Date;o.setMinutes(o.getMinutes()+10);let c=await e.context.internalAdapter.createVerificationValue({value:l,identifier:i,expiresAt:o});if(!c)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new R.APIError("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:c.identifier,codeVerifier:n}}async function j(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let n=a.z.object({callbackURL:a.z.string(),codeVerifier:a.z.string(),errorURL:a.z.string().optional(),expiresAt:a.z.number(),link:a.z.object({email:a.z.string(),userId:a.z.string()}).optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),n}0&&(module.exports={createAuthorizationURL,generateCodeChallenge,generateState,getOAuth2Tokens,parseState,validateAuthorizationCode});
