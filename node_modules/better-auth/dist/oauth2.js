import{sha256 as y}from"oslo/crypto";import{base64url as b}from"oslo/encoding";var m=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));async function h(e){let t=await y(new TextEncoder().encode(e));return b.encode(new Uint8Array(t),{includePadding:!1})}function _(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?m(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function V({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:c,scopes:l,claims:o,redirectURI:a}){let i=new URL(r);if(i.searchParams.set("response_type","code"),i.searchParams.set("client_id",t.clientId),i.searchParams.set("state",n),i.searchParams.set("scope",l.join(" ")),i.searchParams.set("redirect_uri",t.redirectURI||a),c){let d=await h(c);i.searchParams.set("code_challenge_method","S256"),i.searchParams.set("code_challenge",d)}if(o){let d=o.reduce((f,g)=>(f[g]=null,f),{});i.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...d}}))}return i}import{betterFetch as w}from"@better-fetch/fetch";async function D({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:c,authentication:l}){let o=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(o.set("grant_type","authorization_code"),o.set("code",e),t&&o.set("code_verifier",t),o.set("redirect_uri",r),l==="basic"){let g=btoa(`${n.clientId}:${n.clientSecret}`);a.authorization=`Basic ${g}`}else o.set("client_id",n.clientId),o.set("client_secret",n.clientSecret);let{data:i,error:d}=await w(c,{method:"POST",body:o,headers:a});if(d)throw d;return _(i)}import{generateCodeVerifier as v,generateState as E}from"oslo/oauth2";import{z as s}from"zod";import{APIError as x}from"better-call";var u=Object.create(null),p=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?u:globalThis),U=new Proxy(u,{get(e,t){return p()[t]??u[t]},has(e,t){let r=p();return t in r||t in u},set(e,t,r){let n=p(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=p(!0);return delete r[t],!0},ownKeys(){let e=p(!0);return Object.keys(e)}});function L(e){return e?e!=="false":!1}var T=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var N=T==="test"||L(U.TEST);function R(e){try{return new URL(e).origin}catch{return null}}async function W(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?R(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new x("BAD_REQUEST",{message:"callbackURL is required"});let n=v(),c=E(),l=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,link:t,expiresAt:Date.now()+10*60*1e3}),o=new Date;o.setMinutes(o.getMinutes()+10);let a=await e.context.internalAdapter.createVerificationValue({value:l,identifier:c,expiresAt:o});if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new x("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:n}}async function Y(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let n=s.object({callbackURL:s.string(),codeVerifier:s.string(),errorURL:s.string().optional(),expiresAt:s.number(),link:s.object({email:s.string(),userId:s.string()}).optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),n}export{V as createAuthorizationURL,h as generateCodeChallenge,W as generateState,_ as getOAuth2Tokens,Y as parseState,D as validateAuthorizationCode};
