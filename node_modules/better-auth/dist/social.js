import{betterFetch as N}from"@better-fetch/fetch";import{APIError as F}from"better-call";import{decodeProtectedHeader as H,importJWK as M,jwtVerify as J}from"jose";import{parseJWT as K}from"oslo/jwt";import{sha256 as V}from"oslo/crypto";import{base64url as B}from"oslo/encoding";var y=(e,i="ms")=>new Date(Date.now()+(i==="sec"?e*1e3:e));async function x(e){let i=await V(new TextEncoder().encode(e));return B.encode(new Uint8Array(i),{includePadding:!1})}function P(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?y(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function d({id:e,options:i,authorizationEndpoint:r,state:t,codeVerifier:o,scopes:n,claims:a,redirectURI:c}){let s=new URL(r);if(s.searchParams.set("response_type","code"),s.searchParams.set("client_id",i.clientId),s.searchParams.set("state",t),s.searchParams.set("scope",n.join(" ")),s.searchParams.set("redirect_uri",i.redirectURI||c),o){let p=await x(o);s.searchParams.set("code_challenge_method","S256"),s.searchParams.set("code_challenge",p)}if(a){let p=a.reduce((u,_)=>(u[_]=null,u),{});s.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...p}}))}return s}import{betterFetch as D}from"@better-fetch/fetch";async function l({code:e,codeVerifier:i,redirectURI:r,options:t,tokenEndpoint:o,authentication:n}){let a=new URLSearchParams,c={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(a.set("grant_type","authorization_code"),a.set("code",e),i&&a.set("code_verifier",i),a.set("redirect_uri",r),n==="basic"){let _=btoa(`${t.clientId}:${t.clientSecret}`);c.authorization=`Basic ${_}`}else a.set("client_id",t.clientId),a.set("client_secret",t.clientSecret);let{data:s,error:p}=await D(o,{method:"POST",body:a,headers:c});if(p)throw p;return P(s)}import{generateCodeVerifier as Te,generateState as ze}from"oslo/oauth2";import{z as Ce}from"zod";import{APIError as Se}from"better-call";var h=Object.create(null),g=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?h:globalThis),w=new Proxy(h,{get(e,i){return g()[i]??h[i]},has(e,i){let r=g();return i in r||i in h},set(e,i,r){let t=g(!0);return t[i]=r,!0},deleteProperty(e,i){if(!i)return!1;let r=g(!0);return delete r[i],!0},ownKeys(){let e=g(!0);return Object.keys(e)}});function j(e){return e?e!=="false":!1}var G=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var we=G==="test"||j(w.TEST);var m=class extends Error{constructor(i,r){super(i),this.name="BetterAuthError",this.message=i,this.cause=r,this.stack=""}};var A=e=>{let i="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:t,redirectURI:o}){let n=t||["email","name"];return e.scope&&n.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${o||e.redirectURI}&scope=${n.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:async({code:r,codeVerifier:t,redirectURI:o})=>l({code:r,codeVerifier:t,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:i}),async verifyIdToken(r,t){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,t);let o=H(r),{kid:n,alg:a}=o;if(!n||!a)return!1;let c=await W(n),{payload:s}=await J(r,c,{algorithms:[a],issuer:"https://appleid.apple.com",audience:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(p=>{s[p]!==void 0&&(s[p]=!!s[p])}),t&&s.nonce!==t?!1:!!s},async getUserInfo(r){if(!r.idToken)return null;let t=K(r.idToken)?.payload;if(!t)return null;let o=t.user?`${t.user.name.firstName} ${t.user.name.lastName}`:t.email;return{user:{id:t.sub,name:o,emailVerified:!1,email:t.email},data:t}}}},W=async e=>{let i="https://appleid.apple.com",r="/auth/keys",{data:t}=await N(`${i}${r}`);if(!t?.keys)throw new F("BAD_REQUEST",{message:"Keys not found"});let o=t.keys.find(n=>n.kid===e);if(!o)throw new Error(`JWK with kid ${e} not found`);return await M(o,o.alg)};import{betterFetch as q}from"@better-fetch/fetch";var U=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:i,scopes:r,redirectURI:t}){let o=r||["identify","email"];return e.scope&&o.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${o.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||t)}&state=${i}`)},validateAuthorizationCode:async({code:i,redirectURI:r})=>l({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(i){let{data:r,error:t}=await q("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${i.accessToken}`}});if(t)return null;if(r.avatar===null){let o=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${o}.png`}else{let o=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${o}`}return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url},data:r}}});import{betterFetch as Q}from"@better-fetch/fetch";var k=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:i,scopes:r,redirectURI:t}){let o=r||["email","public_profile"];return e.scope&&o.push(...e.scope),await d({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:o,state:i,redirectURI:t})},validateAuthorizationCode:async({code:i,redirectURI:r})=>l({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async getUserInfo(i){let{data:r,error:t}=await Q("https://graph.facebook.com/me?fields=id,name,email,picture",{auth:{type:"Bearer",token:i.accessToken}});return t?null:{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified},data:r}}});import{betterFetch as R}from"@better-fetch/fetch";var L=e=>{let i="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:t,codeVerifier:o,redirectURI:n}){let a=t||["user:email"];return e.scope&&a.push(...e.scope),d({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:a,state:r,redirectURI:n})},validateAuthorizationCode:async({code:r,redirectURI:t})=>l({code:r,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:i}),async getUserInfo(r){let{data:t,error:o}=await R("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(o)return null;let n=!1;if(!t.email){let{data:a,error:c}=await R("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});c||(t.email=(a.find(s=>s.primary)??a[0])?.email,n=a.find(s=>s.email===t.email)?.verified??!1)}return{user:{id:t.id.toString(),name:t.name||t.login,email:t.email,image:t.avatar_url,emailVerified:n},data:t}}}};import{parseJWT as re}from"oslo/jwt";import{createConsola as X}from"consola";var b=["info","success","warn","error","debug"];function Y(e,i){return b.indexOf(i)<=b.indexOf(e)}var Z=X({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),ee=e=>{let i=e?.disabled!==!0,r=e?.level??"error",t=(o,n,a=[])=>{if(!(!i||!Y(r,o))){if(!e||typeof e.log!="function"){Z[o]("",n,...a);return}e.log(o==="success"?"info":o,n,a)}};return Object.fromEntries(b.map(o=>[o,(...[n,...a])=>t(o,n,a)]))},f=ee();import{betterFetch as te}from"@better-fetch/fetch";var O=e=>({id:"google",name:"Google",async createAuthorizationURL({state:i,scopes:r,codeVerifier:t,redirectURI:o}){if(!e.clientId||!e.clientSecret)throw f.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new m("CLIENT_ID_AND_SECRET_REQUIRED");if(!t)throw new m("codeVerifier is required for Google");let n=r||["email","profile","openid"];e.scope&&n.push(...e.scope);let a=await d({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:n,state:i,codeVerifier:t,redirectURI:o});return e.accessType&&a.searchParams.set("access_type",e.accessType),e.prompt&&a.searchParams.set("prompt",e.prompt),a},validateAuthorizationCode:async({code:i,codeVerifier:r,redirectURI:t})=>l({code:i,codeVerifier:r,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),async verifyIdToken(i,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(i,r);let t=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${i}`,{data:o}=await te(t);return o?o.aud===e.clientId&&o.iss==="https://accounts.google.com":!1},async getUserInfo(i){if(!i.idToken)return null;let r=re(i.idToken)?.payload;return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified},data:r}}});import{betterFetch as ie}from"@better-fetch/fetch";import{parseJWT as oe}from"oslo/jwt";var I=e=>{let i=e.tenantId||"common",r=`https://login.microsoftonline.com/${i}/oauth2/v2.0/authorize`,t=`https://login.microsoftonline.com/${i}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(o){let n=o.scopes||["openid","profile","email","User.Read"];return e.scope&&n.push(...e.scope),d({id:"microsoft",options:e,authorizationEndpoint:r,state:o.state,codeVerifier:o.codeVerifier,scopes:n,redirectURI:o.redirectURI})},validateAuthorizationCode({code:o,codeVerifier:n,redirectURI:a}){return l({code:o,codeVerifier:n,redirectURI:e.redirectURI||a,options:e,tokenEndpoint:t})},async getUserInfo(o){if(!o.idToken)return null;let n=oe(o.idToken)?.payload,a=e.profilePhotoSize||48;return await ie(`https://graph.microsoft.com/v1.0/me/photos/${a}x${a}/$value`,{headers:{Authorization:`Bearer ${o.accessToken}`},async onResponse(c){if(!(e.disableProfilePhoto||!c.response.ok))try{let p=await c.response.clone().arrayBuffer(),u=Buffer.from(p).toString("base64");n.picture=`data:image/jpeg;base64, ${u}`}catch(s){f.error(s&&typeof s=="object"&&"name"in s?s.name:"",s)}}}),{user:{id:n.sub,name:n.name,email:n.email,image:n.picture,emailVerified:!0},data:n}}}};import{betterFetch as ne}from"@better-fetch/fetch";var T=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:i,scopes:r,codeVerifier:t,redirectURI:o}){let n=r||["user-read-email"];return e.scope&&n.push(...e.scope),d({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:n,state:i,codeVerifier:t,redirectURI:o})},validateAuthorizationCode:async({code:i,codeVerifier:r,redirectURI:t})=>l({code:i,codeVerifier:r,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(i){let{data:r,error:t}=await ne("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});return t?null:{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1},data:r}}});import{nanoid as Ur}from"nanoid";import{parseJWT as ae}from"oslo/jwt";var z=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:i,scopes:r,redirectURI:t}){let o=r||["user:read:email","openid"];return e.scope&&o.push(...e.scope),d({id:"twitch",redirectURI:t,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:o,state:i,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:i,redirectURI:r})=>l({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(i){let r=i.idToken;if(!r)return f.error("No idToken found in token"),null;let t=ae(r)?.payload;return{user:{id:t.sub,name:t.preferred_username,email:t.email,image:t.picture,emailVerified:!1},data:t}}});import{betterFetch as se}from"@better-fetch/fetch";var E=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(i){let r=i.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),d({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:i.state,codeVerifier:i.codeVerifier,redirectURI:i.redirectURI})},validateAuthorizationCode:async({code:i,codeVerifier:r,redirectURI:t})=>l({code:i,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||t,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(i){let{data:r,error:t}=await se("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});return t?null:{user:{id:r.data.id,name:r.data.name,email:r.data.email||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1},data:r}}});import{betterFetch as ce}from"@better-fetch/fetch";var C=e=>{let i="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:t,codeVerifier:o,redirectURI:n})=>{let a=t||["account_info.read"];return e.scope&&a.push(...e.scope),await d({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:a,state:r,redirectURI:n,codeVerifier:o})},validateAuthorizationCode:async({code:r,codeVerifier:t,redirectURI:o})=>await l({code:r,codeVerifier:t,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:i}),async getUserInfo(r){let{data:t,error:o}=await ce("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});return o?null:{user:{id:t.account_id,name:t.name?.display_name,email:t.email,emailVerified:t.email_verified||!1,image:t.profile_photo_url},data:t}}}};import{betterFetch as le}from"@better-fetch/fetch";var $=e=>{let i="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:t,scopes:o,redirectURI:n})=>{let a=o||["profile","email","openid"];return e.scope&&a.push(...e.scope),await d({id:"linkedin",options:e,authorizationEndpoint:i,scopes:a,state:t,redirectURI:n})},validateAuthorizationCode:async({code:t,redirectURI:o})=>await l({code:t,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:r}),async getUserInfo(t){let{data:o,error:n}=await le("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});return n?null:{user:{id:o.sub,name:o.name,email:o.email,emailVerified:o.email_verified||!1,image:o.picture},data:o}}}};import{betterFetch as de}from"@better-fetch/fetch";var v=(e="")=>e.split("://").map(i=>i.replace(/\/{2,}/g,"/")).join("://"),pe=e=>{let i=e||"https://gitlab.com";return{authorizationEndpoint:v(`${i}/oauth/authorize`),tokenEndpoint:v(`${i}/oauth/token`),userinfoEndpoint:v(`${i}/api/v4/user`)}},S=e=>{let{authorizationEndpoint:i,tokenEndpoint:r,userinfoEndpoint:t}=pe(e.issuer),o="gitlab";return{id:o,name:"Gitlab",createAuthorizationURL:async({state:a,scopes:c,codeVerifier:s,redirectURI:p})=>{let u=c||["read_user"];return e.scope&&u.push(...e.scope),await d({id:o,options:e,authorizationEndpoint:i,scopes:u,state:a,redirectURI:p,codeVerifier:s})},validateAuthorizationCode:async({code:a,redirectURI:c,codeVerifier:s})=>l({code:a,redirectURI:e.redirectURI||c,options:e,codeVerifier:s,tokenEndpoint:r}),async getUserInfo(a){let{data:c,error:s}=await de(t,{headers:{authorization:`Bearer ${a.accessToken}`}});return s||c.state!=="active"||c.locked?null:{user:{id:c.id.toString(),name:c.name??c.username,email:c.email,image:c.avatar_url,emailVerified:!0},data:c}}}};var ue={apple:A,discord:U,facebook:k,github:L,microsoft:I,google:O,spotify:T,twitch:z,twitter:E,dropbox:C,linkedin:$,gitlab:S},ct=Object.keys(ue);export{A as apple,U as discord,C as dropbox,k as facebook,W as getApplePublicKey,L as github,S as gitlab,O as google,$ as linkedin,I as microsoft,ct as socialProviderList,ue as socialProviders,T as spotify,z as twitch,E as twitter};
