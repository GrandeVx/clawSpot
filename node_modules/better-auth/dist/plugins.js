import{APIError as Kt}from"better-call";import{z as Te}from"zod";import{createEndpointCreator as Or,createMiddleware as at,createMiddlewareCreator as vr}from"better-call";var dt=at(async()=>({})),P=vr({use:[dt,at(async()=>({}))]}),u=Or({use:[dt]});import{APIError as N}from"better-call";import{z as U}from"zod";import{TimeSpan as Mn}from"oslo";import{base64url as Sr}from"oslo/encoding";import{HMAC as ct,sha256 as Ln}from"oslo/crypto";async function Er({value:e,secret:o}){return new ct("SHA-256").sign(new TextEncoder().encode(o),new TextEncoder().encode(e)).then(t=>Buffer.from(t).toString("base64"))}function Ir({value:e,signature:o,secret:r}){return new ct("SHA-256").verify(new TextEncoder().encode(r),Buffer.from(o,"base64"),new TextEncoder().encode(e))}var Le={sign:Er,verify:Ir};var Z=class extends Error{constructor(o,r){super(o),this.name="BetterAuthError",this.message=o,this.cause=r,this.stack=""}};var v=(e,o="ms")=>new Date(Date.now()+(o==="sec"?e*1e3:e));var xe=Object.create(null),Oe=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?xe:globalThis),Y=new Proxy(xe,{get(e,o){return Oe()[o]??xe[o]},has(e,o){let r=Oe();return o in r||o in xe},set(e,o,r){let t=Oe(!0);return t[o]=r,!0},deleteProperty(e,o){if(!o)return!1;let r=Oe(!0);return delete r[o],!0},ownKeys(){let e=Oe(!0);return Object.keys(e)}});function Ur(e){return e?e!=="false":!1}var Je=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var ut=Je==="dev"||Je==="development",Tr=Je==="test"||Ur(Y.TEST);function Be(e){let o=new Map;return e.split(", ").forEach(t=>{let n=t.split(";").map(p=>p.trim()),[i,...s]=n,[a,...d]=i.split("="),c=d.join("=");if(!a||c===void 0){console.warn(`Malformed cookie: ${t}`);return}let l={value:c};s.forEach(p=>{let[f,...m]=p.split("="),g=m.join("="),S=f.trim().toLowerCase();switch(S){case"max-age":l["max-age"]=g?parseInt(g.trim(),10):void 0;break;case"expires":l.expires=g?new Date(g.trim()):void 0;break;case"domain":l.domain=g?g.trim():void 0;break;case"path":l.path=g?g.trim():void 0;break;case"secure":l.secure=!0;break;case"httponly":l.httponly=!0;break;case"samesite":l.samesite=g?g.trim().toLowerCase():void 0;break;default:l[S]=g?g.trim():!0;break}}),o.set(a,l)}),o}async function h(e,o,r,t){let n=e.context.authCookies.sessionToken.options,i=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,o.session.id,e.context.secret,{...n,maxAge:i,...t}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),e.context.options.session?.cookieCache?.enabled&&e.setCookie(e.context.authCookies.sessionData.name,JSON.stringify(Sr.encode(new TextEncoder().encode(JSON.stringify({session:o,expiresAt:v(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await Le.sign({value:JSON.stringify(o),secret:e.context.secret})})))),e.context.authCookies.sessionData.options),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(o.session.id,JSON.stringify({user:o.user,session:o.session}),o.session.expiresAt.getTime()-Date.now())}function D(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}function ve(e){let o=e.split("; "),r=new Map;return o.forEach(t=>{let[n,i]=t.split("=");r.set(n,i)}),r}import{betterFetch as xr}from"@better-fetch/fetch";import{APIError as Br}from"better-call";import{decodeProtectedHeader as Dr,importJWK as Nr,jwtVerify as jr}from"jose";import{parseJWT as Vr}from"oslo/jwt";import{sha256 as Pr}from"oslo/crypto";import{base64url as _r}from"oslo/encoding";async function lt(e){let o=await Pr(new TextEncoder().encode(e));return _r.encode(new Uint8Array(o),{includePadding:!1})}function pt(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?v(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function R({id:e,options:o,authorizationEndpoint:r,state:t,codeVerifier:n,scopes:i,claims:s,redirectURI:a}){let d=new URL(r);if(d.searchParams.set("response_type","code"),d.searchParams.set("client_id",o.clientId),d.searchParams.set("state",t),d.searchParams.set("scope",i.join(" ")),d.searchParams.set("redirect_uri",o.redirectURI||a),n){let c=await lt(n);d.searchParams.set("code_challenge_method","S256"),d.searchParams.set("code_challenge",c)}if(s){let c=s.reduce((l,p)=>(l[p]=null,l),{});d.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...c}}))}return d}import{betterFetch as Cr}from"@better-fetch/fetch";async function k({code:e,codeVerifier:o,redirectURI:r,options:t,tokenEndpoint:n,authentication:i}){let s=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(s.set("grant_type","authorization_code"),s.set("code",e),o&&s.set("code_verifier",o),s.set("redirect_uri",r),i==="basic"){let p=btoa(`${t.clientId}:${t.clientSecret}`);a.authorization=`Basic ${p}`}else s.set("client_id",t.clientId),s.set("client_secret",t.clientSecret);let{data:d,error:c}=await Cr(n,{method:"POST",body:s,headers:a});if(c)throw c;return pt(d)}import{generateCodeVerifier as zr,generateState as Lr}from"oslo/oauth2";import{z as ae}from"zod";import{APIError as mt}from"better-call";function fe(e){try{return new URL(e).origin}catch{return null}}async function ge(e,o){let r=e.body?.callbackURL||(e.query?.currentURL?fe(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new mt("BAD_REQUEST",{message:"callbackURL is required"});let t=zr(),n=Lr(),i=JSON.stringify({callbackURL:r,codeVerifier:t,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,link:o,expiresAt:Date.now()+10*60*1e3}),s=new Date;s.setMinutes(s.getMinutes()+10);let a=await e.context.internalAdapter.createVerificationValue({value:i,identifier:n,expiresAt:s});if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new mt("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:t}}async function De(e){let o=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(o);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:o}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let t=ae.object({callbackURL:ae.string(),codeVerifier:ae.string(),errorURL:ae.string().optional(),expiresAt:ae.number(),link:ae.object({email:ae.string(),userId:ae.string()}).optional()}).parse(JSON.parse(r.value));if(t.errorURL||(t.errorURL=`${e.context.baseURL}/error`),t.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:o}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),t}var ft=e=>{let o="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:t,redirectURI:n}){let i=t||["email","name"];return e.scope&&i.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${n||e.redirectURI}&scope=${i.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:async({code:r,codeVerifier:t,redirectURI:n})=>k({code:r,codeVerifier:t,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:o}),async verifyIdToken(r,t){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,t);let n=Dr(r),{kid:i,alg:s}=n;if(!i||!s)return!1;let a=await Fr(i),{payload:d}=await jr(r,a,{algorithms:[s],issuer:"https://appleid.apple.com",audience:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(c=>{d[c]!==void 0&&(d[c]=!!d[c])}),t&&d.nonce!==t?!1:!!d},async getUserInfo(r){if(!r.idToken)return null;let t=Vr(r.idToken)?.payload;if(!t)return null;let n=t.user?`${t.user.name.firstName} ${t.user.name.lastName}`:t.email;return{user:{id:t.sub,name:n,emailVerified:!1,email:t.email},data:t}}}},Fr=async e=>{let o="https://appleid.apple.com",r="/auth/keys",{data:t}=await xr(`${o}${r}`);if(!t?.keys)throw new Br("BAD_REQUEST",{message:"Keys not found"});let n=t.keys.find(i=>i.kid===e);if(!n)throw new Error(`JWK with kid ${e} not found`);return await Nr(n,n.alg)};import{betterFetch as qr}from"@better-fetch/fetch";var gt=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:o,scopes:r,redirectURI:t}){let n=r||["identify","email"];return e.scope&&n.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${n.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||t)}&state=${o}`)},validateAuthorizationCode:async({code:o,redirectURI:r})=>k({code:o,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(o){let{data:r,error:t}=await qr("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${o.accessToken}`}});if(t)return null;if(r.avatar===null){let n=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${n}.png`}else{let n=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${n}`}return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url},data:r}}});import{betterFetch as Mr}from"@better-fetch/fetch";var ht=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:o,scopes:r,redirectURI:t}){let n=r||["email","public_profile"];return e.scope&&n.push(...e.scope),await R({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:n,state:o,redirectURI:t})},validateAuthorizationCode:async({code:o,redirectURI:r})=>k({code:o,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async getUserInfo(o){let{data:r,error:t}=await Mr("https://graph.facebook.com/me?fields=id,name,email,picture",{auth:{type:"Bearer",token:o.accessToken}});return t?null:{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified},data:r}}});import{betterFetch as wt}from"@better-fetch/fetch";var yt=e=>{let o="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:t,codeVerifier:n,redirectURI:i}){let s=t||["user:email"];return e.scope&&s.push(...e.scope),R({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:s,state:r,redirectURI:i})},validateAuthorizationCode:async({code:r,redirectURI:t})=>k({code:r,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:o}),async getUserInfo(r){let{data:t,error:n}=await wt("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(n)return null;let i=!1;if(!t.email){let{data:s,error:a}=await wt("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});a||(t.email=(s.find(d=>d.primary)??s[0])?.email,i=s.find(d=>d.email===t.email)?.verified??!1)}return{user:{id:t.id.toString(),name:t.name||t.login,email:t.email,image:t.avatar_url,emailVerified:i},data:t}}}};import{parseJWT as Gr}from"oslo/jwt";import{createConsola as $r}from"consola";var Ze=["info","success","warn","error","debug"];function Hr(e,o){return Ze.indexOf(o)<=Ze.indexOf(e)}var Qr=$r({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),Wr=e=>{let o=e?.disabled!==!0,r=e?.level??"error",t=(n,i,s=[])=>{if(!(!o||!Hr(r,n))){if(!e||typeof e.log!="function"){Qr[n]("",i,...s);return}e.log(n==="success"?"info":n,i,s)}};return Object.fromEntries(Ze.map(n=>[n,(...[i,...s])=>t(n,i,s)]))},W=Wr();import{betterFetch as Kr}from"@better-fetch/fetch";var bt=e=>({id:"google",name:"Google",async createAuthorizationURL({state:o,scopes:r,codeVerifier:t,redirectURI:n}){if(!e.clientId||!e.clientSecret)throw W.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new Z("CLIENT_ID_AND_SECRET_REQUIRED");if(!t)throw new Z("codeVerifier is required for Google");let i=r||["email","profile","openid"];e.scope&&i.push(...e.scope);let s=await R({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:i,state:o,codeVerifier:t,redirectURI:n});return e.accessType&&s.searchParams.set("access_type",e.accessType),e.prompt&&s.searchParams.set("prompt",e.prompt),s},validateAuthorizationCode:async({code:o,codeVerifier:r,redirectURI:t})=>k({code:o,codeVerifier:r,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),async verifyIdToken(o,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(o,r);let t=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${o}`,{data:n}=await Kr(t);return n?n.aud===e.clientId&&n.iss==="https://accounts.google.com":!1},async getUserInfo(o){if(!o.idToken)return null;let r=Gr(o.idToken)?.payload;return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified},data:r}}});import{betterFetch as Jr}from"@better-fetch/fetch";import{parseJWT as Zr}from"oslo/jwt";var At=e=>{let o=e.tenantId||"common",r=`https://login.microsoftonline.com/${o}/oauth2/v2.0/authorize`,t=`https://login.microsoftonline.com/${o}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(n){let i=n.scopes||["openid","profile","email","User.Read"];return e.scope&&i.push(...e.scope),R({id:"microsoft",options:e,authorizationEndpoint:r,state:n.state,codeVerifier:n.codeVerifier,scopes:i,redirectURI:n.redirectURI})},validateAuthorizationCode({code:n,codeVerifier:i,redirectURI:s}){return k({code:n,codeVerifier:i,redirectURI:e.redirectURI||s,options:e,tokenEndpoint:t})},async getUserInfo(n){if(!n.idToken)return null;let i=Zr(n.idToken)?.payload,s=e.profilePhotoSize||48;return await Jr(`https://graph.microsoft.com/v1.0/me/photos/${s}x${s}/$value`,{headers:{Authorization:`Bearer ${n.accessToken}`},async onResponse(a){if(!(e.disableProfilePhoto||!a.response.ok))try{let c=await a.response.clone().arrayBuffer(),l=Buffer.from(c).toString("base64");i.picture=`data:image/jpeg;base64, ${l}`}catch(d){W.error(d&&typeof d=="object"&&"name"in d?d.name:"",d)}}}),{user:{id:i.sub,name:i.name,email:i.email,image:i.picture,emailVerified:!0},data:i}}}};import{betterFetch as Yr}from"@better-fetch/fetch";var kt=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:o,scopes:r,codeVerifier:t,redirectURI:n}){let i=r||["user-read-email"];return e.scope&&i.push(...e.scope),R({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:i,state:o,codeVerifier:t,redirectURI:n})},validateAuthorizationCode:async({code:o,codeVerifier:r,redirectURI:t})=>k({code:o,codeVerifier:r,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(o){let{data:r,error:t}=await Yr("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});return t?null:{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1},data:r}}});var he={isAction:!1};import{nanoid as Xr}from"nanoid";var L=e=>Xr(e);import{parseJWT as eo}from"oslo/jwt";var Ot=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:o,scopes:r,redirectURI:t}){let n=r||["user:read:email","openid"];return e.scope&&n.push(...e.scope),R({id:"twitch",redirectURI:t,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:n,state:o,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:o,redirectURI:r})=>k({code:o,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(o){let r=o.idToken;if(!r)return W.error("No idToken found in token"),null;let t=eo(r)?.payload;return{user:{id:t.sub,name:t.preferred_username,email:t.email,image:t.picture,emailVerified:!1},data:t}}});import{betterFetch as to}from"@better-fetch/fetch";var vt=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(o){let r=o.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),R({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:o.state,codeVerifier:o.codeVerifier,redirectURI:o.redirectURI})},validateAuthorizationCode:async({code:o,codeVerifier:r,redirectURI:t})=>k({code:o,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||t,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(o){let{data:r,error:t}=await to("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});return t?null:{user:{id:r.data.id,name:r.data.name,email:r.data.email||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1},data:r}}});import{betterFetch as ro}from"@better-fetch/fetch";var Rt=e=>{let o="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:t,codeVerifier:n,redirectURI:i})=>{let s=t||["account_info.read"];return e.scope&&s.push(...e.scope),await R({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:s,state:r,redirectURI:i,codeVerifier:n})},validateAuthorizationCode:async({code:r,codeVerifier:t,redirectURI:n})=>await k({code:r,codeVerifier:t,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:o}),async getUserInfo(r){let{data:t,error:n}=await ro("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});return n?null:{user:{id:t.account_id,name:t.name?.display_name,email:t.email,emailVerified:t.email_verified||!1,image:t.profile_photo_url},data:t}}}};import{betterFetch as oo}from"@better-fetch/fetch";var Et=e=>{let o="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:t,scopes:n,redirectURI:i})=>{let s=n||["profile","email","openid"];return e.scope&&s.push(...e.scope),await R({id:"linkedin",options:e,authorizationEndpoint:o,scopes:s,state:t,redirectURI:i})},validateAuthorizationCode:async({code:t,redirectURI:n})=>await k({code:t,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:r}),async getUserInfo(t){let{data:n,error:i}=await oo("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});return i?null:{user:{id:n.sub,name:n.name,email:n.email,emailVerified:n.email_verified||!1,image:n.picture},data:n}}}};import{betterFetch as no}from"@better-fetch/fetch";var Ye=(e="")=>e.split("://").map(o=>o.replace(/\/{2,}/g,"/")).join("://"),io=e=>{let o=e||"https://gitlab.com";return{authorizationEndpoint:Ye(`${o}/oauth/authorize`),tokenEndpoint:Ye(`${o}/oauth/token`),userinfoEndpoint:Ye(`${o}/api/v4/user`)}},It=e=>{let{authorizationEndpoint:o,tokenEndpoint:r,userinfoEndpoint:t}=io(e.issuer),n="gitlab";return{id:n,name:"Gitlab",createAuthorizationURL:async({state:s,scopes:a,codeVerifier:d,redirectURI:c})=>{let l=a||["read_user"];return e.scope&&l.push(...e.scope),await R({id:n,options:e,authorizationEndpoint:o,scopes:l,state:s,redirectURI:c,codeVerifier:d})},validateAuthorizationCode:async({code:s,redirectURI:a,codeVerifier:d})=>k({code:s,redirectURI:e.redirectURI||a,options:e,codeVerifier:d,tokenEndpoint:r}),async getUserInfo(s){let{data:a,error:d}=await no(t,{headers:{authorization:`Bearer ${s.accessToken}`}});return d||a.state!=="active"||a.locked?null:{user:{id:a.id.toString(),name:a.name??a.username,email:a.email,image:a.avatar_url,emailVerified:!0},data:a}}}};var so={apple:ft,discord:gt,facebook:ht,github:yt,microsoft:At,google:bt,spotify:kt,twitch:Ot,twitter:vt,dropbox:Rt,linkedin:Et,gitlab:It},Ne=Object.keys(so);import{TimeSpan as lo}from"oslo";import{createJWT as po,validateJWT as mo}from"oslo/jwt";import{z as X}from"zod";import{APIError as je}from"better-call";import{APIError as ue}from"better-call";import{z as Re}from"zod";function Ut(e){try{return JSON.parse(e)}catch{return null}}var Tt=()=>u("/get-session",{method:"GET",query:Re.optional(Re.object({disableCookieCache:Re.boolean().optional()})),requireHeaders:!0},async e=>{try{let o=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!o)return e.json(null);let r=e.getCookie(e.context.authCookies.sessionData.name),t=r?Ut(Buffer.from(r,"base64").toString()):null;if(t&&!await Le.verify({value:JSON.stringify(t.session),signature:t?.signature,secret:e.context.secret}))return D(e),e.json(null);let n=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(t?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let l=t.session;if(t.expiresAt<Date.now()||l.session.expiresAt<new Date){let f=e.context.authCookies.sessionData.name;e.setCookie(f,"",{maxAge:0})}else return e.json(l)}let i=await e.context.internalAdapter.findSession(o);if(!i||i.session.expiresAt<new Date)return D(e),i&&await e.context.internalAdapter.deleteSession(i.session.id),e.json(null);if(n)return e.json(i);let s=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge;if(i.session.expiresAt.valueOf()-s*1e3+a*1e3<=Date.now()){let l=await e.context.internalAdapter.updateSession(i.session.id,{expiresAt:v(e.context.sessionConfig.expiresIn,"sec")});if(!l)return D(e),e.json(null,{status:401});let p=(l.expiresAt.valueOf()-Date.now())/1e3;return await h(e,{session:l,user:i.user},!1,{maxAge:p}),e.json({session:l,user:i.user})}return e.json(i)}catch(o){throw e.context.logger.error("INTERNAL_SERVER_ERROR",o),new ue("INTERNAL_SERVER_ERROR",{message:"internal server error"})}}),z=async e=>{if(e.context.session)return e.context.session;let o=await Tt()({...e,_flag:"json",headers:e.headers});return e.context.session=o,o},b=P(async e=>{let o=await z(e);if(!o?.session)throw new ue("UNAUTHORIZED");return{session:o}});var ao=u("/revoke-session",{method:"POST",body:Re.object({id:Re.string()}),use:[b],requireHeaders:!0},async e=>{let o=e.body.id,r=await e.context.internalAdapter.findSession(o);if(!r)throw new ue("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new ue("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(o)}catch(t){throw e.context.logger.error(t&&typeof t=="object"&&"name"in t?t.name:"",t),new ue("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),co=u("/revoke-sessions",{method:"POST",use:[b],requireHeaders:!0},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(o){throw e.context.logger.error(o&&typeof o=="object"&&"name"in o?o.name:"",o),new ue("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),uo=u("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[b]},async e=>{let o=e.context.session;if(!o.user)throw new ue("UNAUTHORIZED");let n=(await e.context.internalAdapter.listSessions(o.user.id)).filter(i=>i.expiresAt>new Date).filter(i=>i.id!==e.context.session.session.id);return await Promise.all(n.map(i=>e.context.internalAdapter.deleteSession(i.id))),e.json({status:!0})});async function de(e,o,r){return await po("HS256",Buffer.from(e),{email:o.toLowerCase(),updateTo:r},{expiresIn:new lo(1,"h"),issuer:"better-auth",subject:"verify-email",audiences:[o],includeIssuedTimestamp:!0})}var fo=u("/send-verification-email",{method:"POST",query:X.object({currentURL:X.string().optional()}).optional(),body:X.object({email:X.string().email(),callbackURL:X.string().optional()})},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new je("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:o}=e.body,r=await e.context.internalAdapter.findUserByEmail(o);if(!r)throw new je("BAD_REQUEST",{message:"User not found"});let t=await de(e.context.secret,o),n=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.emailVerification.sendVerificationEmail({user:r.user,url:n,token:t},e.request),e.json({status:!0})}),go=u("/verify-email",{method:"GET",query:X.object({token:X.string(),callbackURL:X.string().optional()})},async e=>{function o(a){throw e.query.callbackURL?e.redirect(`${e.query.callbackURL}?error=${a}`):new je("UNAUTHORIZED",{message:a})}let{token:r}=e.query,t;try{t=await mo("HS256",Buffer.from(e.context.secret),r)}catch(a){return e.context.logger.error("Failed to verify email",a),o("invalid_token")}let i=X.object({email:X.string().email(),updateTo:X.string().optional()}).parse(t.payload),s=await e.context.internalAdapter.findUserByEmail(i.email);if(!s)return o("user_not_found");if(i.updateTo){let a=await z(e);if(!a){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return o("unauthorized")}if(a.user.email!==i.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return o("unauthorized")}let d=await e.context.internalAdapter.updateUserByEmail(i.email,{email:i.updateTo});if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:d,url:`${e.context.baseURL}/verify-email?token=${r}`,token:r},e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({user:d,status:!0})}if(await e.context.internalAdapter.updateUserByEmail(i.email,{emailVerified:!0}),e.context.options.emailVerification?.autoSignInAfterVerification&&!await z(e)){let d=await e.context.internalAdapter.createSession(s.user.id,e.request);if(!d)throw new je("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await h(e,{session:d,user:s.user})}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({user:null,status:!0})});import{APIError as Ka,createRouter as Ja,statusCode as Za}from"better-call";import{APIError as ho}from"better-call";var wo=P(async e=>{if(e.request?.method!=="POST")return;let{body:o,query:r,context:t}=e,n=e.headers?.get("origin")||e.headers?.get("referer")||"",i=o?.callbackURL||r?.callbackURL,s=o?.redirectTo,a=r?.currentURL,d=t.trustedOrigins,c=e.headers?.has("cookie"),l=(f,m)=>m.includes("*")?new RegExp("^"+m.replace(/\*/g,"[^/]+").replace(/\./g,"\\.")+"$").test(f):f.startsWith(m),p=(f,m)=>{if(!f)return;if(!d.some(S=>l(f,S)||f?.startsWith("/")&&m!=="origin"&&!f.includes(":")))throw e.context.logger.error(`Invalid ${m}: ${f}`),e.context.logger.info(`If it's a valid URL, please add ${f} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${d}`),new ho("FORBIDDEN",{message:`Invalid ${m}`})};c&&!e.context.options.advanced?.disableCSRFCheck&&p(n,"origin"),i&&p(i,"callbackURL"),s&&p(s,"redirectURL"),a&&p(a,"currentURL")});var yo=u("/ok",{method:"GET",metadata:he},async e=>e.json({ok:!0}));import{z as Ra}from"zod";import{APIError as _a}from"better-call";import{z as A}from"zod";var ba=A.object({id:A.string(),providerId:A.string(),accountId:A.string(),userId:A.string(),accessToken:A.string().nullish(),refreshToken:A.string().nullish(),idToken:A.string().nullish(),expiresAt:A.date().nullish(),password:A.string().nullish()}),St=A.object({id:A.string(),email:A.string().transform(e=>e.toLowerCase()),emailVerified:A.boolean().default(!1),name:A.string(),image:A.string().nullish(),createdAt:A.date().default(new Date),updatedAt:A.date().default(new Date)}),Aa=A.object({id:A.string(),userId:A.string(),expiresAt:A.date(),ipAddress:A.string().nullish(),userAgent:A.string().nullish()}),ka=A.object({id:A.string(),value:A.string(),createdAt:A.date(),expiresAt:A.date(),identifier:A.string()});function G(e,o){if(!o)return e;for(let r in o){let t=o[r]?.modelName;t&&(e[r].modelName=t);for(let n in e[r].fields){let i=o[r]?.fields?.[n];i&&(e[r].fields[n].fieldName=i)}}return e}var Ao=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,ko=u("/error",{method:"GET",metadata:he},async e=>{let o=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(Ao(o),{headers:{"Content-Type":"text/html"}})});import{APIError as O}from"better-call";async function we(e,{userInfo:o,account:r,callbackURL:t}){let n=await e.context.internalAdapter.findUserByEmail(o.email.toLowerCase(),{includeAccounts:!0}).catch(a=>{throw W.error(`Better auth was unable to query your database.
Error: `,a),e.redirect(`${e.context.baseURL}/error?error=internal_server_error`)}),i=n?.user;if(n){let a=n.accounts.find(d=>d.providerId===r.providerId);if(a)await e.context.internalAdapter.updateAccount(a.id,{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,expiresAt:r.expiresAt});else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!o.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return ut&&W.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:o.id.toString(),id:e.context.uuid(),userId:n.user.id,accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,expiresAt:r.expiresAt})}catch(l){return W.error("Unable to link account",l),{error:"unable to link account",data:null}}}}else try{let a=o.emailVerified||!1;if(i=await e.context.internalAdapter.createOAuthUser({...o,id:e.context.uuid(),emailVerified:a,email:o.email.toLowerCase()},{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,expiresAt:r.expiresAt,providerId:r.providerId,accountId:o.id.toString()}).then(d=>d?.user),!a&&i&&e.context.options.emailVerification?.sendOnSignUp){let d=await de(e.context.secret,i.email),c=`${e.context.baseURL}/verify-email?token=${d}&callbackURL=${t}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:i,url:c,token:d},e.request)}}catch(a){return W.error("Unable to create user",a),{error:"unable to create user",data:null}}if(!i)return{error:"unable to create user",data:null};let s=await e.context.internalAdapter.createSession(i.id,e.request);return s?{data:{session:s,user:i},error:null}:{error:"unable to create session",data:null}}var Oo=u("/sign-in/social",{method:"POST",query:U.object({currentURL:U.string().optional()}).optional(),body:U.object({callbackURL:U.string().optional(),errorCallbackURL:U.string().optional(),provider:U.enum(Ne),disableRedirect:U.boolean().optional(),idToken:U.optional(U.object({token:U.string(),nonce:U.string().optional(),accessToken:U.string().optional(),refreshToken:U.string().optional(),expiresAt:U.number().optional()}))})},async e=>{let o=e.context.socialProviders.find(i=>i.id===e.body.provider);if(!o)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new N("NOT_FOUND",{message:"Provider not found"});if(e.body.idToken){if(!o.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new N("NOT_FOUND",{message:"Provider does not support id token verification"});let{token:i,nonce:s}=e.body.idToken;if(!await o.verifyIdToken(i,s))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new N("UNAUTHORIZED",{message:"Invalid id token"});let d=await o.getUserInfo({idToken:i,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!d||!d?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new N("UNAUTHORIZED",{message:"Failed to get user info"});if(!d.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new N("UNAUTHORIZED",{message:"User email not found"});let c=await we(e,{userInfo:{email:d.user.email,id:d.user.id,name:d.user.name||"",image:d.user.image,emailVerified:d.user.emailVerified||!1},account:{providerId:o.id,accountId:d.user.id,accessToken:e.body.idToken.accessToken}});if(c.error)throw new N("UNAUTHORIZED",{message:c.error});return await h(e,c.data),e.json({session:c.data.session,user:c.data.user,url:`${e.body.callbackURL||e.query?.currentURL||e.context.options.baseURL}`,redirect:!0})}let{codeVerifier:r,state:t}=await ge(e),n=await o.createAuthorizationURL({state:t,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${o.id}`});return e.json({url:n.toString(),redirect:!e.body.disableRedirect})}),vo=u("/sign-in/email",{method:"POST",body:U.object({email:U.string(),password:U.string(),callbackURL:U.string().optional(),rememberMe:U.boolean().default(!0).optional()})},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new N("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:o,password:r}=e.body;if(!U.string().email().safeParse(o).success)throw new N("BAD_REQUEST",{message:"Invalid email"});let n=await e.context.internalAdapter.findUserByEmail(o,{includeAccounts:!0});if(!n)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:o}),new N("UNAUTHORIZED",{message:"Invalid email or password"});let i=n.accounts.find(c=>c.providerId==="credential");if(!i)throw e.context.logger.error("Credential account not found",{email:o}),new N("UNAUTHORIZED",{message:"Invalid email or password"});let s=i?.password;if(!s)throw e.context.logger.error("Password not found",{email:o}),new N("UNAUTHORIZED",{message:"Unexpected error"});if(!await e.context.password.verify(s,r))throw e.context.logger.error("Invalid password"),new N("UNAUTHORIZED",{message:"Invalid email or password"});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!n.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Email verification is required but no email verification handler is provided"),new N("INTERNAL_SERVER_ERROR",{message:"Email is not verified."});let c=await de(e.context.secret,n.user.email),l=`${e.context.baseURL}/verify-email?token=${c}&callbackURL=${e.body.callbackURL||"/"}`;throw await e.context.options.emailVerification.sendVerificationEmail({user:n.user,url:l,token:c},e.request),e.context.logger.error("Email not verified",{email:o}),new N("FORBIDDEN",{message:"Email is not verified. Check your email for a verification link"})}let d=await e.context.internalAdapter.createSession(n.user.id,e.headers,e.body.rememberMe===!1);if(!d)throw e.context.logger.error("Failed to create session"),new N("UNAUTHORIZED",{message:"Failed to create session"});return await h(e,{session:d,user:n.user},e.body.rememberMe===!1),e.json({user:n.user,session:d,redirect:!!e.body.callbackURL,url:e.body.callbackURL})});import{z as Ee}from"zod";var Ve=Ee.object({code:Ee.string().optional(),error:Ee.string().optional(),errorMessage:Ee.string().optional(),state:Ee.string().optional()}),Ro=u("/callback/:id",{method:["GET","POST"],body:Ve.optional(),query:Ve.optional(),metadata:he},async e=>{let o;try{if(e.method==="GET")o=Ve.parse(e.query);else if(e.method==="POST")o=Ve.parse(e.body);else throw new Error("Unsupported method")}catch(y){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",y),e.redirect(`${e.context.baseURL}/error?error=invalid_callback_request`)}let{code:r,error:t,state:n}=o;if(!n)throw e.context.logger.error("State not found"),e.redirect(`${e.context.baseURL}/error?error=state_not_found`);if(!r)throw e.context.logger.error("Code not found"),e.redirect(`${e.context.baseURL}/error?error=${t||"no_code"}`);let i=e.context.socialProviders.find(y=>y.id===e.params.id);if(!i)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let{codeVerifier:s,callbackURL:a,link:d,errorURL:c}=await De(e),l;try{l=await i.validateAuthorizationCode({code:r,codeVerifier:s,redirectURI:`${e.context.baseURL}/callback/${i.id}`})}catch(y){throw e.context.logger.error("",y),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`)}let p=await i.getUserInfo(l).then(y=>y?.user),m={id:L(),...p};function g(y){let C=c||a||`${e.context.baseURL}/error`;throw C.includes("?")?C=`${C}&error=${y}`:C=`${C}?error=${y}`,e.redirect(C)}if(!p)return e.context.logger.error("Unable to get user info"),g("unable_to_get_user_info");if(!m.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),g("email_not_found");if(!a)throw e.context.logger.error("No callback URL found"),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);if(d){if(d.email!==m.email.toLowerCase())return g("email_doesn't_match");if(!await e.context.internalAdapter.createAccount({userId:d.userId,providerId:i.id,accountId:p.id}))return g("unable_to_link_account");let C;try{C=new URL(a).toString()}catch{C=a}throw e.redirect(C)}let S=await we(e,{userInfo:{email:m.email,id:m.id,name:m.name||"",image:m.image,emailVerified:m.emailVerified||!1},account:{providerId:i.id,accountId:p.id,accessToken:l.accessToken,refreshToken:l.refreshToken,expiresAt:l.accessTokenExpiresAt},callbackURL:a});if(S.error)return e.context.logger.error(S.error.split(" ").join("_")),g(S.error.split(" ").join("_"));let{session:$,user:re}=S.data;await h(e,{session:$,user:re});let J;try{J=new URL(a).toString()}catch{J=a}throw e.redirect(J)});import"zod";import{APIError as xo}from"better-call";var Eo=u("/sign-out",{method:"POST",requireHeaders:!0},async e=>{let o=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!o)throw D(e),new xo("BAD_REQUEST",{message:"Session not found"});return await e.context.internalAdapter.deleteSession(o),D(e),e.json({success:!0})});import{z as K}from"zod";import{APIError as Xe}from"better-call";function Pt(e,o,r){let t=o?new URL(o,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([n,i])=>t.searchParams.set(n,i)),t.href}function Bo(e,o,r){let t=new URL(o,e.baseURL);return r&&Object.entries(r).forEach(([n,i])=>t.searchParams.set(n,i)),t.href}var Io=u("/forget-password",{method:"POST",body:K.object({email:K.string().email(),redirectTo:K.string()})},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function in your auth config!"),new Xe("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:o,redirectTo:r}=e.body,t=await e.context.internalAdapter.findUserByEmail(o,{includeAccounts:!0});if(!t)return e.context.logger.error("Reset Password: User not found",{email:o}),e.json({status:!1},{body:{status:!0}});let n=60*60*1,i=v(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||n,"sec"),s=e.context.uuid();await e.context.internalAdapter.createVerificationValue({value:t.user.id,identifier:`reset-password:${s}`,expiresAt:i});let a=`${e.context.baseURL}/reset-password/${s}?callbackURL=${r}`;return await e.context.options.emailAndPassword.sendResetPassword({user:t.user,url:a,token:s},e.request),e.json({status:!0})}),Uo=u("/reset-password/:token",{method:"GET",query:K.object({callbackURL:K.string()})},async e=>{let{token:o}=e.params,{callbackURL:r}=e.query;if(!o||!r)throw e.redirect(Pt(e.context,r,{error:"INVALID_TOKEN"}));let t=await e.context.internalAdapter.findVerificationValue(`reset-password:${o}`);throw!t||t.expiresAt<new Date?e.redirect(Pt(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(Bo(e.context,r,{token:o}))}),To=u("/reset-password",{query:K.optional(K.object({token:K.string().optional(),currentURL:K.string().optional()})),method:"POST",body:K.object({newPassword:K.string(),token:K.string().optional()})},async e=>{let o=e.body.token||e.query?.token||(e.query?.currentURL?new URL(e.query.currentURL).searchParams.get("token"):"");if(!o)throw new Xe("BAD_REQUEST",{message:"Token not found"});let{newPassword:r}=e.body,t=`reset-password:${o}`,n=await e.context.internalAdapter.findVerificationValue(t);if(!n||n.expiresAt<new Date)throw new Xe("BAD_REQUEST",{message:"Invalid token"});await e.context.internalAdapter.deleteVerificationValue(n.id);let i=n.value,s=await e.context.password.hash(r);return(await e.context.internalAdapter.findAccounts(i)).find(c=>c.providerId==="credential")?(await e.context.internalAdapter.updatePassword(i,s),e.json({status:!0})):(await e.context.internalAdapter.createAccount({userId:i,providerId:"credential",password:s,accountId:e.context.uuid()}),e.json({status:!0}))});import{z as H}from"zod";import{APIError as F}from"better-call";var So=u("/change-password",{method:"POST",body:H.object({newPassword:H.string(),currentPassword:H.string(),revokeOtherSessions:H.boolean().optional()}),use:[b]},async e=>{let{newPassword:o,currentPassword:r,revokeOtherSessions:t}=e.body,n=e.context.session,i=e.context.password.config.minPasswordLength;if(o.length<i)throw e.context.logger.error("Password is too short"),new F("BAD_REQUEST",{message:"Password is too short"});let s=e.context.password.config.maxPasswordLength;if(o.length>s)throw e.context.logger.error("Password is too long"),new F("BAD_REQUEST",{message:"Password too long"});let d=(await e.context.internalAdapter.findAccounts(n.user.id)).find(p=>p.providerId==="credential"&&p.password);if(!d||!d.password)throw new F("BAD_REQUEST",{message:"User does not have a password"});let c=await e.context.password.hash(o);if(!await e.context.password.verify(d.password,r))throw new F("BAD_REQUEST",{message:"Incorrect password"});if(await e.context.internalAdapter.updateAccount(d.id,{password:c}),t){await e.context.internalAdapter.deleteSessions(n.user.id);let p=await e.context.internalAdapter.createSession(n.user.id,e.headers);if(!p)throw new F("INTERNAL_SERVER_ERROR",{message:"Unable to create session"});await h(e,{session:p,user:n.user})}return e.json(n.user)}),Po=u("/set-password",{method:"POST",body:H.object({newPassword:H.string()}),metadata:{SERVER_ONLY:!0},use:[b]},async e=>{let{newPassword:o}=e.body,r=e.context.session,t=e.context.password.config.minPasswordLength;if(o.length<t)throw e.context.logger.error("Password is too short"),new F("BAD_REQUEST",{message:"Password is too short"});let n=e.context.password.config.maxPasswordLength;if(o.length>n)throw e.context.logger.error("Password is too long"),new F("BAD_REQUEST",{message:"Password too long"});let s=(await e.context.internalAdapter.findAccounts(r.user.id)).find(d=>d.providerId==="credential"&&d.password),a=await e.context.password.hash(o);if(!s)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:a}),e.json(r.user);throw new F("BAD_REQUEST",{message:"user already has a password"})}),_o=u("/delete-user",{method:"POST",body:H.object({password:H.string()}),use:[b]},async e=>{let{password:o}=e.body,r=e.context.session,n=(await e.context.internalAdapter.findAccounts(r.user.id)).find(s=>s.providerId==="credential"&&s.password);if(!n||!n.password)throw new F("BAD_REQUEST",{message:"User does not have a password"});if(!await e.context.password.verify(n.password,o))throw new F("BAD_REQUEST",{message:"Incorrect password"});return await e.context.internalAdapter.deleteUser(r.user.id),await e.context.internalAdapter.deleteSessions(r.user.id),D(e),e.json(null)}),Co=u("/change-email",{method:"POST",query:H.object({currentURL:H.string().optional()}).optional(),body:H.object({newEmail:H.string().email(),callbackURL:H.string().optional()}),use:[b]},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new F("BAD_REQUEST",{message:"Change email is disabled"});if(e.body.newEmail===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new F("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(e.body.newEmail))throw e.context.logger.error("Email already exists"),new F("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){let n=await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:e.body.newEmail});return e.json({user:n,status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new F("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await de(e.context.secret,e.context.session.user.email,e.body.newEmail),t=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:e.body.newEmail,url:t,token:r},e.request),e.json({user:null,status:!0})});import{z as Ie}from"zod";import{APIError as _t}from"better-call";var zo=u("/list-accounts",{method:"GET",use:[b]},async e=>{let o=e.context.session,r=await e.context.internalAdapter.findAccounts(o.user.id);return e.json(r.map(t=>({id:t.id,provider:t.providerId})))}),Lo=u("/link-social",{method:"POST",requireHeaders:!0,query:Ie.object({currentURL:Ie.string().optional()}).optional(),body:Ie.object({callbackURL:Ie.string().optional(),provider:Ie.enum(Ne)}),use:[b]},async e=>{let o=e.context.session;if((await e.context.internalAdapter.findAccounts(o.user.id)).find(a=>a.providerId===e.body.provider))throw new _t("BAD_REQUEST",{message:"Social Account is already linked."});let n=e.context.socialProviders.find(a=>a.id===e.body.provider);if(!n)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new _t("NOT_FOUND",{message:"Provider not found"});let i=await ge(e,{userId:o.user.id,email:o.user.email}),s=await n.createAuthorizationURL({state:i.state,codeVerifier:i.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${n.id}`});return e.json({url:s.toString(),redirect:!0})});var Ct=(e,o)=>{let r={};for(let[t,n]of Object.entries(e))r[t]=i=>n({...i,context:{...o,...i.context}}),r[t].path=n.path,r[t].method=n.method,r[t].options=n.options,r[t].headers=n.headers;return r};function Fe(e){let o=e;return{newRole(r){return Do(r)}}}function Do(e){return{statements:e,authorize(o,r){for(let[t,n]of Object.entries(o)){let i=e[t];return i?(r==="OR"?n.some(a=>i.includes(a)):n.every(a=>i.includes(a)))?{success:!0}:{success:!1,error:`Unauthorized to access resource "${t}"`}:{success:!1,error:`You are not allowed to access resource: ${t}`}}return{success:!1,error:"Not authorized"}}}}var No={organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]},et=Fe(No),jo=et.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"]}),Vo=et.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]}),Fo=et.newRole({organization:[],member:[],invitation:[]}),zt={admin:jo,owner:Vo,member:Fo};var _=(e,o)=>{let r=e.adapter;return{findOrganizationBySlug:async t=>await r.findOne({model:"organization",where:[{field:"slug",value:t}]}),createOrganization:async t=>{let n=await r.create({model:"organization",data:{...t.organization,metadata:t.organization.metadata?JSON.stringify(t.organization.metadata):void 0}}),i=await r.create({model:"member",data:{id:L(),organizationId:n.id,userId:t.user.id,createdAt:new Date,role:o?.creatorRole||"owner"}});return{...n,metadata:n.metadata?JSON.parse(n.metadata):void 0,members:[{...i,user:{id:t.user.id,name:t.user.name,email:t.user.email,image:t.user.image}}]}},findMemberByEmail:async t=>{let n=await r.findOne({model:"user",where:[{field:"email",value:t.email}]});if(!n)return null;let i=await r.findOne({model:"member",where:[{field:"organizationId",value:t.organizationId},{field:"userId",value:n.id}]});return i?{...i,user:{id:n.id,name:n.name,email:n.email,image:n.image}}:null},findMemberByOrgId:async t=>{let[n,i]=await Promise.all([await r.findOne({model:"member",where:[{field:"userId",value:t.userId},{field:"organizationId",value:t.organizationId}]}),await r.findOne({model:"user",where:[{field:"id",value:t.userId}]})]);return!i||!n?null:{...n,user:{id:i.id,name:i.name,email:i.email,image:i.image}}},findMemberById:async t=>{let n=await r.findOne({model:"member",where:[{field:"id",value:t}]});if(!n)return null;let i=await r.findOne({model:"user",where:[{field:"id",value:n.userId}]});return i?{...n,user:{id:i.id,name:i.name,email:i.email,image:i.image}}:null},createMember:async t=>await r.create({model:"member",data:t}),updateMember:async(t,n)=>await r.update({model:"member",where:[{field:"id",value:t}],update:{role:n}}),deleteMember:async t=>await r.delete({model:"member",where:[{field:"id",value:t}]}),updateOrganization:async(t,n)=>await r.update({model:"organization",where:[{field:"id",value:t}],update:n}),deleteOrganization:async t=>(await r.delete({model:"member",where:[{field:"organizationId",value:t}]}),await r.delete({model:"invitation",where:[{field:"organizationId",value:t}]}),await r.delete({model:"organization",where:[{field:"id",value:t}]}),t),setActiveOrganization:async(t,n)=>await e.internalAdapter.updateSession(t,{activeOrganizationId:n}),findOrganizationById:async t=>await r.findOne({model:"organization",where:[{field:"id",value:t}]}),findFullOrganization:async t=>{let[n,i,s]=await Promise.all([r.findOne({model:"organization",where:[{field:"id",value:t}]}),r.findMany({model:"invitation",where:[{field:"organizationId",value:t}]}),r.findMany({model:"member",where:[{field:"organizationId",value:t}]})]);if(!n)return null;let a=s.map(p=>p.userId),d=await r.findMany({model:"user",where:[{field:"id",value:a,operator:"in"}]}),c=new Map(d.map(p=>[p.id,p])),l=s.map(p=>{let f=c.get(p.userId);if(!f)throw new Z("Unexpected error: User not found for member");return{...p,user:{id:f.id,name:f.name,email:f.email,image:f.image}}});return{...n,invitations:i,members:l}},listOrganizations:async t=>{let n=await r.findMany({model:"member",where:[{field:"userId",value:t}]});if(!n||n.length===0)return[];let i=n.map(a=>a.organizationId);return await r.findMany({model:"organization",where:[{field:"id",value:i,operator:"in"}]})},createInvitation:async({invitation:t,user:n})=>{let s=v(o?.invitationExpiresIn||1728e5);return await r.create({model:"invitation",data:{id:L(),email:t.email,role:t.role,organizationId:t.organizationId,status:"pending",expiresAt:s,inviterId:n.id}})},findInvitationById:async t=>await r.findOne({model:"invitation",where:[{field:"id",value:t}]}),findPendingInvitation:async t=>(await r.findMany({model:"invitation",where:[{field:"email",value:t.email},{field:"organizationId",value:t.organizationId},{field:"status",value:"pending"}]})).filter(i=>new Date(i.expiresAt)>new Date),updateInvitation:async t=>await r.update({model:"invitation",where:[{field:"id",value:t.invitationId}],update:{status:t.status}})}};import"better-call";var x=P(async e=>({})),B=P({use:[b]},async e=>({session:e.context.session}));import{z as Q}from"zod";import{z as E}from"zod";var Lt=E.string(),qo=E.enum(["pending","accepted","rejected","canceled"]).default("pending"),Dc=E.object({id:E.string(),name:E.string(),slug:E.string(),logo:E.string().nullish(),metadata:E.record(E.string()).or(E.string().transform(e=>JSON.parse(e))).nullish(),createdAt:E.date()}),Nc=E.object({id:E.string(),organizationId:E.string(),userId:E.string(),role:Lt,createdAt:E.date()}),jc=E.object({id:E.string(),organizationId:E.string(),email:E.string(),role:Lt,status:qo,inviterId:E.string(),expiresAt:E.date()});import{APIError as T}from"better-call";var xt=e=>u("/organization/invite-member",{method:"POST",use:[x,B],body:Q.object({email:Q.string(),role:Q.string(),organizationId:Q.string().optional(),resend:Q.boolean().optional()})},async o=>{if(!o.context.orgOptions.sendInvitationEmail)throw o.context.logger.warn("Invitation email is not enabled. Pass `sendInvitationEmail` to the plugin options to enable it."),new T("BAD_REQUEST",{message:"Invitation email is not enabled"});let r=o.context.session,t=o.body.organizationId||r.session.activeOrganizationId;if(!t)throw new T("BAD_REQUEST",{message:"Organization not found"});let n=_(o.context,o.context.orgOptions),i=await n.findMemberByOrgId({userId:r.user.id,organizationId:t});if(!i)throw new T("BAD_REQUEST",{message:"Member not found!"});let s=o.context.roles[i.role];if(!s)throw new T("BAD_REQUEST",{message:"Role not found!"});if(s.authorize({invitation:["create"]}).error)throw new T("FORBIDDEN",{message:"You are not allowed to invite members"});if(await n.findMemberByEmail({email:o.body.email,organizationId:t}))throw new T("BAD_REQUEST",{message:"User is already a member of this organization"});if((await n.findPendingInvitation({email:o.body.email,organizationId:t})).length&&!o.body.resend)throw new T("BAD_REQUEST",{message:"User is already invited to this organization"});let l=await n.createInvitation({invitation:{role:o.body.role,email:o.body.email,organizationId:t},user:r.user}),p=await n.findOrganizationById(t);if(!p)throw new T("BAD_REQUEST",{message:"Organization not found"});return await o.context.orgOptions.sendInvitationEmail?.({id:l.id,role:l.role,email:l.email,organization:p,inviter:{...i,user:r.user}},o.request),o.json(l)}),Bt=u("/organization/accept-invitation",{method:"POST",body:Q.object({invitationId:Q.string()}),use:[x,B]},async e=>{let o=e.context.session,r=_(e.context,e.context.orgOptions),t=await r.findInvitationById(e.body.invitationId);if(!t||t.expiresAt<new Date||t.status!=="pending")throw new T("BAD_REQUEST",{message:"Invitation not found!"});if(t.email!==o.user.email)throw new T("FORBIDDEN",{message:"You are not the recipient of the invitation"});let n=await r.updateInvitation({invitationId:e.body.invitationId,status:"accepted"}),i=await r.createMember({id:L(),organizationId:t.organizationId,userId:o.user.id,role:t.role,createdAt:new Date});return await r.setActiveOrganization(o.session.id,t.organizationId),n?e.json({invitation:n,member:i}):e.json(null,{status:400,body:{message:"Invitation not found!"}})}),Dt=u("/organization/reject-invitation",{method:"POST",body:Q.object({invitationId:Q.string()}),use:[x,B]},async e=>{let o=e.context.session,r=_(e.context,e.context.orgOptions),t=await r.findInvitationById(e.body.invitationId);if(!t||t.expiresAt<new Date||t.status!=="pending")throw new T("BAD_REQUEST",{message:"Invitation not found!"});if(t.email!==o.user.email)throw new T("FORBIDDEN",{message:"You are not the recipient of the invitation"});let n=await r.updateInvitation({invitationId:e.body.invitationId,status:"rejected"});return e.json({invitation:n,member:null})}),Nt=u("/organization/cancel-invitation",{method:"POST",body:Q.object({invitationId:Q.string()}),use:[x,B]},async e=>{let o=e.context.session,r=_(e.context,e.context.orgOptions),t=await r.findInvitationById(e.body.invitationId);if(!t)throw new T("BAD_REQUEST",{message:"Invitation not found!"});let n=await r.findMemberByOrgId({userId:o.user.id,organizationId:t.organizationId});if(!n)throw new T("BAD_REQUEST",{message:"Member not found!"});if(e.context.roles[n.role].authorize({invitation:["cancel"]}).error)throw new T("FORBIDDEN",{message:"You are not allowed to cancel this invitation"});let s=await r.updateInvitation({invitationId:e.body.invitationId,status:"canceled"});return e.json(s)}),jt=u("/organization/get-invitation",{method:"GET",use:[x],requireHeaders:!0,query:Q.object({id:Q.string()})},async e=>{let o=await z(e);if(!o)throw new T("UNAUTHORIZED",{message:"Not authenticated"});let r=_(e.context,e.context.orgOptions),t=await r.findInvitationById(e.query.id);if(!t||t.status!=="pending"||t.expiresAt<new Date)throw new T("BAD_REQUEST",{message:"Invitation not found!"});if(t.email!==o.user.email)throw new T("FORBIDDEN",{message:"You are not the recipient of the invitation"});let n=await r.findOrganizationById(t.organizationId);if(!n)throw new T("BAD_REQUEST",{message:"Organization not found"});let i=await r.findMemberByOrgId({userId:t.inviterId,organizationId:t.organizationId});if(!i)throw new T("BAD_REQUEST",{message:"Inviter is no longer a member of the organization"});return e.json({...t,organizationName:n.name,organizationSlug:n.slug,inviterEmail:i.user.email})});import{z as le}from"zod";import{APIError as Ue}from"better-call";var Vt=u("/organization/remove-member",{method:"POST",body:le.object({memberIdOrEmail:le.string(),organizationId:le.string().optional()}),use:[x,B]},async e=>{let o=e.context.session,r=e.body.organizationId||o.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:"No active organization found!"}});let t=_(e.context,e.context.orgOptions),n=await t.findMemberByOrgId({userId:o.user.id,organizationId:r});if(!n)throw new Ue("BAD_REQUEST",{message:"Member not found!"});let i=e.context.roles[n.role];if(!i)throw new Ue("BAD_REQUEST",{message:"Role not found!"});let s=o.user.email===e.body.memberIdOrEmail||n.id===e.body.memberIdOrEmail;if(s&&n.role===(e.context.orgOptions?.creatorRole||"owner"))throw new Ue("BAD_REQUEST",{message:"You cannot leave the organization as the owner"});if(!(s||i.authorize({member:["delete"]}).success))throw new Ue("UNAUTHORIZED",{message:"You are not allowed to delete this member"});let c=null;if(e.body.memberIdOrEmail.includes("@")?c=await t.findMemberByEmail({email:e.body.memberIdOrEmail,organizationId:r}):c=await t.findMemberById(e.body.memberIdOrEmail),c?.organizationId!==r)throw new Ue("BAD_REQUEST",{message:"Member not found!"});return await t.deleteMember(c.id),o.user.id===c.userId&&o.session.activeOrganizationId===c.organizationId&&await t.setActiveOrganization(o.session.id,null),e.json({member:c})}),Ft=e=>u("/organization/update-member-role",{method:"POST",body:le.object({role:le.string(),memberId:le.string(),organizationId:le.string().optional()}),use:[x,B]},async o=>{let r=o.context.session,t=o.body.organizationId||r.session.activeOrganizationId;if(!t)return o.json(null,{status:400,body:{message:"No active organization found!"}});let n=_(o.context,o.context.orgOptions),i=await n.findMemberByOrgId({userId:r.user.id,organizationId:t});if(!i)return o.json(null,{status:400,body:{message:"Member not found!"}});let s=o.context.roles[i.role];if(!s)return o.json(null,{status:400,body:{message:"Role not found!"}});if(s.authorize({member:["update"]}).error||o.body.role==="owner"&&i.role!=="owner")return o.json(null,{body:{message:"You are not allowed to update this member"},status:403});let d=await n.updateMember(o.body.memberId,o.body.role);return d?o.json(d):o.json(null,{status:400,body:{message:"Member not found!"}})}),qt=u("/organization/get-active-member",{method:"GET",use:[x,B]},async e=>{let o=e.context.session,r=o.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:"No active organization found!"}});let n=await _(e.context,e.context.orgOptions).findMemberByOrgId({userId:o.user.id,organizationId:r});return n?e.json(n):e.json(null,{status:400,body:{message:"Member not found!"}})});import{z as I}from"zod";import{APIError as pe}from"better-call";var Mt=u("/organization/create",{method:"POST",body:I.object({name:I.string(),slug:I.string(),userId:I.string().optional(),logo:I.string().optional(),metadata:I.record(I.string(),I.any()).optional()}),use:[x,B]},async e=>{let o=e.context.session.user;if(!o)return e.json(null,{status:401});let r=e.context.orgOptions;if(!(typeof r?.allowUserToCreateOrganization=="function"?await r.allowUserToCreateOrganization(o):r?.allowUserToCreateOrganization===void 0?!0:r.allowUserToCreateOrganization))throw new pe("FORBIDDEN",{message:"You are not allowed to create an organization"});let n=_(e.context,r),i=await n.listOrganizations(o.id);if(typeof r.organizationLimit=="number"?i.length>=r.organizationLimit:typeof r.organizationLimit=="function"?await r.organizationLimit(o):!1)throw new pe("FORBIDDEN",{message:"You have reached the organization limit"});if(await n.findOrganizationBySlug(e.body.slug))throw new pe("BAD_REQUEST",{message:"Organization with this slug already exists"});let d=await n.createOrganization({organization:{id:L(),slug:e.body.slug,name:e.body.name,logo:e.body.logo,createdAt:new Date,metadata:e.body.metadata},user:o});return await n.setActiveOrganization(e.context.session.session.id,d.id),e.json(d)}),$t=u("/organization/update",{method:"POST",body:I.object({data:I.object({name:I.string().optional(),slug:I.string().optional(),logo:I.string().optional()}).partial(),organizationId:I.string().optional()}),requireHeaders:!0,use:[x]},async e=>{let o=await e.context.getSession(e);if(!o)throw new pe("UNAUTHORIZED",{message:"User not found"});let r=e.body.organizationId||o.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:"Organization id not found!"}});let t=_(e.context,e.context.orgOptions),n=await t.findMemberByOrgId({userId:o.user.id,organizationId:r});if(!n)return e.json(null,{status:400,body:{message:"User is not a member of this organization!"}});let i=e.context.roles[n.role];if(!i)return e.json(null,{status:400,body:{message:"Role not found!"}});if(i.authorize({organization:["update"]}).error)return e.json(null,{body:{message:"You are not allowed to update this organization"},status:403});let a=await t.updateOrganization(r,e.body.data);return e.json(a)}),Ht=u("/organization/delete",{method:"POST",body:I.object({organizationId:I.string()}),requireHeaders:!0,use:[x]},async e=>{let o=await e.context.getSession(e);if(!o)return e.json(null,{status:401});let r=e.body.organizationId;if(!r)return e.json(null,{status:400,body:{message:"Organization id not found!"}});let t=_(e.context,e.context.orgOptions),n=await t.findMemberByOrgId({userId:o.user.id,organizationId:r});if(!n)return e.json(null,{status:400,body:{message:"User is not a member of this organization!"}});let i=e.context.roles[n.role];if(!i)return e.json(null,{status:400,body:{message:"Role not found!"}});if(i.authorize({organization:["delete"]}).error)throw new pe("FORBIDDEN",{message:"You are not allowed to delete this organization"});return r===o.session.activeOrganizationId&&await t.setActiveOrganization(o.session.id,null),await t.deleteOrganization(r),e.json(r)}),Qt=u("/organization/get-full-organization",{method:"GET",query:I.optional(I.object({organizationId:I.string().optional()})),requireHeaders:!0,use:[x,B]},async e=>{let o=e.context.session,r=e.query?.organizationId||o.session.activeOrganizationId;if(!r)return e.json(null,{status:200});let n=await _(e.context,e.context.orgOptions).findFullOrganization(r);if(!n)throw new pe("BAD_REQUEST",{message:"Organization not found"});return e.json(n)}),Wt=u("/organization/set-active",{method:"POST",body:I.object({organizationId:I.string().nullable().optional()}),use:[B,x]},async e=>{let o=_(e.context,e.context.orgOptions),r=e.context.session,t=e.body.organizationId;if(t===null)return r.session.activeOrganizationId&&await o.setActiveOrganization(r.session.id,null),e.json(null);if(!t){let a=r.session.activeOrganizationId;if(!a)return e.json(null);t=a}if(!await o.findMemberByOrgId({userId:r.user.id,organizationId:t}))throw await o.setActiveOrganization(r.session.id,null),new pe("FORBIDDEN",{message:"You are not a member of this organization"});let i=await o.setActiveOrganization(r.session.id,t);await h(e,{session:i,user:r.user});let s=await o.findFullOrganization(t);return e.json(s)}),Gt=u("/organization/list",{method:"GET",use:[x,B]},async e=>{let r=await _(e.context,e.context.orgOptions).listOrganizations(e.context.session.user.id);return e.json(r)});var Mo=Fe({name:["action"]}),ku=Mo.newRole({name:["action"]}),Ou=e=>{let o={createOrganization:Mt,updateOrganization:$t,deleteOrganization:Ht,setActiveOrganization:Wt,getFullOrganization:Qt,listOrganization:Gt,createInvitation:xt(e),cancelInvitation:Nt,acceptInvitation:Bt,getInvitation:jt,rejectInvitation:Dt,removeMember:Vt,updateMemberRole:Ft(e),getActiveMember:qt},r={...zt,...e?.roles};return{id:"organization",endpoints:{...Ct(o,{orgOptions:e||{},roles:r,getSession:async n=>await z(n)}),hasPermission:u("/organization/has-permission",{method:"POST",requireHeaders:!0,body:Te.object({permission:Te.record(Te.string(),Te.array(Te.string()))}),use:[B]},async n=>{if(!n.context.session.session.activeOrganizationId)throw new Kt("BAD_REQUEST",{message:"No active organization"});let s=await _(n.context).findMemberByOrgId({userId:n.context.session.user.id,organizationId:n.context.session.session.activeOrganizationId||""});if(!s)throw new Kt("UNAUTHORIZED",{message:"You are not a member of this organization"});let d=r[s.role].authorize(n.body.permission);return d.error?n.json({error:d.error,success:!1},{status:403}):n.json({error:null,success:!0})})},schema:{session:{fields:{activeOrganizationId:{type:"string",required:!1,fieldName:e?.schema?.session?.fields?.activeOrganizationId}}},organization:{modelName:e?.schema?.organization?.modelName,fields:{name:{type:"string",required:!0,fieldName:e?.schema?.organization?.fields?.name},slug:{type:"string",unique:!0,fieldName:e?.schema?.organization?.fields?.slug},logo:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.logo},createdAt:{type:"date",required:!0,fieldName:e?.schema?.organization?.fields?.createdAt},metadata:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.metadata}}},member:{modelName:e?.schema?.member?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.member?.fields?.organizationId},userId:{type:"string",required:!0,fieldName:e?.schema?.member?.fields?.userId},role:{type:"string",required:!0,defaultValue:"member",fieldName:e?.schema?.member?.fields?.role},createdAt:{type:"date",required:!0,fieldName:e?.schema?.member?.fields?.createdAt}}},invitation:{modelName:e?.schema?.invitation?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.invitation?.fields?.organizationId},email:{type:"string",required:!0,fieldName:e?.schema?.invitation?.fields?.email},role:{type:"string",required:!1,fieldName:e?.schema?.invitation?.fields?.role},status:{type:"string",required:!0,defaultValue:"pending",fieldName:e?.schema?.invitation?.fields?.status},expiresAt:{type:"date",required:!0,fieldName:e?.schema?.invitation?.fields?.expiresAt},inviterId:{type:"string",references:{model:"user",field:"id"},fieldName:e?.schema?.invitation?.fields?.inviterId,required:!0}}}},$Infer:{Organization:{},Invitation:{},Member:{},ActiveOrganization:{}}}};import Jt from"uncrypto";function $o(e){return e.toString(2).padStart(8,"0")}function Ho(e){return[...e].map(o=>$o(o)).join("")}function Zt(e){return parseInt(Ho(e),2)}function Qo(e){if(e<0||!Number.isInteger(e))throw new Error("Argument 'max' must be an integer greater than or equal to 0");let o=(e-1).toString(2).length,r=o%8,t=new Uint8Array(Math.ceil(o/8));Jt.getRandomValues(t),r!==0&&(t[0]&=(1<<r)-1);let n=Zt(t);for(;n>=e;)Jt.getRandomValues(t),r!==0&&(t[0]&=(1<<r)-1),n=Zt(t);return n}function q(e,o){let r="";for(let t=0;t<e;t++)r+=o[Qo(o.length)];return r}function M(...e){let o=new Set(e),r="";for(let t of o)t==="a-z"?r+="abcdefghijklmnopqrstuvwxyz":t==="A-Z"?r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ":t==="0-9"?r+="0123456789":r+=t;return r}import{z as Qe}from"zod";import{xchacha20poly1305 as Xt}from"@noble/ciphers/chacha";import{bytesToHex as Wo,hexToBytes as Go,utf8ToBytes as Ko}from"@noble/ciphers/utils";import{managedNonce as er}from"@noble/ciphers/webcrypto";import{sha256 as tr}from"oslo/crypto";import Yt from"uncrypto";import{decodeHex as Su,encodeHex as Pu}from"oslo/encoding";import{scryptAsync as zu}from"@noble/hashes/scrypt";import{getRandomValues as xu}from"uncrypto";async function Se(e,o){let r=new TextEncoder,t={name:"HMAC",hash:"SHA-256"},n=await Yt.subtle.importKey("raw",r.encode(e),t,!1,["sign","verify"]),i=await Yt.subtle.sign(t.name,n,r.encode(o));return btoa(String.fromCharCode(...new Uint8Array(i)))}var ne=async({key:e,data:o})=>{let r=await tr(new TextEncoder().encode(e)),t=Ko(o),n=er(Xt)(new Uint8Array(r));return Wo(n.encrypt(t))},ce=async({key:e,data:o})=>{let r=await tr(new TextEncoder().encode(e)),t=Go(o),n=er(Xt)(new Uint8Array(r));return new TextDecoder().decode(n.decrypt(t))};import{z as ie}from"zod";import{APIError as Pe}from"better-call";var qe="two_factor";var Me="trust_device";import{z as rr}from"zod";var me=P({body:rr.object({trustDevice:rr.boolean().optional()})},async e=>{let o=await z(e);if(!o){let r=e.context.createAuthCookie(qe),t=await e.getSignedCookie(r.name,e.context.secret);if(!t)throw new Pe("UNAUTHORIZED",{message:"invalid two factor cookie"});let n=await e.context.internalAdapter.findUserById(t);if(!n)throw new Pe("UNAUTHORIZED",{message:"invalid two factor cookie"});let i=await e.context.internalAdapter.createSession(t,e.request);if(!i)throw new Pe("INTERNAL_SERVER_ERROR",{message:"failed to create session"});return{valid:async()=>{if(await h(e,{session:i,user:n}),e.body.trustDevice){let s=e.context.createAuthCookie(Me,{maxAge:2592e3}),a=await Se(e.context.secret,`${n.id}!${i.id}`);await e.setSignedCookie(s.name,`${a}!${i.id}`,e.context.secret,s.attributes)}return e.json({session:i,user:n})},invalid:async()=>{throw new Pe("UNAUTHORIZED",{message:"invalid two factor authentication"})},session:{id:i.id,userId:i.userId,expiresAt:i.expiresAt,user:n}}}return{valid:async()=>e.json({session:o,user:o.user}),invalid:async()=>{throw new Pe("UNAUTHORIZED",{message:"invalid two factor authentication"})},session:o}});import{APIError as _e}from"better-call";function Jo(e){return Array.from({length:e?.amount??10}).fill(null).map(()=>q(e?.length??10,M("a-z","0-9"))).map(o=>`${o.slice(0,5)}-${o.slice(5)}`)}async function tt(e,o){let r=e,t=o?.customBackupCodesGenerate?o.customBackupCodesGenerate():Jo(),n=await ne({data:JSON.stringify(t),key:r});return{backupCodes:t,encryptedBackupCodes:n}}async function Zo(e,o){let r=await or(e.backupCodes,o);return r?{status:r.includes(e.code),updated:r.filter(t=>t!==e.code)}:{status:!1,updated:null}}async function or(e,o){let r=Buffer.from(await ce({key:o,data:e})).toString("utf-8"),t=JSON.parse(r),n=ie.array(ie.string()).safeParse(t);return n.success?n.data:null}var nr=(e,o)=>({id:"backup_code",endpoints:{verifyBackupCode:u("/two-factor/verify-backup-code",{method:"POST",body:ie.object({code:ie.string(),disableSession:ie.boolean().optional()}),use:[me]},async r=>{let t=r.context.session.user,n=await r.context.adapter.findOne({model:o,where:[{field:"userId",value:t.id}]});if(!n)throw new _e("BAD_REQUEST",{message:"Backup codes aren't enabled"});let i=await Zo({backupCodes:n.backupCodes,code:r.body.code},r.context.secret);if(!i.status)throw new _e("UNAUTHORIZED",{message:"Invalid backup code"});let s=await ne({key:r.context.secret,data:JSON.stringify(i.updated)});return await r.context.adapter.update({model:o,update:{backupCodes:s},where:[{field:"userId",value:t.id}]}),r.body.disableSession||await h(r,{session:r.context.session,user:t}),r.json({user:t,session:r.context.session})}),generateBackupCodes:u("/two-factor/generate-backup-codes",{method:"POST",body:ie.object({password:ie.string()}),use:[b]},async r=>{let t=r.context.session.user;if(!t.twoFactorEnabled)throw new _e("BAD_REQUEST",{message:"Two factor isn't enabled"});await r.context.password.checkPassword(t.id,r);let n=await tt(r.context.secret,e);return await r.context.adapter.update({model:o,update:{backupCodes:n.encryptedBackupCodes},where:[{field:"userId",value:r.context.session.user.id}]}),r.json({status:!0,backupCodes:n.backupCodes})}),viewBackupCodes:u("/two-factor/view-backup-codes",{method:"GET",body:ie.object({userId:ie.string()}),metadata:{SERVER_ONLY:!0}},async r=>{let t=await r.context.adapter.findOne({model:o,where:[{field:"userId",value:r.body.userId}]});if(!t)throw new _e("BAD_REQUEST",{message:"Backup codes aren't enabled"});let n=await or(t.backupCodes,r.context.secret);if(!n)throw new _e("BAD_REQUEST",{message:"Backup codes aren't enabled"});return r.json({status:!0,backupCodes:n})})}});import{APIError as $e}from"better-call";import{TOTPController as Yo}from"oslo/otp";import{z as ir}from"zod";import{TimeSpan as Xo}from"oslo";var sr=(e,o)=>{let r={...e,period:new Xo(e?.period||3,"m")},t=new Yo({digits:6,period:r.period}),n=u("/two-factor/send-otp",{method:"POST",use:[me]},async s=>{if(!e||!e.sendOTP)throw s.context.logger.error("send otp isn't configured. Please configure the send otp function on otp options."),new $e("BAD_REQUEST",{message:"otp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:o,where:[{field:"userId",value:a.id}]});if(!d)throw new $e("BAD_REQUEST",{message:"OTP isn't enabled"});let c=await t.generate(Buffer.from(d.secret));return await e.sendOTP({user:a,otp:c},s.request),s.json({status:!0})}),i=u("/two-factor/verify-otp",{method:"POST",body:ir.object({code:ir.string()}),use:[me]},async s=>{let a=s.context.session.user;if(!a.twoFactorEnabled)throw new $e("BAD_REQUEST",{message:"two factor isn't enabled"});let d=await s.context.adapter.findOne({model:o,where:[{field:"userId",value:a.id}]});if(!d)throw new $e("BAD_REQUEST",{message:"OTP isn't enabled"});return await t.generate(Buffer.from(d.secret))===s.body.code?s.context.valid():s.context.invalid()});return{id:"otp",endpoints:{sendTwoFactorOTP:n,verifyTwoFactorOTP:i}}};import{APIError as ye}from"better-call";import{TimeSpan as en}from"oslo";import{TOTPController as ar,createTOTPKeyURI as tn}from"oslo/otp";import{z as He}from"zod";var dr=(e,o)=>{let r={...e,digits:6,period:new en(e?.period||30,"s")},t=u("/totp/generate",{method:"POST",use:[b]},async s=>{if(!e)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new ye("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:o,where:[{field:"userId",value:a.id}]});if(!d)throw new ye("BAD_REQUEST",{message:"totp isn't enabled"});return{code:await new ar(r).generate(Buffer.from(d.secret))}}),n=u("/two-factor/get-totp-uri",{method:"POST",use:[b],body:He.object({password:He.string()})},async s=>{if(!e)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new ye("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:o,where:[{field:"userId",value:a.id}]});if(!d||!a.twoFactorEnabled)throw new ye("BAD_REQUEST",{message:"totp isn't enabled"});return await s.context.password.checkPassword(a.id,s),{totpURI:tn(e.issuer||s.context.appName,a.email,Buffer.from(d.secret),r)}}),i=u("/two-factor/verify-totp",{method:"POST",body:He.object({code:He.string()}),use:[me]},async s=>{if(!e)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new ye("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:o,where:[{field:"userId",value:a.id}]});if(!d)throw new ye("BAD_REQUEST",{message:"totp isn't enabled"});let c=new ar(r),l=await ce({key:s.context.secret,data:d.secret}),p=Buffer.from(l);if(!await c.verify(s.body.code,p))return s.context.invalid();if(!a.twoFactorEnabled){let m=await s.context.internalAdapter.updateUser(a.id,{twoFactorEnabled:!0}),g=await s.context.internalAdapter.createSession(a.id,s.request,!1,s.context.session.session);await s.context.internalAdapter.deleteSession(s.context.session.session.id),await h(s,{session:g,user:m})}return s.context.valid()});return{id:"totp",endpoints:{generateTOTP:t,getTOTPURI:n,verifyTOTP:i}}};import{APIError as Sl}from"better-call";async function rt(e,o){let t=(await e.context.internalAdapter.findAccounts(o.userId))?.find(s=>s.providerId==="credential"),n=t?.password;return!t||!n?!1:await e.context.password.verify(n,o.password)}import{APIError as lr}from"better-call";import{createTOTPKeyURI as on}from"oslo/otp";import{TimeSpan as nn}from"oslo";import{APIError as rn}from"better-call";var be=async e=>{let o=e.context.returned;return o?o instanceof Response?o.status!==200?null:await o.clone().json():o instanceof rn?null:o:null},cr=(e,o)=>{let r=e.context.returned;return r instanceof Response?{response:new Response(JSON.stringify(o),{...r,headers:e.responseHeader,status:r.status})}:{response:o,responseHeader:e.responseHeader}};var ur={user:{fields:{twoFactorEnabled:{type:"boolean",required:!1,defaultValue:!1,input:!1}}},twoFactor:{fields:{secret:{type:"string",required:!0,returned:!1},backupCodes:{type:"string",required:!0,returned:!1},userId:{type:"string",required:!0,returned:!1,references:{model:"user",field:"id"}}}}};var Ll=(e={redirect:!0,twoFactorPage:"/"})=>({id:"two-factor",$InferServerPlugin:{},atomListeners:[{matcher:o=>o.startsWith("/two-factor/"),signal:"$sessionSignal"}],pathMethods:{"/two-factor/disable":"POST","/two-factor/enable":"POST","/two-factor/send-otp":"POST","/two-factor/generate-backup-codes":"POST"},fetchPlugins:[{id:"two-factor",name:"two-factor",hooks:{async onSuccess(o){o.data?.twoFactorRedirect&&(e.redirect||e.twoFactorPage)&&typeof window<"u"&&(window.location.href=e.twoFactorPage)}}}]});var Xl=e=>{let o={twoFactorTable:"twoFactor"},r=dr({issuer:e?.issuer,...e?.totpOptions},o.twoFactorTable),t=nr({...e?.backupCodeOptions},o.twoFactorTable),n=sr({...e?.otpOptions},o.twoFactorTable);return{id:"two-factor",endpoints:{...r.endpoints,...n.endpoints,...t.endpoints,enableTwoFactor:u("/two-factor/enable",{method:"POST",body:Qe.object({password:Qe.string().min(8)}),use:[b]},async i=>{let s=i.context.session.user,{password:a}=i.body;if(!await rt(i,{password:a,userId:s.id}))throw new lr("BAD_REQUEST",{message:"Invalid password"});let c=q(16,M("a-z","0-9","-")),l=await ne({key:i.context.secret,data:c}),p=await tt(i.context.secret,e?.backupCodeOptions);if(e?.skipVerificationOnEnable){let m=await i.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!0}),g=await i.context.internalAdapter.createSession(m.id,i.request,!1,i.context.session.session);await h(i,{session:g,user:s}),await i.context.internalAdapter.deleteSession(i.context.session.session.id)}await i.context.adapter.deleteMany({model:o.twoFactorTable,where:[{field:"userId",value:s.id}]}),await i.context.adapter.create({model:o.twoFactorTable,data:{id:i.context.uuid(),secret:l,backupCodes:p.encryptedBackupCodes,userId:s.id}});let f=on(e?.issuer||"BetterAuth",s.email,Buffer.from(c),{digits:e?.totpOptions?.digits||6,period:new nn(e?.totpOptions?.period||30,"s")});return i.json({totpURI:f,backupCodes:p.backupCodes})}),disableTwoFactor:u("/two-factor/disable",{method:"POST",body:Qe.object({password:Qe.string().min(8)}),use:[b]},async i=>{let s=i.context.session.user,{password:a}=i.body;if(!await rt(i,{password:a,userId:s.id}))throw new lr("BAD_REQUEST",{message:"Invalid password"});await i.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!1}),await i.context.adapter.delete({model:o.twoFactorTable,where:[{field:"userId",value:s.id}]});let c=await i.context.internalAdapter.createSession(s.id,i.request,!1,i.context.session.session);return await h(i,{session:c,user:s}),await i.context.internalAdapter.deleteSession(i.context.session.session.id),i.json({status:!0})})},options:e,hooks:{after:[{matcher(i){return i.path==="/sign-in/email"||i.path==="/sign-in/username"},handler:P(async i=>{let s=await be(i);if(!s||!s.user.twoFactorEnabled)return;let a=i.context.createAuthCookie(Me),d=await i.getSignedCookie(a.name,i.context.secret);if(d){let[l,p]=d.split("!"),f=await Se(i.context.secret,`${s.user.id}!${p}`);if(l===f){let m=await Se(i.context.secret,`${s.user.id}!${s.session.id}`);await i.setSignedCookie(a.name,`${m}!${s.session.id}`,i.context.secret,a.attributes);return}}D(i),await i.context.internalAdapter.deleteSession(s.session.id);let c=i.context.createAuthCookie(qe,{maxAge:60*10});return await i.setSignedCookie(c.name,s.user.id,i.context.secret,c.attributes),cr(i,{twoFactorRedirect:!0})})}]},schema:G(ur,e?.schema),rateLimit:[{pathMatcher(i){return i.startsWith("/two-factor/")},window:10,max:3}]}};import{generateAuthenticationOptions as mn,generateRegistrationOptions as fn,verifyAuthenticationResponse as gn,verifyRegistrationResponse as hn}from"@simplewebauthn/server";import{APIError as ee}from"better-call";import{z as se}from"zod";import{WebAuthnError as dn,startAuthentication as cn,startRegistration as un}from"@simplewebauthn/browser";import{createFetch as wp}from"@better-fetch/fetch";import"nanostores";import"@better-fetch/fetch";import{atom as cp}from"nanostores";import"@better-fetch/fetch";import{atom as sn,onMount as an}from"nanostores";var ot=(e,o,r,t)=>{let n=sn({data:null,error:null,isPending:!0,isRefetching:!1}),i=()=>{let a=typeof t=="function"?t({data:n.get().data,error:n.get().error,isPending:n.get().isPending}):t;return r(o,{...a,async onSuccess(d){n.set({data:d.data,error:null,isPending:!1,isRefetching:!1}),await a?.onSuccess?.(d)},async onError(d){n.set({error:d.error,data:null,isPending:!1,isRefetching:!1}),await a?.onError?.(d)},async onRequest(d){let c=n.get();n.set({isPending:c.data===null,data:c.data,error:null,isRefetching:!0}),await a?.onRequest?.(d)}})};e=Array.isArray(e)?e:[e];let s=!1;for(let a of e)a.subscribe(()=>{s?i():an(n,()=>(i(),s=!0,()=>{n.off(),a.off()}))});return n};import{atom as ln}from"nanostores";var pn=(e,{$listPasskeys:o})=>({signIn:{passkey:async(n,i)=>{let s=await e("/passkey/generate-authenticate-options",{method:"POST",body:{email:n?.email}});if(!s.data)return s;try{let a=await cn(s.data,n?.autoFill||!1),d=await e("/passkey/verify-authentication",{body:{response:a},...n?.fetchOptions,...i,method:"POST"});if(!d.data)return d}catch{return{data:null,error:{message:"auth cancelled",status:400,statusText:"BAD_REQUEST"}}}}},passkey:{addPasskey:async(n,i)=>{let s=await e("/passkey/generate-register-options",{method:"GET"});if(!s.data)return s;try{let a=await un(s.data),d=await e("/passkey/verify-registration",{...n?.fetchOptions,...i,body:{response:a,name:n?.name},method:"POST"});if(!d.data)return d;o.set(Math.random())}catch(a){return a instanceof dn?a.code==="ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED"?{data:null,error:{message:"previously registered",status:400,statusText:"BAD_REQUEST"}}:a.code==="ERROR_CEREMONY_ABORTED"?{data:null,error:{message:"registration cancelled",status:400,statusText:"BAD_REQUEST"}}:{data:null,error:{message:a.message,status:400,statusText:"BAD_REQUEST"}}:{data:null,error:{message:a instanceof Error?a.message:"unknown error",status:500,statusText:"INTERNAL_SERVER_ERROR"}}}}},$Infer:{}}),Np=()=>{let e=ln();return{id:"passkey",$InferServerPlugin:{},getActions:o=>pn(o,{$listPasskeys:e}),getAtoms(o){return{listPasskeys:ot(e,"/passkey/list-user-passkeys",o,{method:"GET"}),$listPasskeys:e}},pathMethods:{"/passkey/register":"POST","/passkey/authenticate":"POST"},atomListeners:[{matcher(o){return o==="/passkey/verify-registration"||o==="/passkey/delete-passkey"},signal:"_listPasskeys"}]}};var Yp=e=>{let o=Y.BETTER_AUTH_URL,r=e?.rpID||o?.replace("http://","").replace("https://","").split(":")[0]||"localhost";if(!r)throw new Z("passkey rpID not found. Please provide a rpID in the options or set the BETTER_AUTH_URL environment variable.");let t={origin:null,...e,rpID:r,advanced:{webAuthnChallengeCookie:"better-auth-passkey",...e?.advanced}},n=new Date(Date.now()+1e3*60*5),i=new Date,s=Math.floor((n.getTime()-i.getTime())/1e3);return{id:"passkey",endpoints:{generatePasskeyRegistrationOptions:u("/passkey/generate-register-options",{method:"GET",use:[b],metadata:{client:!1}},async a=>{let d=a.context.session,c=await a.context.adapter.findMany({model:"passkey",where:[{field:"userId",value:d.user.id}]}),l=new Uint8Array(Buffer.from(q(32,M("a-z","0-9")))),p;p=await fn({rpName:t.rpName||a.context.appName,rpID:t.rpID,userID:l,userName:d.user.email||d.user.id,attestationType:"none",excludeCredentials:c.map(m=>({id:m.id,transports:m.transports?.split(",")})),authenticatorSelection:{residentKey:"preferred",userVerification:"preferred",authenticatorAttachment:"platform"}});let f=L();return await a.setSignedCookie(t.advanced.webAuthnChallengeCookie,f,a.context.secret,{secure:!0,httpOnly:!0,sameSite:"lax",maxAge:s}),await a.context.internalAdapter.createVerificationValue({identifier:f,value:JSON.stringify({expectedChallenge:p.challenge,userData:{id:d.user.id}}),expiresAt:n}),a.json(p,{status:200})}),generatePasskeyAuthenticationOptions:u("/passkey/generate-authenticate-options",{method:"POST",body:se.object({email:se.string().optional()}).optional()},async a=>{let d=await z(a),c=[];d&&(c=await a.context.adapter.findMany({model:"passkey",where:[{field:"userId",value:d.user.id}]}));let l=await mn({rpID:t.rpID,userVerification:"preferred",...c.length?{allowCredentials:c.map(m=>({id:m.id,transports:m.transports?.split(",")}))}:{}}),p={expectedChallenge:l.challenge,userData:{id:d?.user.id||""}},f=L();return await a.setSignedCookie(t.advanced.webAuthnChallengeCookie,f,a.context.secret,{secure:!0,httpOnly:!0,sameSite:"lax",maxAge:s}),await a.context.internalAdapter.createVerificationValue({identifier:f,value:JSON.stringify(p),expiresAt:n}),a.json(l,{status:200})}),verifyPasskeyRegistration:u("/passkey/verify-registration",{method:"POST",body:se.object({response:se.any(),name:se.string().optional()}),use:[b]},async a=>{let d=e?.origin||a.headers?.get("origin")||"";if(!d)return a.json(null,{status:400});let c=a.body.response,l=await a.getSignedCookie(t.advanced.webAuthnChallengeCookie,a.context.secret);if(!l)throw new ee("BAD_REQUEST",{message:"Challenge not found"});let p=await a.context.internalAdapter.findVerificationValue(l);if(!p)return a.json(null,{status:400});let{expectedChallenge:f,userData:m}=JSON.parse(p.value);if(m.id!==a.context.session.user.id)throw new ee("UNAUTHORIZED",{message:"You are not authorized to register this passkey"});try{let g=await hn({response:c,expectedChallenge:f,expectedOrigin:d,expectedRPID:e?.rpID}),{verified:S,registrationInfo:$}=g;if(!S||!$)return a.json(null,{status:400});let{credentialID:re,credentialPublicKey:J,counter:y,credentialDeviceType:C,credentialBackedUp:ke}=$,yr=Buffer.from(J).toString("base64"),br=L(),Ar={name:a.body.name,userId:m.id,webauthnUserID:br,id:re,publicKey:yr,counter:y,deviceType:C,transports:c.response.transports.join(","),backedUp:ke,createdAt:new Date},kr=await a.context.adapter.create({model:"passkey",data:Ar});return a.json(kr,{status:200})}catch(g){throw console.log(g),new ee("INTERNAL_SERVER_ERROR",{message:"Failed to verify registration"})}}),verifyPasskeyAuthentication:u("/passkey/verify-authentication",{method:"POST",body:se.object({response:se.any()})},async a=>{let d=e?.origin||a.headers?.get("origin")||"";if(!d)throw new ee("BAD_REQUEST",{message:"origin missing"});let c=a.body.response,l=await a.getSignedCookie(t.advanced.webAuthnChallengeCookie,a.context.secret);if(!l)throw new ee("BAD_REQUEST",{message:"Challenge not found"});let p=await a.context.internalAdapter.findVerificationValue(l);if(!p)throw new ee("BAD_REQUEST",{message:"Challenge not found"});let{expectedChallenge:f}=JSON.parse(p.value),m=await a.context.adapter.findOne({model:"passkey",where:[{field:"id",value:c.id}]});if(!m)throw new ee("UNAUTHORIZED",{message:"Passkey not found"});try{let g=await gn({response:c,expectedChallenge:f,expectedOrigin:d,expectedRPID:t.rpID,authenticator:{credentialID:m.id,credentialPublicKey:new Uint8Array(Buffer.from(m.publicKey,"base64")),counter:m.counter,transports:m.transports?.split(",")}}),{verified:S}=g;if(!S)throw new ee("UNAUTHORIZED",{message:"Authentication failed"});await a.context.adapter.update({model:"passkey",where:[{field:"id",value:m.id}],update:{counter:g.authenticationInfo.newCounter}});let $=await a.context.internalAdapter.createSession(m.userId,a.request);if(!$)throw new ee("INTERNAL_SERVER_ERROR",{message:"Unable to create session"});let re=await a.context.internalAdapter.findUserById(m.userId);if(!re)throw new ee("INTERNAL_SERVER_ERROR",{message:"User not found"});return await h(a,{session:$,user:re}),a.json({session:$},{status:200})}catch(g){throw a.context.logger.error("Failed to verify authentication",g),new ee("BAD_REQUEST",{message:"Failed to verify authentication"})}}),listPasskeys:u("/passkey/list-user-passkeys",{method:"GET",use:[b]},async a=>{let d=await a.context.adapter.findMany({model:"passkey",where:[{field:"userId",value:a.context.session.user.id}]});return a.json(d,{status:200})}),deletePasskey:u("/passkey/delete-passkey",{method:"POST",body:se.object({id:se.string()}),use:[b]},async a=>(await a.context.adapter.delete({model:"passkey",where:[{field:"id",value:a.body.id}]}),a.json(null,{status:200})))},schema:G(wn,e?.schema)}},wn={passkey:{fields:{name:{type:"string",required:!1},publicKey:{type:"string",required:!0},userId:{type:"string",references:{model:"user",field:"id"},required:!0},webauthnUserID:{type:"string",required:!0},counter:{type:"number",required:!0},deviceType:{type:"string",required:!0},backedUp:{type:"boolean",required:!0},transports:{type:"string",required:!1},createdAt:{type:"date",defaultValue:new Date,required:!1}}}};import{z as We}from"zod";import{APIError as Ge}from"better-call";var pr=()=>({id:"username",endpoints:{signInUsername:u("/sign-in/username",{method:"POST",body:We.object({username:We.string(),password:We.string(),rememberMe:We.boolean().optional()})},async e=>{let o=await e.context.adapter.findOne({model:e.context.tables.user.modelName,where:[{field:"username",value:e.body.username}]});if(!o)throw await e.context.password.hash(e.body.password),e.context.logger.error("User not found",{username:pr}),new Ge("UNAUTHORIZED",{message:"Invalid username or password"});let r=await e.context.adapter.findOne({model:"account",where:[{field:e.context.tables.account.fields.userId.fieldName||"userId",value:o.id},{field:e.context.tables.account.fields.providerId.fieldName||"providerId",value:"credential"}]});if(!r)throw new Ge("UNAUTHORIZED",{message:"Invalid username or password"});let t=r?.password;if(!t)throw e.context.logger.error("Password not found",{username:pr}),new Ge("UNAUTHORIZED",{message:"Unexpected error"});if(!await e.context.password.verify(t,e.body.password))throw e.context.logger.error("Invalid password"),new Ge("UNAUTHORIZED",{message:"Invalid username or password"});let i=await e.context.internalAdapter.createSession(o.id,e.request,e.body.rememberMe===!1);return i?(await e.setSignedCookie(e.context.authCookies.sessionToken.name,i.id,e.context.secret,e.body.rememberMe===!1?{...e.context.authCookies.sessionToken.options,maxAge:void 0}:e.context.authCookies.sessionToken.options),e.json({user:o,session:i})):e.json(null,{status:500,body:{message:"Failed to create session",status:500}})})},schema:{user:{fields:{username:{type:"string",required:!1,unique:!0,returned:!0}}}}});import{serializeSigned as yn}from"better-call";var sm=()=>({id:"bearer",hooks:{before:[{matcher(e){return!!(e.request?.headers.get("authorization")||e.headers?.get("authorization"))},handler:async e=>{let o=e.request?.headers.get("authorization")?.replace("Bearer ","")||e.headers?.get("authorization")?.replace("Bearer ","");if(!o)return;let r="";return o.includes(".")?r=o:r=await yn("",o,e.context.secret),e.request&&e.request.headers.set("cookie",`${e.context.authCookies.sessionToken.name}=${r.replace("=","")}`),e.headers&&e.headers.set("cookie",`${e.context.authCookies.sessionToken.name}=${r.replace("=","")}`),{context:e}}}]}});import{z as Ae}from"zod";import{APIError as mr}from"better-call";var mm=e=>({id:"magic-link",endpoints:{signInMagicLink:u("/sign-in/magic-link",{method:"POST",requireHeaders:!0,body:Ae.object({email:Ae.string().email(),callbackURL:Ae.string().optional()})},async o=>{let{email:r}=o.body;if(e.disableSignUp&&!await o.context.internalAdapter.findUserByEmail(r))throw new mr("BAD_REQUEST",{message:"User not found"});let t=q(32,M("a-z","A-Z"));await o.context.internalAdapter.createVerificationValue({identifier:t,value:r,expiresAt:new Date(Date.now()+(e.expiresIn||60*5)*1e3)});let n=`${o.context.baseURL}/magic-link/verify?token=${t}&callbackURL=${o.body.callbackURL||"/"}`;try{await e.sendMagicLink({email:r,url:n,token:t},o.request)}catch(i){throw o.context.logger.error("Failed to send magic link",i),new mr("INTERNAL_SERVER_ERROR",{message:"Failed to send magic link"})}return o.json({status:!0})}),magicLinkVerify:u("/magic-link/verify",{method:"GET",query:Ae.object({token:Ae.string(),callbackURL:Ae.string().optional()}),requireHeaders:!0},async o=>{let{token:r,callbackURL:t}=o.query,n=t?.startsWith("http")?t:t?`${o.context.options.baseURL}${t}`:o.context.options.baseURL,i=await o.context.internalAdapter.findVerificationValue(r);if(!i)throw o.redirect(`${n}?error=INVALID_TOKEN`);if(i.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(i.id),o.redirect(`${n}?error=EXPIRED_TOKEN`);await o.context.internalAdapter.deleteVerificationValue(i.id);let s=i.value,a=await o.context.internalAdapter.findUserByEmail(s),d=a?.user.id||"";if(!a){if(e.disableSignUp)throw o.redirect(`${n}?error=USER_NOT_FOUND`);if(d=(await o.context.internalAdapter.createUser({email:s,emailVerified:!0,name:s})).id,!d)throw o.redirect(`${n}?error=USER_NOT_CREATED`)}let c=await o.context.internalAdapter.createSession(d,o.headers);if(!c)throw o.redirect(`${n}?error=SESSION_NOT_CREATED`);if(await h(o,{session:c,user:a?.user}),!t)return o.json({session:c,user:a?.user});throw o.redirect(t)})},rateLimit:[{pathMatcher(o){return o.startsWith("/sign-in/magic-link")||o.startsWith("/magic-link/verify")},window:e.rateLimit?.window||60,max:e.rateLimit?.max||5}]});import{z as te}from"zod";import{APIError as j}from"better-call";function bn(e){return q(e,M("0-9"))}var vm=e=>{let o={expiresIn:e?.expiresIn||300,otpLength:e?.otpLength||6,...e,phoneNumber:"phoneNumber",phoneNumberVerified:"phoneNumberVerified",code:"code",createdAt:"createdAt"};return{id:"phone-number",endpoints:{signInPhoneNumber:u("/sign-in/phone-number",{method:"POST",body:te.object({phoneNumber:te.string(),password:te.string(),rememberMe:te.boolean().optional()})},async r=>{let{password:t,phoneNumber:n}=r.body;if(o.phoneNumberValidator&&!await o.phoneNumberValidator(r.body.phoneNumber))throw new j("BAD_REQUEST",{message:"Invalid phone number!"});let i=await r.context.adapter.findOne({model:"user",where:[{field:"phoneNumber",value:n}]});if(!i)throw new j("UNAUTHORIZED",{message:"Invalid phone number or password"});let a=(await r.context.internalAdapter.findAccountByUserId(i.id)).find(p=>p.providerId==="credential");if(!a)throw r.context.logger.error("Credential account not found",{phoneNumber:n}),new j("UNAUTHORIZED",{message:"Invalid password or password"});let d=a?.password;if(!d)throw r.context.logger.error("Password not found",{phoneNumber:n}),new j("UNAUTHORIZED",{message:"Unexpected error"});if(!await r.context.password.verify(d,t))throw r.context.logger.error("Invalid password"),new j("UNAUTHORIZED",{message:"Invalid email or password"});let l=await r.context.internalAdapter.createSession(i.id,r.headers,r.body.rememberMe===!1);if(!l)throw r.context.logger.error("Failed to create session"),new j("UNAUTHORIZED",{message:"Failed to create session"});return await h(r,{session:l,user:i},r.body.rememberMe===!1),r.json({user:i,session:l})}),sendPhoneNumberOTP:u("/phone-number/send-otp",{method:"POST",body:te.object({phoneNumber:te.string()})},async r=>{if(!e?.sendOTP)throw r.context.logger.warn("sendOTP not implemented"),new j("NOT_IMPLEMENTED",{message:"sendOTP not implemented"});if(o.phoneNumberValidator&&!await o.phoneNumberValidator(r.body.phoneNumber))throw new j("BAD_REQUEST",{message:"Invalid phone number!"});let t=bn(o.otpLength);return await r.context.internalAdapter.createVerificationValue({value:t,identifier:r.body.phoneNumber,expiresAt:v(o.expiresIn,"sec")}),await e.sendOTP({phoneNumber:r.body.phoneNumber,code:t},r.request),r.json({code:t},{body:{message:"Code sent"}})}),verifyPhoneNumber:u("/phone-number/verify",{method:"POST",body:te.object({phoneNumber:te.string(),code:te.string(),disableSession:te.boolean().optional(),updatePhoneNumber:te.boolean().optional()})},async r=>{let t=await r.context.internalAdapter.findVerificationValue(r.body.phoneNumber);if(!t||t.expiresAt<new Date)throw t&&t.expiresAt<new Date?(await r.context.internalAdapter.deleteVerificationValue(t.id),new j("BAD_REQUEST",{message:"OTP expired"})):new j("BAD_REQUEST",{message:"OTP not found"});if(t.value!==r.body.code)throw new j("BAD_REQUEST",{message:"Invalid OTP"});if(await r.context.internalAdapter.deleteVerificationValue(t.id),r.body.updatePhoneNumber){let i=await z(r);if(!i)throw new j("UNAUTHORIZED",{message:"Session not found"});let s=await r.context.internalAdapter.updateUser(i.user.id,{[o.phoneNumber]:r.body.phoneNumber,[o.phoneNumberVerified]:!0});return r.json({user:s,session:i.session})}let n=await r.context.adapter.findOne({model:r.context.tables.user.modelName,where:[{value:r.body.phoneNumber,field:o.phoneNumber}]});if(await e?.callbackOnVerification?.({phoneNumber:r.body.phoneNumber,user:n},r.request),n)n=await r.context.internalAdapter.updateUser(n.id,{[o.phoneNumberVerified]:!0});else if(e?.signUpOnVerification){if(n=await r.context.internalAdapter.createUser({email:e.signUpOnVerification.getTempEmail(r.body.phoneNumber),name:e.signUpOnVerification.getTempName?e.signUpOnVerification.getTempName(r.body.phoneNumber):r.body.phoneNumber,[o.phoneNumber]:r.body.phoneNumber,[o.phoneNumberVerified]:!0}),!n)throw new j("INTERNAL_SERVER_ERROR",{message:"Failed to create user"})}else return r.json(null);if(!n)throw new j("INTERNAL_SERVER_ERROR",{message:"Failed to update user"});if(!r.body.disableSession){let i=await r.context.internalAdapter.createSession(n.id,r.request);if(!i)throw new j("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});return await h(r,{session:i,user:n}),r.json({user:n,session:i})}return r.json({user:n,session:null})})},schema:G(An,e?.schema)}},An={user:{fields:{phoneNumber:{type:"string",required:!1,unique:!0,returned:!0},phoneNumberVerified:{type:"boolean",required:!1,returned:!0,input:!1}}}};import"zod";var kn={user:{fields:{isAnonymous:{type:"boolean",required:!1}}}},Cm=e=>({id:"anonymous",endpoints:{signInAnonymous:u("/sign-in/anonymous",{method:"POST"},async o=>{let{emailDomainName:r=fe(o.context.baseURL)}=e||{},t=L(),n=`temp-${t}@${r}`,i=await o.context.internalAdapter.createUser({id:t,email:n,emailVerified:!1,isAnonymous:!0,name:"Anonymous",createdAt:new Date,updatedAt:new Date});if(!i)return o.json(null,{status:500,body:{message:"Failed to create user",status:500}});let s=await o.context.internalAdapter.createSession(i.id,o.request);return s?(await h(o,{session:s,user:i}),o.json({user:i,session:s})):o.json(null,{status:400,body:{message:"Could not create session"}})})},hooks:{after:[{matcher(o){return o.path?.startsWith("/sign-in")||o.path?.startsWith("/sign-up")},async handler(o){let r=o.context.returned;if(!(r instanceof Response))return;let t=r.headers.get("set-cookie"),n=o.context.authCookies.sessionToken.name,i=Be(t||"").get(n)?.value.split(".")[0];if(!i)return;let s=await z(o);if(!(!s||!s.user.isAnonymous)){if(o.path==="/sign-in/anonymous")throw new O("BAD_REQUEST",{message:"Anonymous users cannot sign in again anonymously"});if(e?.onLinkAccount){let a=await o.context.internalAdapter.findSession(i);if(!a)return;await e?.onLinkAccount?.({anonymousUser:s,newUser:a})}e?.disableDeleteAnonymousUser||await o.context.internalAdapter.deleteUser(s.user.id)}}}]},schema:G(kn,e?.schema)});import{z as w}from"zod";var qm=e=>{let o={defaultRole:"user",adminRole:"admin",...e},r=P(async t=>{let n=await z(t);if(!n?.session)throw new O("UNAUTHORIZED");let i=n.user;if(!i.role||(Array.isArray(o.adminRole)?!o.adminRole.includes(i.role):i.role!==o.adminRole))throw new O("FORBIDDEN",{message:"Only admins can access this endpoint"});return{session:{user:i,session:n.session}}});return{id:"admin",init(t){return{options:{databaseHooks:{user:{create:{async before(n){if(e?.defaultRole!==!1)return{data:{role:e?.defaultRole??"user",...n}}}}},session:{create:{async before(n){let i=await t.internalAdapter.findUserById(n.userId);if(i.banned){if(i.banExpires&&i.banExpires<Date.now()){await t.internalAdapter.updateUser(n.userId,{banned:!1,banReason:null,banExpires:null});return}return!1}}}}}}}},hooks:{after:[{matcher(t){return t.path==="/list-sessions"},handler:P(async t=>{let n=await be(t);return n?{response:n.filter(s=>!s.impersonatedBy)}:void 0})}]},endpoints:{setRole:u("/admin/set-role",{method:"POST",body:w.object({userId:w.string(),role:w.string()}),use:[r]},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{role:t.body.role});return t.json({user:n})}),createUser:u("/admin/create-user",{method:"POST",body:w.object({email:w.string(),password:w.string(),name:w.string(),role:w.string(),data:w.optional(w.record(w.any()))}),use:[r]},async t=>{if(await t.context.internalAdapter.findUserByEmail(t.body.email))throw new O("BAD_REQUEST",{message:"User already exists"});let i=await t.context.internalAdapter.createUser({email:t.body.email,name:t.body.name,role:t.body.role,...t.body.data});if(!i)throw new O("INTERNAL_SERVER_ERROR",{message:"Failed to create user"});let s=await t.context.password.hash(t.body.password);return await t.context.internalAdapter.linkAccount({accountId:i.id,providerId:"credential",password:s,userId:i.id}),t.json({user:i})}),listUsers:u("/admin/list-users",{method:"GET",use:[r],query:w.object({searchValue:w.string().optional(),searchField:w.enum(["email","name"]).optional(),searchOperator:w.enum(["contains","starts_with","ends_with"]).optional(),limit:w.string().or(w.number()).optional(),offset:w.string().or(w.number()).optional(),sortBy:w.string().optional(),sortDirection:w.enum(["asc","desc"]).optional(),filterField:w.string().optional(),filterValue:w.string().or(w.number()).or(w.boolean()).optional(),filterOperator:w.enum(["eq","ne","lt","lte","gt","gte"]).optional()})},async t=>{let n=[];t.query?.searchValue&&n.push({field:t.query.searchField||"email",operator:t.query.searchOperator||"contains",value:t.query.searchValue}),t.query?.filterValue&&n.push({field:t.query.filterField||"email",operator:t.query.filterOperator||"eq",value:t.query.filterValue});try{let i=await t.context.internalAdapter.listUsers(Number(t.query?.limit)||void 0,Number(t.query?.offset)||void 0,t.query?.sortBy?{field:t.query.sortBy,direction:t.query.sortDirection||"asc"}:void 0,n.length?n:void 0);return t.json({users:i})}catch(i){return console.log(i),t.json({users:[]})}}),listUserSessions:u("/admin/list-user-sessions",{method:"POST",use:[r],body:w.object({userId:w.string()})},async t=>({sessions:await t.context.internalAdapter.listSessions(t.body.userId)})),unbanUser:u("/admin/unban-user",{method:"POST",body:w.object({userId:w.string()}),use:[r]},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!1});return t.json({user:n})}),banUser:u("/admin/ban-user",{method:"POST",body:w.object({userId:w.string(),banReason:w.string().optional(),banExpiresIn:w.number().optional()}),use:[r]},async t=>{if(t.body.userId===t.context.session.user.id)throw new O("BAD_REQUEST",{message:"You cannot ban yourself"});let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!0,banReason:t.body.banReason||e?.defaultBanReason||"No reason",banExpires:t.body.banExpiresIn?v(t.body.banExpiresIn,"sec"):e?.defaultBanExpiresIn?v(e.defaultBanExpiresIn,"sec"):void 0});return await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({user:n})}),impersonateUser:u("/admin/impersonate-user",{method:"POST",body:w.object({userId:w.string()}),use:[r]},async t=>{let n=await t.context.internalAdapter.findUserById(t.body.userId);if(!n)throw new O("NOT_FOUND",{message:"User not found"});let i=await t.context.internalAdapter.createSession(n.id,void 0,!0,{impersonatedBy:t.context.session.user.id,expiresAt:e?.impersonationSessionDuration?v(e.impersonationSessionDuration,"sec"):v(60*60,"sec")});if(!i)throw new O("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});return await h(t,{session:i,user:n},!0),t.json({session:i,user:n})}),revokeUserSession:u("/admin/revoke-user-session",{method:"POST",body:w.object({sessionId:w.string()}),use:[r]},async t=>(await t.context.internalAdapter.deleteSession(t.body.sessionId),t.json({success:!0}))),revokeUserSessions:u("/admin/revoke-user-sessions",{method:"POST",body:w.object({userId:w.string()}),use:[r]},async t=>(await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({success:!0}))),removeUser:u("/admin/remove-user",{method:"POST",body:w.object({userId:w.string()}),use:[r]},async t=>(await t.context.internalAdapter.deleteUser(t.body.userId),t.json({success:!0})))},schema:G(On,o.schema)}},On={user:{fields:{role:{type:"string",required:!1,input:!1},banned:{type:"boolean",defaultValue:!1,required:!1,input:!1},banReason:{type:"string",required:!1,input:!1},banExpires:{type:"date",required:!1,input:!1}}},session:{fields:{impersonatedBy:{type:"string",required:!1}}}};import{z as oe}from"zod";import{APIError as Ce}from"better-call";import{betterFetch as nt}from"@better-fetch/fetch";import{parseJWT as vn}from"oslo/jwt";async function Rn(e,o,r){if(o==="oidc"&&e.idToken){let n=vn(e.idToken);if(n?.payload)return n.payload}return r?(await nt(r,{method:"GET",headers:{Authorization:`Bearer ${e.accessToken}`}})).data:null}var tf=e=>({id:"generic-oauth",endpoints:{signInWithOAuth2:u("/sign-in/oauth2",{method:"POST",query:oe.object({currentURL:oe.string().optional()}).optional(),body:oe.object({providerId:oe.string(),callbackURL:oe.string().optional(),errorCallbackURL:oe.string().optional()})},async o=>{let{providerId:r}=o.body,t=e.config.find(C=>C.providerId===r);if(!t)throw new Ce("BAD_REQUEST",{message:`No config found for provider ${r}`});let{discoveryUrl:n,authorizationUrl:i,tokenUrl:s,clientId:a,clientSecret:d,scopes:c,redirectURI:l,responseType:p,pkce:f,prompt:m,accessType:g}=t,S=i,$=s;if(n){let C=await nt(n,{onError(ke){o.context.logger.error(ke.error.message,ke.error,{discoveryUrl:n})}});C.data&&(S=C.data.authorization_endpoint,$=C.data.token_endpoint)}if(!S||!$)throw new Ce("BAD_REQUEST",{message:"Invalid OAuth configuration."});let{state:re,codeVerifier:J}=await ge(o),y=await R({id:r,options:{clientId:a,clientSecret:d,redirectURI:l},authorizationEndpoint:S,state:re,codeVerifier:f?J:void 0,scopes:c||[],redirectURI:`${o.context.baseURL}/oauth2/callback/${r}`});return p&&p!=="code"&&y.searchParams.set("response_type",p),m&&y.searchParams.set("prompt",m),g&&y.searchParams.set("access_type",g),o.json({url:y.toString(),redirect:!0})}),oAuth2Callback:u("/oauth2/callback/:providerId",{method:"GET",query:oe.object({code:oe.string().optional(),error:oe.string().optional(),state:oe.string()})},async o=>{if(o.query.error||!o.query.code)throw o.redirect(`${o.context.baseURL}?error=${o.query.error||"oAuth_code_missing"}`);let r=e.config.find(y=>y.providerId===o.params.providerId);if(!r)throw new Ce("BAD_REQUEST",{message:`No config found for provider ${o.params.providerId}`});let t,n=await De(o),{callbackURL:i,codeVerifier:s,errorURL:a}=n,d=o.query.code,c=r.tokenUrl,l=r.userInfoUrl;if(r.discoveryUrl){let y=await nt(r.discoveryUrl,{method:"GET"});y.data&&(c=y.data.token_endpoint,l=y.data.userinfo_endpoint)}try{if(!c)throw new Ce("BAD_REQUEST",{message:"Invalid OAuth configuration."});t=await k({code:d,codeVerifier:s,redirectURI:`${o.context.baseURL}/oauth2/callback/${r.providerId}`,options:{clientId:r.clientId,clientSecret:r.clientSecret},tokenEndpoint:c})}catch(y){throw o.context.logger.error(y&&typeof y=="object"&&"name"in y?y.name:"",y),o.redirect(`${a}?error=oauth_code_verification_failed`)}if(!t)throw new Ce("BAD_REQUEST",{message:"Invalid OAuth configuration."});let p=r.getUserInfo?await r.getUserInfo(t):await Rn(t,r.type||"oauth2",l),f=L(),m=St.safeParse({...p,id:f});if(!p||m.success===!1)throw o.context.logger.error("Unable to get user info",m.error),o.redirect(`${o.context.baseURL}/error?error=please_restart_the_process`);let g=await we(o,{userInfo:m.data,account:{providerId:r.providerId,accountId:p.id,accessToken:t.accessToken}});function S(y){throw o.redirect(`${a||i||`${o.context.baseURL}/error`}?error=${y}`)}if(g.error)return S(g.error.split(" ").join("_"));let{session:$,user:re}=g.data;await h(o,{session:$,user:re});let J;try{J=new URL(i).toString()}catch{J=i}throw o.redirect(J)})}});import{z as ze}from"zod";var fr={jwks:{fields:{publicKey:{type:"string",required:!0},privateKey:{type:"string",required:!0},createdAt:{type:"date",required:!0}}}},nf=ze.object({id:ze.string(),publicKey:ze.string(),privateKey:ze.string(),createdAt:ze.date()});var it=e=>({getAllKeys:async()=>await e.findMany({model:"jwks"}),getLatestKey:async()=>(await e.findMany({model:"jwks",sortBy:{field:"createdAt",direction:"desc"},limit:1}))[0],createJwk:async o=>await e.create({model:"jwks",data:{...o,createdAt:new Date}})});import{exportJWK as gr,generateKeyPair as En,importJWK as In,SignJWT as Un}from"jose";var ff=e=>({id:"jwt",endpoints:{getJwks:u("/jwks",{method:"GET"},async o=>{let t=await it(o.context.adapter).getAllKeys();return o.json({keys:t.map(n=>({...JSON.parse(n.publicKey),kid:n.id}))})}),getToken:u("/token",{method:"GET",requireHeaders:!0,use:[b]},async o=>{let r=it(o.context.adapter),t=await r.getLatestKey(),n=!e?.jwks?.disablePrivateKeyEncryption;if(t===void 0){let{publicKey:c,privateKey:l}=await En(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519"}),p=await gr(c),f=await gr(l),m=JSON.stringify(f),g={id:crypto.randomUUID(),publicKey:JSON.stringify(p),privateKey:n?JSON.stringify(await ne({key:o.context.options.secret,data:m})):m,createdAt:new Date};t=await r.createJwk(g)}let i=n?await ce({key:o.context.options.secret,data:JSON.parse(t.privateKey)}):t.privateKey,s=await In(JSON.parse(i)),a=e?.jwt?.definePayload?await e?.jwt.definePayload(o.context.session.user):o.context.session.user,d=await new Un({...a,...o.context.session.session.impersonatedBy?{impersonatedBy:o.context.session.session.impersonatedBy}:{}}).setProtectedHeader({alg:e?.jwks?.keyPairConfig?.alg??"EdDSA",kid:t.id}).setIssuedAt().setIssuer(e?.jwt?.issuer??o.context.options.baseURL).setAudience(e?.jwt?.audience??o.context.options.baseURL).setExpirationTime(e?.jwt?.expirationTime??"15m").setSubject(o.context.session.user.id).sign(s);return o.json({token:d})})},schema:G(fr,e?.schema)});import{z as Ke}from"zod";var kf=e=>{let o={maximumSessions:5,...e},r=t=>t.includes("_multi-");return{id:"multi-session",endpoints:{listDeviceSessions:u("/multi-session/list-device-sessions",{method:"GET",requireHeaders:!0},async t=>{let n=t.headers?.get("cookie");if(!n)return t.json([]);let i=Object.fromEntries(ve(n)),s=(await Promise.all(Object.entries(i).filter(([c])=>r(c)).map(async([c])=>await t.getSignedCookie(c,t.context.secret)))).filter(c=>c!==void 0);if(!s.length)return t.json([]);let d=(await t.context.internalAdapter.findSessions(s)).filter(c=>c&&c.session.expiresAt>new Date);return t.json(d)}),setActiveSession:u("/multi-session/set-active",{method:"POST",body:Ke.object({sessionId:Ke.string()}),requireHeaders:!0,use:[b]},async t=>{let n=t.body.sessionId,i=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(i,t.context.secret))throw new O("UNAUTHORIZED",{message:"Invalid session id"});let a=await t.context.internalAdapter.findSession(n);if(!a||a.session.expiresAt<new Date)throw t.setCookie(i,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),new O("UNAUTHORIZED",{message:"Invalid session id"});return await h(t,a),t.json(a)}),revokeDeviceSession:u("/multi-session/revoke",{method:"POST",body:Ke.object({sessionId:Ke.string()}),requireHeaders:!0,use:[b]},async t=>{let n=t.body.sessionId,i=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(i,t.context.secret))throw new O("UNAUTHORIZED",{message:"Invalid session id"});if(await t.context.internalAdapter.deleteSession(n),t.setCookie(i,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),!(t.context.session?.session.id===n))return t.json({success:!0});let d=t.headers?.get("cookie");if(d){let c=Object.fromEntries(ve(d)),l=(await Promise.all(Object.entries(c).filter(([f])=>r(f)).map(async([f])=>await t.getSignedCookie(f,t.context.secret)))).filter(f=>f!==void 0),p=t.context.internalAdapter;if(l.length>0){let m=(await p.findSessions(l)).filter(g=>g&&g.session.expiresAt>new Date);if(m.length>0){let g=m[0];await h(t,g)}else D(t)}else D(t)}else D(t);return t.json({success:!0})})},hooks:{after:[{matcher:()=>!0,handler:P(async t=>{if(!t.context.returned||!(t.context.returned instanceof Response))return;let n=t.context.returned.headers.get("set-cookie");if(!n)return;let i=Be(n),s=t.context.authCookies.sessionToken,a=i.get(s.name)?.value;if(!a)return;let d=ve(t.headers?.get("cookie")||""),c=a.split(".")[0],l=`${s.name}_multi-${c}`;if(i.get(l)||d.get(l)||Object.keys(Object.fromEntries(d)).filter(r).length+(n.includes("session_token")?1:0)>o.maximumSessions)return;await t.setSignedCookie(l,c,t.context.secret,s.options);let f=t.context.returned;return f.headers.append("Set-Cookie",t.responseHeader.get("set-cookie")),{response:f}})},{matcher:t=>t.path==="/sign-out",handler:P(async t=>{let n=t.headers?.get("cookie");if(!n)return;let i=Object.fromEntries(ve(n)),s=Object.keys(i).map(d=>r(d)?(t.setCookie(d,"",{maxAge:0}),d.split("_multi-")[1]):null).filter(d=>d!==null);await t.context.internalAdapter.deleteSessions(s);let a=t.context.returned;if(a instanceof Response)return console.log("response",t.responseHeader.get("set-cookie")),a.headers.append("Set-Cookie",t.responseHeader.get("set-cookie")),{response:a}})}]}}};import{z as V}from"zod";var Sf=e=>{let o={expireIn:300,otpLength:6,...e};return{id:"email-otp",endpoints:{sendVerificationOTP:u("/email-otp/send-verification-otp",{method:"POST",body:V.object({email:V.string(),type:V.enum(["email-verification","sign-in"])})},async r=>{if(!e?.sendVerificationOTP)throw r.context.logger.error("send email verification is not implemented"),new O("BAD_REQUEST",{message:"send email verification is not implemented"});let t=r.body.email,n=q(o.otpLength,M("0-9"));return await r.context.internalAdapter.createVerificationValue({value:n,identifier:`${r.body.type}-otp-${t}`,expiresAt:v(o.expireIn,"sec")}).catch(async i=>{await r.context.internalAdapter.deleteVerificationByIdentifier(`${r.body.type}-otp-${t}`),await r.context.internalAdapter.createVerificationValue({value:n,identifier:`${r.body.type}-otp-${t}`,expiresAt:v(o.expireIn,"sec")})}),await e.sendVerificationOTP({email:t,otp:n,type:r.body.type},r.request),r.json({success:!0})}),createVerificationOTP:u("/email-otp/create-verification-otp",{method:"POST",body:V.object({email:V.string(),type:V.enum(["email-verification","sign-in"])}),metadata:{SERVER_ONLY:!0}},async r=>{let t=r.body.email,n=q(o.otpLength,M("0-9"));return await r.context.internalAdapter.createVerificationValue({value:n,identifier:`${r.body.type}-otp-${t}`,expiresAt:v(o.expireIn,"sec")}),n}),getVerificationOTP:u("/email-otp/get-verification-otp",{method:"GET",query:V.object({email:V.string(),type:V.enum(["email-verification","sign-in"])}),metadata:{SERVER_ONLY:!0}},async r=>{let t=r.query.email,n=await r.context.internalAdapter.findVerificationValue(`${r.query.type}-otp-${t}`);return!n||n.expiresAt<new Date?r.json({otp:null}):r.json({otp:n.value})}),verifyEmailOTP:u("/email-otp/verify-email",{method:"POST",body:V.object({email:V.string(),otp:V.string()})},async r=>{let t=r.body.email,n=await r.context.internalAdapter.findVerificationValue(`email-verification-otp-${t}`);if(!n||n.expiresAt<new Date)throw n&&await r.context.internalAdapter.deleteVerificationValue(n.id),new O("BAD_REQUEST",{message:"Invalid OTP"});let i=r.body.otp;if(n.value!==i)throw new O("BAD_REQUEST",{message:"Invalid OTP"});await r.context.internalAdapter.deleteVerificationValue(n.id);let s=await r.context.internalAdapter.findUserByEmail(t);if(!s)throw new O("BAD_REQUEST",{message:"User not found"});let a=await r.context.internalAdapter.updateUser(s.user.id,{email:t,emailVerified:!0});return r.json({user:a})}),signInEmailOTP:u("/sign-in/email-otp",{method:"POST",body:V.object({email:V.string(),otp:V.string()})},async r=>{let t=r.body.email,n=await r.context.internalAdapter.findVerificationValue(`sign-in-otp-${t}`);if(!n||n.expiresAt<new Date)throw n&&await r.context.internalAdapter.deleteVerificationValue(n.id),new O("BAD_REQUEST",{message:"Invalid OTP"});let i=r.body.otp;if(n.value!==i)throw new O("BAD_REQUEST",{message:"Invalid OTP"});await r.context.internalAdapter.deleteVerificationValue(n.id);let s=await r.context.internalAdapter.findUserByEmail(t);if(!s){if(o.disableSignUp)throw new O("BAD_REQUEST",{message:"User not found"});let d=await r.context.internalAdapter.createUser({email:t,emailVerified:!0,name:t}),c=await r.context.internalAdapter.createSession(d.id,r.request);return await h(r,{session:c,user:d}),r.json({user:d,session:c})}let a=await r.context.internalAdapter.createSession(s.user.id,r.request);return await h(r,{session:a,user:s.user}),r.json({session:a,user:s})})},hooks:{after:[{matcher(r){return!!(r.path?.startsWith("/sign-up")&&o.sendVerificationOnSignUp)},async handler(r){let t=await be(r);if(t&&t.user.email&&t.user.emailVerified===!1){let n=q(o.otpLength,M("0-9"));await r.context.internalAdapter.createVerificationValue({value:n,identifier:`email-verification-otp-${t.user.email}`,expiresAt:v(o.expireIn,"sec")}),await e.sendVerificationOTP({email:t.user.email,otp:n,type:"email-verification"},r.request)}}}]}}};import{z as wr}from"zod";import{betterFetch as Tn}from"@better-fetch/fetch";function hr(e){return e==="true"||e===!0}var Df=e=>({id:"one-tap",endpoints:{oneTapCallback:u("/one-tap/callback",{method:"POST",body:wr.object({idToken:wr.string()})},async o=>{let{idToken:r}=o.body,{data:t,error:n}=await Tn("https://oauth2.googleapis.com/tokeninfo?id_token="+r);if(n)return o.json({error:"Invalid token"});let i=await o.context.internalAdapter.findUserByEmail(t.email);if(!i){if(e?.disableSignup)throw new O("BAD_GATEWAY",{message:"User not found"});let a=await o.context.internalAdapter.createOAuthUser({email:t.email,emailVerified:hr(t.email_verified),name:t.name,image:t.picture},{providerId:"google",accountId:t.sub});if(!a)throw new O("INTERNAL_SERVER_ERROR",{message:"Could not create user"});let d=await o.context.internalAdapter.createSession(a?.user.id,o.request);return await h(o,{user:a.user,session:d}),o.json({session:d,user:a})}let s=await o.context.internalAdapter.createSession(i.user.id,o.request);return await h(o,{user:i.user,session:s}),o.json({session:s,user:i})})}});import{z as st}from"zod";function Sn(){let e=Y.VERCEL_URL,o=Y.NETLIFY_URL,r=Y.RENDER_URL,t=Y.AWS_LAMBDA_FUNCTION_NAME,n=Y.GOOGLE_CLOUD_FUNCTION_NAME,i=Y.AZURE_FUNCTION_NAME;return e||o||r||t||n||i}var $f=e=>({id:"oauth-proxy",endpoints:{oAuthProxy:u("/oauth-proxy-callback",{method:"GET",query:st.object({callbackURL:st.string(),cookies:st.string()})},async o=>{let r=o.query.cookies,t=await ce({key:o.context.secret,data:r});throw o.setHeader("set-cookie",t),o.redirect(o.query.callbackURL)})},hooks:{after:[{matcher(o){return o.path?.startsWith("/callback")},handler:P(async o=>{let r=o.context.returned;if(!r||!(r instanceof Response))return;let t=r.headers.get("location");if(t?.includes("/oauth-proxy-callback?callbackURL")){if(!t.startsWith("http"))return;let n=new URL(t);if(n.origin===fe(o.context.baseURL)){let c=n.searchParams.get("callbackURL");return c?(r.headers.set("location",c),{response:r}):void 0}let s=r.headers.get("set-cookie");if(!s)return;let a=await ne({key:o.context.secret,data:s}),d=`${t}&cookies=${encodeURIComponent(a)}`;return r.headers.set("location",d),{response:r}}})}],before:[{matcher(o){return o.path?.startsWith("/sign-in/social")},async handler(o){let r=new URL(e?.currentURL||o.request?.url||Sn()||o.context.baseURL);return o.body.callbackURL=`${r.origin}${o.context.options.basePath||"/api/auth"}/oauth-proxy-callback?callbackURL=${encodeURIComponent(o.body.callbackURL||o.context.baseURL)}`,{context:o}}}]}});export{he as HIDE_METADATA,qm as admin,Cm as anonymous,sm as bearer,u as createAuthEndpoint,P as createAuthMiddleware,Sf as emailOTP,tf as genericOAuth,pn as getPasskeyActions,ff as jwt,mm as magicLink,kf as multiSession,$f as oAuthProxy,Df as oneTap,dt as optionsMiddleware,Ou as organization,Yp as passkey,Np as passkeyClient,vm as phoneNumber,Xl as twoFactor,Ll as twoFactorClient,pr as username};
