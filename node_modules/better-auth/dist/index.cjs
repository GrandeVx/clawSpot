"use strict";var Te=Object.defineProperty;var Rr=Object.getOwnPropertyDescriptor;var xr=Object.getOwnPropertyNames;var vr=Object.prototype.hasOwnProperty;var Ur=(e,t)=>{for(var r in t)Te(e,r,{get:t[r],enumerable:!0})},Tr=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of xr(t))!vr.call(e,n)&&n!==r&&Te(e,n,{get:()=>t[n],enumerable:!(o=Rr(t,n))||o.enumerable});return e};var Er=e=>Tr(Te({},"__esModule",{value:!0}),e);var eo={};Ur(eo,{BetterAuthError:()=>O,HIDE_METADATA:()=>G,MissingDependencyError:()=>Pe,betterAuth:()=>Xr,capitalizeFirstLetter:()=>Dr,createCookieGetter:()=>me,createLogger:()=>ne,deleteSessionCookie:()=>q,generateId:()=>C,generateState:()=>oe,getCookies:()=>Ie,levels:()=>he,logger:()=>S,parseCookies:()=>_r,parseSetCookieHeader:()=>Sr,parseState:()=>_e,setSessionCookie:()=>I,shouldPublishLog:()=>mt});module.exports=Er(eo);var M=require("better-call");var Ge=require("better-call");var H=require("better-call"),He=(0,H.createMiddleware)(async()=>({})),ce=(0,H.createMiddlewareCreator)({use:[He,(0,H.createMiddleware)(async()=>({}))]}),b=(0,H.createEndpointCreator)({use:[He]});var Ke=ce(async e=>{if(e.request?.method!=="POST")return;let{body:t,query:r,context:o}=e,n=e.headers?.get("origin")||e.headers?.get("referer")||"",i=t?.callbackURL||r?.callbackURL,d=t?.redirectTo,u=r?.currentURL,s=o.trustedOrigins,a=e.headers?.has("cookie"),c=(f,l)=>l.includes("*")?new RegExp("^"+l.replace(/\*/g,"[^/]+").replace(/\./g,"\\.")+"$").test(f):f.startsWith(l),m=(f,l)=>{if(!f)return;if(!s.some(g=>c(f,g)||f?.startsWith("/")&&l!=="origin"&&!f.includes(":")))throw e.context.logger.error(`Invalid ${l}: ${f}`),e.context.logger.info(`If it's a valid URL, please add ${f} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${s}`),new Ge.APIError("FORBIDDEN",{message:`Invalid ${l}`})};a&&!e.context.options.advanced?.disableCSRFCheck&&m(n,"origin"),i&&m(i,"callbackURL"),d&&m(d,"redirectURL"),u&&m(u,"currentURL")});var E=require("better-call"),x=require("zod");var Ze=require("oslo"),Je=require("oslo/encoding");var ue=require("oslo/crypto");function Ee(e,t){let r=new Uint8Array(e),o=new Uint8Array(t);if(r.length!==o.length)return!1;let n=0;for(let i=0;i<r.length;i++)n|=r[i]^o[i];return n===0}async function Pr({value:e,secret:t}){return new ue.HMAC("SHA-256").sign(new TextEncoder().encode(t),new TextEncoder().encode(e)).then(o=>Buffer.from(o).toString("base64"))}function Ir({value:e,signature:t,secret:r}){return new ue.HMAC("SHA-256").verify(new TextEncoder().encode(r),Buffer.from(t,"base64"),new TextEncoder().encode(e))}var le={sign:Pr,verify:Ir};var O=class extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}},Pe=class extends O{constructor(t){super(`The package "${t}" is required. Make sure it is installed.`,t)}};var _=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));var pe=Object.create(null),ee=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?pe:globalThis),L=new Proxy(pe,{get(e,t){return ee()[t]??pe[t]},has(e,t){let r=ee();return t in r||t in pe},set(e,t,r){let o=ee(!0);return o[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=ee(!0);return delete r[t],!0},ownKeys(){let e=ee(!0);return Object.keys(e)}});function Or(e){return e?e!=="false":!1}var fe=typeof process<"u"&&process.env&&process.env.NODE_ENV||"",te=fe==="production",Qe=fe==="dev"||fe==="development",We=fe==="test"||Or(L.TEST);function Sr(e){let t=new Map;return e.split(", ").forEach(o=>{let n=o.split(";").map(m=>m.trim()),[i,...d]=n,[u,...s]=i.split("="),a=s.join("=");if(!u||a===void 0){console.warn(`Malformed cookie: ${o}`);return}let c={value:a};d.forEach(m=>{let[f,...l]=m.split("="),p=l.join("="),g=f.trim().toLowerCase();switch(g){case"max-age":c["max-age"]=p?parseInt(p.trim(),10):void 0;break;case"expires":c.expires=p?new Date(p.trim()):void 0;break;case"domain":c.domain=p?p.trim():void 0;break;case"path":c.path=p?p.trim():void 0;break;case"secure":c.secure=!0;break;case"httponly":c.httponly=!0;break;case"samesite":c.samesite=p?p.trim().toLowerCase():void 0;break;default:c[g]=p?p.trim():!0;break}}),t.set(u,c)}),t}function me(e){let r=(e.advanced?.useSecureCookies!==void 0?e.advanced?.useSecureCookies:e.baseURL!==void 0?!!e.baseURL.startsWith("https://"):te)?"__Secure-":"",o=!!e.advanced?.crossSubDomainCookies?.enabled,n=o?e.advanced?.crossSubDomainCookies?.domain||(e.baseURL?new URL(e.baseURL).hostname:void 0):void 0;if(o&&!n)throw new O("baseURL is required when crossSubdomainCookies are enabled");function i(d,u={}){let s=e.advanced?.cookiePrefix||"better-auth",a=e.advanced?.cookies?.[d]?.name||`${s}.${d}`,c=e.advanced?.cookies?.[d]?.attributes;return{name:`${r}${a}`,attributes:{secure:!!r,sameSite:"lax",path:"/",httpOnly:!0,...o?{domain:n}:{},...e.advanced?.defaultCookieAttributes,...u,...c}}}return i}function Ie(e){let t=me(e),r=e.session?.expiresIn||new Ze.TimeSpan(7,"d").seconds(),o=t("session_token",{maxAge:r}),n=t("session_data",{maxAge:e.session?.cookieCache?.maxAge||60*5}),i=t("dont_remember");return{sessionToken:{name:o.name,options:o.attributes},sessionData:{name:n.name,options:n.attributes},dontRememberToken:{name:i.name,options:i.attributes}}}async function I(e,t,r,o){let n=e.context.authCookies.sessionToken.options,i=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,t.session.id,e.context.secret,{...n,maxAge:i,...o}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),e.context.options.session?.cookieCache?.enabled&&e.setCookie(e.context.authCookies.sessionData.name,JSON.stringify(Je.base64url.encode(new TextEncoder().encode(JSON.stringify({session:t,expiresAt:_(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await le.sign({value:JSON.stringify(t),secret:e.context.secret})})))),e.context.authCookies.sessionData.options),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(t.session.id,JSON.stringify({user:t.user,session:t.session}),t.session.expiresAt.getTime()-Date.now())}function q(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}function _r(e){let t=e.split("; "),r=new Map;return t.forEach(o=>{let[n,i]=o.split("=");r.set(n,i)}),r}var nt=require("@better-fetch/fetch"),it=require("better-call"),Q=require("jose"),st=require("oslo/jwt");var Ye=require("oslo/crypto"),Xe=require("oslo/encoding");async function et(e){let t=await(0,Ye.sha256)(new TextEncoder().encode(e));return Xe.base64url.encode(new Uint8Array(t),{includePadding:!1})}function tt(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?_(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function U({id:e,options:t,authorizationEndpoint:r,state:o,codeVerifier:n,scopes:i,claims:d,redirectURI:u}){let s=new URL(r);if(s.searchParams.set("response_type","code"),s.searchParams.set("client_id",t.clientId),s.searchParams.set("state",o),s.searchParams.set("scope",i.join(" ")),s.searchParams.set("redirect_uri",t.redirectURI||u),n){let a=await et(n);s.searchParams.set("code_challenge_method","S256"),s.searchParams.set("code_challenge",a)}if(d){let a=d.reduce((c,m)=>(c[m]=null,c),{});s.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...a}}))}return s}var rt=require("@better-fetch/fetch");async function R({code:e,codeVerifier:t,redirectURI:r,options:o,tokenEndpoint:n,authentication:i}){let d=new URLSearchParams,u={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(d.set("grant_type","authorization_code"),d.set("code",e),t&&d.set("code_verifier",t),d.set("redirect_uri",r),i==="basic"){let m=btoa(`${o.clientId}:${o.clientSecret}`);u.authorization=`Basic ${m}`}else d.set("client_id",o.clientId),d.set("client_secret",o.clientSecret);let{data:s,error:a}=await(0,rt.betterFetch)(n,{method:"POST",body:d,headers:u});if(a)throw a;return tt(s)}var ge=require("oslo/oauth2"),F=require("zod"),Se=require("better-call");function Lr(e){try{return new URL(e).pathname!=="/"}catch{throw new O(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function Oe(e,t="/api/auth"){return Lr(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function re(e,t){if(e)return Oe(e,t);let r=L.BETTER_AUTH_URL||L.NEXT_PUBLIC_BETTER_AUTH_URL||L.PUBLIC_BETTER_AUTH_URL||L.NUXT_PUBLIC_BETTER_AUTH_URL||L.NUXT_PUBLIC_AUTH_URL||(L.BASE_URL!=="/"?L.BASE_URL:void 0);if(r)return Oe(r,t);if(typeof window<"u"&&window.location)return Oe(window.location.origin,t)}function ot(e){try{return new URL(e).origin}catch{return null}}async function oe(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?ot(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new Se.APIError("BAD_REQUEST",{message:"callbackURL is required"});let o=(0,ge.generateCodeVerifier)(),n=(0,ge.generateState)(),i=JSON.stringify({callbackURL:r,codeVerifier:o,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,link:t,expiresAt:Date.now()+10*60*1e3}),d=new Date;d.setMinutes(d.getMinutes()+10);let u=await e.context.internalAdapter.createVerificationValue({value:i,identifier:n,expiresAt:d});if(!u)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new Se.APIError("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:u.identifier,codeVerifier:o}}async function _e(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let o=F.z.object({callbackURL:F.z.string(),codeVerifier:F.z.string(),errorURL:F.z.string().optional(),expiresAt:F.z.number(),link:F.z.object({email:F.z.string(),userId:F.z.string()}).optional()}).parse(JSON.parse(r.value));if(o.errorURL||(o.errorURL=`${e.context.baseURL}/error`),o.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),o}var at=e=>{let t="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:o,redirectURI:n}){let i=o||["email","name"];return e.scope&&i.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${n||e.redirectURI}&scope=${i.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:async({code:r,codeVerifier:o,redirectURI:n})=>R({code:r,codeVerifier:o,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:t}),async verifyIdToken(r,o){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,o);let n=(0,Q.decodeProtectedHeader)(r),{kid:i,alg:d}=n;if(!i||!d)return!1;let u=await Cr(i),{payload:s}=await(0,Q.jwtVerify)(r,u,{algorithms:[d],issuer:"https://appleid.apple.com",audience:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(a=>{s[a]!==void 0&&(s[a]=!!s[a])}),o&&s.nonce!==o?!1:!!s},async getUserInfo(r){if(!r.idToken)return null;let o=(0,st.parseJWT)(r.idToken)?.payload;if(!o)return null;let n=o.user?`${o.user.name.firstName} ${o.user.name.lastName}`:o.email;return{user:{id:o.sub,name:n,emailVerified:!1,email:o.email},data:o}}}},Cr=async e=>{let t="https://appleid.apple.com",r="/auth/keys",{data:o}=await(0,nt.betterFetch)(`${t}${r}`);if(!o?.keys)throw new it.APIError("BAD_REQUEST",{message:"Keys not found"});let n=o.keys.find(i=>i.kid===e);if(!n)throw new Error(`JWK with kid ${e} not found`);return await(0,Q.importJWK)(n,n.alg)};var dt=require("@better-fetch/fetch");var ct=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let n=r||["identify","email"];return e.scope&&n.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${n.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||o)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>R({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){let{data:r,error:o}=await(0,dt.betterFetch)("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(o)return null;if(r.avatar===null){let n=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${n}.png`}else{let n=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${n}`}return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url},data:r}}});var ut=require("@better-fetch/fetch");var lt=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let n=r||["email","public_profile"];return e.scope&&n.push(...e.scope),await U({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:n,state:t,redirectURI:o})},validateAuthorizationCode:async({code:t,redirectURI:r})=>R({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async getUserInfo(t){let{data:r,error:o}=await(0,ut.betterFetch)("https://graph.facebook.com/me?fields=id,name,email,picture",{auth:{type:"Bearer",token:t.accessToken}});return o?null:{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified},data:r}}});var Le=require("@better-fetch/fetch");var pt=e=>{let t="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:o,codeVerifier:n,redirectURI:i}){let d=o||["user:email"];return e.scope&&d.push(...e.scope),U({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:d,state:r,redirectURI:i})},validateAuthorizationCode:async({code:r,redirectURI:o})=>R({code:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:t}),async getUserInfo(r){let{data:o,error:n}=await(0,Le.betterFetch)("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(n)return null;let i=!1;if(!o.email){let{data:d,error:u}=await(0,Le.betterFetch)("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});u||(o.email=(d.find(s=>s.primary)??d[0])?.email,i=d.find(s=>s.email===o.email)?.verified??!1)}return{user:{id:o.id.toString(),name:o.name||o.login,email:o.email,image:o.avatar_url,emailVerified:i},data:o}}}};var gt=require("oslo/jwt");var ft=require("consola"),he=["info","success","warn","error","debug"];function mt(e,t){return he.indexOf(t)<=he.indexOf(e)}var Br=(0,ft.createConsola)({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),ne=e=>{let t=e?.disabled!==!0,r=e?.level??"error",o=(n,i,d=[])=>{if(!(!t||!mt(r,n))){if(!e||typeof e.log!="function"){Br[n]("",i,...d);return}e.log(n==="success"?"info":n,i,d)}};return Object.fromEntries(he.map(n=>[n,(...[i,...d])=>o(n,i,d)]))},S=ne();var ht=require("@better-fetch/fetch"),yt=e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:n}){if(!e.clientId||!e.clientSecret)throw S.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new O("CLIENT_ID_AND_SECRET_REQUIRED");if(!o)throw new O("codeVerifier is required for Google");let i=r||["email","profile","openid"];e.scope&&i.push(...e.scope);let d=await U({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:i,state:t,codeVerifier:o,redirectURI:n});return e.accessType&&d.searchParams.set("access_type",e.accessType),e.prompt&&d.searchParams.set("prompt",e.prompt),d},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>R({code:t,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let o=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${t}`,{data:n}=await(0,ht.betterFetch)(o);return n?n.aud===e.clientId&&n.iss==="https://accounts.google.com":!1},async getUserInfo(t){if(!t.idToken)return null;let r=(0,gt.parseJWT)(t.idToken)?.payload;return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified},data:r}}});var wt=require("@better-fetch/fetch"),bt=require("oslo/jwt");var At=e=>{let t=e.tenantId||"common",r=`https://login.microsoftonline.com/${t}/oauth2/v2.0/authorize`,o=`https://login.microsoftonline.com/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(n){let i=n.scopes||["openid","profile","email","User.Read"];return e.scope&&i.push(...e.scope),U({id:"microsoft",options:e,authorizationEndpoint:r,state:n.state,codeVerifier:n.codeVerifier,scopes:i,redirectURI:n.redirectURI})},validateAuthorizationCode({code:n,codeVerifier:i,redirectURI:d}){return R({code:n,codeVerifier:i,redirectURI:e.redirectURI||d,options:e,tokenEndpoint:o})},async getUserInfo(n){if(!n.idToken)return null;let i=(0,bt.parseJWT)(n.idToken)?.payload,d=e.profilePhotoSize||48;return await(0,wt.betterFetch)(`https://graph.microsoft.com/v1.0/me/photos/${d}x${d}/$value`,{headers:{Authorization:`Bearer ${n.accessToken}`},async onResponse(u){if(!(e.disableProfilePhoto||!u.response.ok))try{let a=await u.response.clone().arrayBuffer(),c=Buffer.from(a).toString("base64");i.picture=`data:image/jpeg;base64, ${c}`}catch(s){S.error(s&&typeof s=="object"&&"name"in s?s.name:"",s)}}}),{user:{id:i.sub,name:i.name,email:i.email,image:i.picture,emailVerified:!0},data:i}}}};var kt=require("@better-fetch/fetch");var Rt=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:n}){let i=r||["user-read-email"];return e.scope&&i.push(...e.scope),U({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:i,state:t,codeVerifier:o,redirectURI:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>R({code:t,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){let{data:r,error:o}=await(0,kt.betterFetch)("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});return o?null:{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1},data:r}}});function Dr(e){return e.charAt(0).toUpperCase()+e.slice(1)}var G={isAction:!1};var xt=require("nanoid"),C=e=>(0,xt.nanoid)(e);var vt=require("oslo/jwt");var Ut=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let n=r||["user:read:email","openid"];return e.scope&&n.push(...e.scope),U({id:"twitch",redirectURI:o,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:n,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>R({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){let r=t.idToken;if(!r)return S.error("No idToken found in token"),null;let o=(0,vt.parseJWT)(r)?.payload;return{user:{id:o.sub,name:o.preferred_username,email:o.email,image:o.picture,emailVerified:!1},data:o}}});var Tt=require("@better-fetch/fetch");var Et=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){let r=t.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),U({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>R({code:t,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){let{data:r,error:o}=await(0,Tt.betterFetch)("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});return o?null:{user:{id:r.data.id,name:r.data.name,email:r.data.email||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1},data:r}}});var Pt=require("@better-fetch/fetch");var It=e=>{let t="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:o,codeVerifier:n,redirectURI:i})=>{let d=o||["account_info.read"];return e.scope&&d.push(...e.scope),await U({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:d,state:r,redirectURI:i,codeVerifier:n})},validateAuthorizationCode:async({code:r,codeVerifier:o,redirectURI:n})=>await R({code:r,codeVerifier:o,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:t}),async getUserInfo(r){let{data:o,error:n}=await(0,Pt.betterFetch)("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});return n?null:{user:{id:o.account_id,name:o.name?.display_name,email:o.email,emailVerified:o.email_verified||!1,image:o.profile_photo_url},data:o}}}};var Ot=require("@better-fetch/fetch");var St=e=>{let t="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:o,scopes:n,redirectURI:i})=>{let d=n||["profile","email","openid"];return e.scope&&d.push(...e.scope),await U({id:"linkedin",options:e,authorizationEndpoint:t,scopes:d,state:o,redirectURI:i})},validateAuthorizationCode:async({code:o,redirectURI:n})=>await R({code:o,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:r}),async getUserInfo(o){let{data:n,error:i}=await(0,Ot.betterFetch)("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});return i?null:{user:{id:n.sub,name:n.name,email:n.email,emailVerified:n.email_verified||!1,image:n.picture},data:n}}}};var _t=require("@better-fetch/fetch");var Ce=(e="")=>e.split("://").map(t=>t.replace(/\/{2,}/g,"/")).join("://"),Nr=e=>{let t=e||"https://gitlab.com";return{authorizationEndpoint:Ce(`${t}/oauth/authorize`),tokenEndpoint:Ce(`${t}/oauth/token`),userinfoEndpoint:Ce(`${t}/api/v4/user`)}},Lt=e=>{let{authorizationEndpoint:t,tokenEndpoint:r,userinfoEndpoint:o}=Nr(e.issuer),n="gitlab";return{id:n,name:"Gitlab",createAuthorizationURL:async({state:d,scopes:u,codeVerifier:s,redirectURI:a})=>{let c=u||["read_user"];return e.scope&&c.push(...e.scope),await U({id:n,options:e,authorizationEndpoint:t,scopes:c,state:d,redirectURI:a,codeVerifier:s})},validateAuthorizationCode:async({code:d,redirectURI:u,codeVerifier:s})=>R({code:d,redirectURI:e.redirectURI||u,options:e,codeVerifier:s,tokenEndpoint:r}),async getUserInfo(d){let{data:u,error:s}=await(0,_t.betterFetch)(o,{headers:{authorization:`Bearer ${d.accessToken}`}});return s||u.state!=="active"||u.locked?null:{user:{id:u.id.toString(),name:u.name??u.username,email:u.email,image:u.avatar_url,emailVerified:!0},data:u}}}};var Be={apple:at,discord:ct,facebook:lt,github:pt,microsoft:At,google:yt,spotify:Rt,twitch:Ut,twitter:Et,dropbox:It,linkedin:St,gitlab:Lt},ye=Object.keys(Be);var qt=require("oslo"),be=require("oslo/jwt"),N=require("zod");var ie=require("better-call");var z=require("better-call");var Z=require("zod");function W(e){try{return JSON.parse(e)}catch{return null}}var De=()=>b("/get-session",{method:"GET",query:Z.z.optional(Z.z.object({disableCookieCache:Z.z.boolean().optional()})),requireHeaders:!0},async e=>{try{let t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return e.json(null);let r=e.getCookie(e.context.authCookies.sessionData.name),o=r?W(Buffer.from(r,"base64").toString()):null;if(o&&!await le.verify({value:JSON.stringify(o.session),signature:o?.signature,secret:e.context.secret}))return q(e),e.json(null);let n=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(o?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let c=o.session;if(o.expiresAt<Date.now()||c.session.expiresAt<new Date){let f=e.context.authCookies.sessionData.name;e.setCookie(f,"",{maxAge:0})}else return e.json(c)}let i=await e.context.internalAdapter.findSession(t);if(!i||i.session.expiresAt<new Date)return q(e),i&&await e.context.internalAdapter.deleteSession(i.session.id),e.json(null);if(n)return e.json(i);let d=e.context.sessionConfig.expiresIn,u=e.context.sessionConfig.updateAge;if(i.session.expiresAt.valueOf()-d*1e3+u*1e3<=Date.now()){let c=await e.context.internalAdapter.updateSession(i.session.id,{expiresAt:_(e.context.sessionConfig.expiresIn,"sec")});if(!c)return q(e),e.json(null,{status:401});let m=(c.expiresAt.valueOf()-Date.now())/1e3;return await I(e,{session:c,user:i.user},!1,{maxAge:m}),e.json({session:c,user:i.user})}return e.json(i)}catch(t){throw e.context.logger.error("INTERNAL_SERVER_ERROR",t),new z.APIError("INTERNAL_SERVER_ERROR",{message:"internal server error"})}}),we=async e=>{if(e.context.session)return e.context.session;let t=await De()({...e,_flag:"json",headers:e.headers});return e.context.session=t,t},B=ce(async e=>{let t=await we(e);if(!t?.session)throw new z.APIError("UNAUTHORIZED");return{session:t}}),Ct=()=>b("/list-sessions",{method:"GET",use:[B],requireHeaders:!0},async e=>{let r=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(o=>o.expiresAt>new Date);return e.json(r)}),Bt=b("/revoke-session",{method:"POST",body:Z.z.object({id:Z.z.string()}),use:[B],requireHeaders:!0},async e=>{let t=e.body.id,r=await e.context.internalAdapter.findSession(t);if(!r)throw new z.APIError("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new z.APIError("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(t)}catch(o){throw e.context.logger.error(o&&typeof o=="object"&&"name"in o?o.name:"",o),new z.APIError("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),Dt=b("/revoke-sessions",{method:"POST",use:[B],requireHeaders:!0},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){throw e.context.logger.error(t&&typeof t=="object"&&"name"in t?t.name:"",t),new z.APIError("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),Nt=b("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[B]},async e=>{let t=e.context.session;if(!t.user)throw new z.APIError("UNAUTHORIZED");let n=(await e.context.internalAdapter.listSessions(t.user.id)).filter(i=>i.expiresAt>new Date).filter(i=>i.id!==e.context.session.session.id);return await Promise.all(n.map(i=>e.context.internalAdapter.deleteSession(i.id))),e.json({status:!0})});async function $(e,t,r){return await(0,be.createJWT)("HS256",Buffer.from(e),{email:t.toLowerCase(),updateTo:r},{expiresIn:new qt.TimeSpan(1,"h"),issuer:"better-auth",subject:"verify-email",audiences:[t],includeIssuedTimestamp:!0})}var Vt=b("/send-verification-email",{method:"POST",query:N.z.object({currentURL:N.z.string().optional()}).optional(),body:N.z.object({email:N.z.string().email(),callbackURL:N.z.string().optional()})},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new ie.APIError("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:t}=e.body,r=await e.context.internalAdapter.findUserByEmail(t);if(!r)throw new ie.APIError("BAD_REQUEST",{message:"User not found"});let o=await $(e.context.secret,t),n=`${e.context.baseURL}/verify-email?token=${o}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.emailVerification.sendVerificationEmail({user:r.user,url:n,token:o},e.request),e.json({status:!0})}),Ft=b("/verify-email",{method:"GET",query:N.z.object({token:N.z.string(),callbackURL:N.z.string().optional()})},async e=>{function t(u){throw e.query.callbackURL?e.redirect(`${e.query.callbackURL}?error=${u}`):new ie.APIError("UNAUTHORIZED",{message:u})}let{token:r}=e.query,o;try{o=await(0,be.validateJWT)("HS256",Buffer.from(e.context.secret),r)}catch(u){return e.context.logger.error("Failed to verify email",u),t("invalid_token")}let i=N.z.object({email:N.z.string().email(),updateTo:N.z.string().optional()}).parse(o.payload),d=await e.context.internalAdapter.findUserByEmail(i.email);if(!d)return t("user_not_found");if(i.updateTo){let u=await we(e);if(!u){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return t("unauthorized")}if(u.user.email!==i.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return t("unauthorized")}let s=await e.context.internalAdapter.updateUserByEmail(i.email,{email:i.updateTo});if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:s,url:`${e.context.baseURL}/verify-email?token=${r}`,token:r},e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({user:s,status:!0})}if(await e.context.internalAdapter.updateUserByEmail(i.email,{emailVerified:!0}),e.context.options.emailVerification?.autoSignInAfterVerification&&!await we(e)){let s=await e.context.internalAdapter.createSession(d.user.id,e.request);if(!s)throw new ie.APIError("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await I(e,{session:s,user:d.user})}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({user:null,status:!0})});async function Ae(e,{userInfo:t,account:r,callbackURL:o}){let n=await e.context.internalAdapter.findUserByEmail(t.email.toLowerCase(),{includeAccounts:!0}).catch(u=>{throw S.error(`Better auth was unable to query your database.
Error: `,u),e.redirect(`${e.context.baseURL}/error?error=internal_server_error`)}),i=n?.user;if(n){let u=n.accounts.find(s=>s.providerId===r.providerId);if(u)await e.context.internalAdapter.updateAccount(u.id,{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,expiresAt:r.expiresAt});else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!t.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return Qe&&S.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:t.id.toString(),id:e.context.uuid(),userId:n.user.id,accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,expiresAt:r.expiresAt})}catch(c){return S.error("Unable to link account",c),{error:"unable to link account",data:null}}}}else try{let u=t.emailVerified||!1;if(i=await e.context.internalAdapter.createOAuthUser({...t,id:e.context.uuid(),emailVerified:u,email:t.email.toLowerCase()},{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,expiresAt:r.expiresAt,providerId:r.providerId,accountId:t.id.toString()}).then(s=>s?.user),!u&&i&&e.context.options.emailVerification?.sendOnSignUp){let s=await $(e.context.secret,i.email),a=`${e.context.baseURL}/verify-email?token=${s}&callbackURL=${o}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:i,url:a,token:s},e.request)}}catch(u){return S.error("Unable to create user",u),{error:"unable to create user",data:null}}if(!i)return{error:"unable to create user",data:null};let d=await e.context.internalAdapter.createSession(i.id,e.request);return d?{data:{session:d,user:i},error:null}:{error:"unable to create session",data:null}}var $t=b("/sign-in/social",{method:"POST",query:x.z.object({currentURL:x.z.string().optional()}).optional(),body:x.z.object({callbackURL:x.z.string().optional(),errorCallbackURL:x.z.string().optional(),provider:x.z.enum(ye),disableRedirect:x.z.boolean().optional(),idToken:x.z.optional(x.z.object({token:x.z.string(),nonce:x.z.string().optional(),accessToken:x.z.string().optional(),refreshToken:x.z.string().optional(),expiresAt:x.z.number().optional()}))})},async e=>{let t=e.context.socialProviders.find(i=>i.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new E.APIError("NOT_FOUND",{message:"Provider not found"});if(e.body.idToken){if(!t.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new E.APIError("NOT_FOUND",{message:"Provider does not support id token verification"});let{token:i,nonce:d}=e.body.idToken;if(!await t.verifyIdToken(i,d))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new E.APIError("UNAUTHORIZED",{message:"Invalid id token"});let s=await t.getUserInfo({idToken:i,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!s||!s?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new E.APIError("UNAUTHORIZED",{message:"Failed to get user info"});if(!s.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new E.APIError("UNAUTHORIZED",{message:"User email not found"});let a=await Ae(e,{userInfo:{email:s.user.email,id:s.user.id,name:s.user.name||"",image:s.user.image,emailVerified:s.user.emailVerified||!1},account:{providerId:t.id,accountId:s.user.id,accessToken:e.body.idToken.accessToken}});if(a.error)throw new E.APIError("UNAUTHORIZED",{message:a.error});return await I(e,a.data),e.json({session:a.data.session,user:a.data.user,url:`${e.body.callbackURL||e.query?.currentURL||e.context.options.baseURL}`,redirect:!0})}let{codeVerifier:r,state:o}=await oe(e),n=await t.createAuthorizationURL({state:o,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${t.id}`});return e.json({url:n.toString(),redirect:!e.body.disableRedirect})}),jt=b("/sign-in/email",{method:"POST",body:x.z.object({email:x.z.string(),password:x.z.string(),callbackURL:x.z.string().optional(),rememberMe:x.z.boolean().default(!0).optional()})},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new E.APIError("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:t,password:r}=e.body;if(!x.z.string().email().safeParse(t).success)throw new E.APIError("BAD_REQUEST",{message:"Invalid email"});let n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:t}),new E.APIError("UNAUTHORIZED",{message:"Invalid email or password"});let i=n.accounts.find(a=>a.providerId==="credential");if(!i)throw e.context.logger.error("Credential account not found",{email:t}),new E.APIError("UNAUTHORIZED",{message:"Invalid email or password"});let d=i?.password;if(!d)throw e.context.logger.error("Password not found",{email:t}),new E.APIError("UNAUTHORIZED",{message:"Unexpected error"});if(!await e.context.password.verify(d,r))throw e.context.logger.error("Invalid password"),new E.APIError("UNAUTHORIZED",{message:"Invalid email or password"});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!n.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Email verification is required but no email verification handler is provided"),new E.APIError("INTERNAL_SERVER_ERROR",{message:"Email is not verified."});let a=await $(e.context.secret,n.user.email),c=`${e.context.baseURL}/verify-email?token=${a}&callbackURL=${e.body.callbackURL||"/"}`;throw await e.context.options.emailVerification.sendVerificationEmail({user:n.user,url:c,token:a},e.request),e.context.logger.error("Email not verified",{email:t}),new E.APIError("FORBIDDEN",{message:"Email is not verified. Check your email for a verification link"})}let s=await e.context.internalAdapter.createSession(n.user.id,e.headers,e.body.rememberMe===!1);if(!s)throw e.context.logger.error("Failed to create session"),new E.APIError("UNAUTHORIZED",{message:"Failed to create session"});return await I(e,{session:s,user:n.user},e.body.rememberMe===!1),e.json({user:n.user,session:s,redirect:!!e.body.callbackURL,url:e.body.callbackURL})});var J=require("zod");var ke=J.z.object({code:J.z.string().optional(),error:J.z.string().optional(),errorMessage:J.z.string().optional(),state:J.z.string().optional()}),zt=b("/callback/:id",{method:["GET","POST"],body:ke.optional(),query:ke.optional(),metadata:G},async e=>{let t;try{if(e.method==="GET")t=ke.parse(e.query);else if(e.method==="POST")t=ke.parse(e.body);else throw new Error("Unsupported method")}catch(w){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",w),e.redirect(`${e.context.baseURL}/error?error=invalid_callback_request`)}let{code:r,error:o,state:n}=t;if(!n)throw e.context.logger.error("State not found"),e.redirect(`${e.context.baseURL}/error?error=state_not_found`);if(!r)throw e.context.logger.error("Code not found"),e.redirect(`${e.context.baseURL}/error?error=${o||"no_code"}`);let i=e.context.socialProviders.find(w=>w.id===e.params.id);if(!i)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let{codeVerifier:d,callbackURL:u,link:s,errorURL:a}=await _e(e),c;try{c=await i.validateAuthorizationCode({code:r,codeVerifier:d,redirectURI:`${e.context.baseURL}/callback/${i.id}`})}catch(w){throw e.context.logger.error("",w),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`)}let m=await i.getUserInfo(c).then(w=>w?.user),l={id:C(),...m};function p(w){let v=a||u||`${e.context.baseURL}/error`;throw v.includes("?")?v=`${v}&error=${w}`:v=`${v}?error=${w}`,e.redirect(v)}if(!m)return e.context.logger.error("Unable to get user info"),p("unable_to_get_user_info");if(!l.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),p("email_not_found");if(!u)throw e.context.logger.error("No callback URL found"),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);if(s){if(s.email!==l.email.toLowerCase())return p("email_doesn't_match");if(!await e.context.internalAdapter.createAccount({userId:s.userId,providerId:i.id,accountId:m.id}))return p("unable_to_link_account");let v;try{v=new URL(u).toString()}catch{v=u}throw e.redirect(v)}let g=await Ae(e,{userInfo:{email:l.email,id:l.id,name:l.name||"",image:l.image,emailVerified:l.emailVerified||!1},account:{providerId:i.id,accountId:m.id,accessToken:c.accessToken,refreshToken:c.refreshToken,expiresAt:c.accessTokenExpiresAt},callbackURL:u});if(g.error)return e.context.logger.error(g.error.split(" ").join("_")),p(g.error.split(" ").join("_"));let{session:y,user:h}=g.data;await I(e,{session:y,user:h});let A;try{A=new URL(u).toString()}catch{A=u}throw e.redirect(A)});var xi=require("zod");var Mt=require("better-call"),Ht=b("/sign-out",{method:"POST",requireHeaders:!0},async e=>{let t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)throw q(e),new Mt.APIError("BAD_REQUEST",{message:"Session not found"});return await e.context.internalAdapter.deleteSession(t),q(e),e.json({success:!0})});var D=require("zod");var Re=require("better-call");function Gt(e,t,r){let o=t?new URL(t,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([n,i])=>o.searchParams.set(n,i)),o.href}function qr(e,t,r){let o=new URL(t,e.baseURL);return r&&Object.entries(r).forEach(([n,i])=>o.searchParams.set(n,i)),o.href}var Kt=b("/forget-password",{method:"POST",body:D.z.object({email:D.z.string().email(),redirectTo:D.z.string()})},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function in your auth config!"),new Re.APIError("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:t,redirectTo:r}=e.body,o=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!o)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!1},{body:{status:!0}});let n=60*60*1,i=_(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||n,"sec"),d=e.context.uuid();await e.context.internalAdapter.createVerificationValue({value:o.user.id,identifier:`reset-password:${d}`,expiresAt:i});let u=`${e.context.baseURL}/reset-password/${d}?callbackURL=${r}`;return await e.context.options.emailAndPassword.sendResetPassword({user:o.user,url:u,token:d},e.request),e.json({status:!0})}),Qt=b("/reset-password/:token",{method:"GET",query:D.z.object({callbackURL:D.z.string()})},async e=>{let{token:t}=e.params,{callbackURL:r}=e.query;if(!t||!r)throw e.redirect(Gt(e.context,r,{error:"INVALID_TOKEN"}));let o=await e.context.internalAdapter.findVerificationValue(`reset-password:${t}`);throw!o||o.expiresAt<new Date?e.redirect(Gt(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(qr(e.context,r,{token:t}))}),Wt=b("/reset-password",{query:D.z.optional(D.z.object({token:D.z.string().optional(),currentURL:D.z.string().optional()})),method:"POST",body:D.z.object({newPassword:D.z.string(),token:D.z.string().optional()})},async e=>{let t=e.body.token||e.query?.token||(e.query?.currentURL?new URL(e.query.currentURL).searchParams.get("token"):"");if(!t)throw new Re.APIError("BAD_REQUEST",{message:"Token not found"});let{newPassword:r}=e.body,o=`reset-password:${t}`,n=await e.context.internalAdapter.findVerificationValue(o);if(!n||n.expiresAt<new Date)throw new Re.APIError("BAD_REQUEST",{message:"Invalid token"});await e.context.internalAdapter.deleteVerificationValue(n.id);let i=n.value,d=await e.context.password.hash(r);return(await e.context.internalAdapter.findAccounts(i)).find(a=>a.providerId==="credential")?(await e.context.internalAdapter.updatePassword(i,d),e.json({status:!0})):(await e.context.internalAdapter.createAccount({userId:i,providerId:"credential",password:d,accountId:e.context.uuid()}),e.json({status:!0}))});var T=require("zod");var P=require("better-call");var k=require("zod"),Si=k.z.object({id:k.z.string(),providerId:k.z.string(),accountId:k.z.string(),userId:k.z.string(),accessToken:k.z.string().nullish(),refreshToken:k.z.string().nullish(),idToken:k.z.string().nullish(),expiresAt:k.z.date().nullish(),password:k.z.string().nullish()}),_i=k.z.object({id:k.z.string(),email:k.z.string().transform(e=>e.toLowerCase()),emailVerified:k.z.boolean().default(!1),name:k.z.string(),image:k.z.string().nullish(),createdAt:k.z.date().default(new Date),updatedAt:k.z.date().default(new Date)}),Li=k.z.object({id:k.z.string(),userId:k.z.string(),expiresAt:k.z.date(),ipAddress:k.z.string().nullish(),userAgent:k.z.string().nullish()}),Ci=k.z.object({id:k.z.string(),value:k.z.string(),createdAt:k.z.date(),expiresAt:k.z.date(),identifier:k.z.string()});function Zt(e,t){let r=t.fields,o={};for(let n in e){let i=r[n];if(!i){o[n]=e[n];continue}i.returned!==!1&&(o[n]=e[n])}return o}function Ne(e,t){let r={...t==="user"?e.user?.additionalFields:{},...t==="session"?e.session?.additionalFields:{}};for(let o of e.plugins||[])o.schema&&o.schema[t]&&(r={...r,...o.schema[t].fields});return r}function qe(e,t){let r=Ne(e,"user");return Zt(t,{fields:r})}function xe(e,t){let r=Ne(e,"session");return Zt(t,{fields:r})}function Vr(e,t){let r=t.action||"create",o=t.fields,n={};for(let i in o){if(i in e){if(o[i].input===!1){if(o[i].defaultValue){n[i]=o[i].defaultValue;continue}continue}n[i]=e[i];continue}if(o[i].defaultValue&&r==="create"){n[i]=o[i].defaultValue;continue}}return n}function ve(e,t,r){let o=Ne(e,"user");return Vr(t||{},{fields:o,action:r})}var Jt=()=>b("/update-user",{method:"POST",body:T.z.record(T.z.string(),T.z.any()),use:[B]},async e=>{let t=e.body;if(t.email)throw new P.APIError("BAD_REQUEST",{message:"You can't update email"});let{name:r,image:o,...n}=t,i=e.context.session;if(!o&&!r&&Object.keys(n).length===0)return e.json({user:i.user});let d=ve(e.context.options,n,"update"),u=await e.context.internalAdapter.updateUserByEmail(i.user.email,{name:r,image:o,...d});return await I(e,{session:i.session,user:u}),e.json({user:u})}),Yt=b("/change-password",{method:"POST",body:T.z.object({newPassword:T.z.string(),currentPassword:T.z.string(),revokeOtherSessions:T.z.boolean().optional()}),use:[B]},async e=>{let{newPassword:t,currentPassword:r,revokeOtherSessions:o}=e.body,n=e.context.session,i=e.context.password.config.minPasswordLength;if(t.length<i)throw e.context.logger.error("Password is too short"),new P.APIError("BAD_REQUEST",{message:"Password is too short"});let d=e.context.password.config.maxPasswordLength;if(t.length>d)throw e.context.logger.error("Password is too long"),new P.APIError("BAD_REQUEST",{message:"Password too long"});let s=(await e.context.internalAdapter.findAccounts(n.user.id)).find(m=>m.providerId==="credential"&&m.password);if(!s||!s.password)throw new P.APIError("BAD_REQUEST",{message:"User does not have a password"});let a=await e.context.password.hash(t);if(!await e.context.password.verify(s.password,r))throw new P.APIError("BAD_REQUEST",{message:"Incorrect password"});if(await e.context.internalAdapter.updateAccount(s.id,{password:a}),o){await e.context.internalAdapter.deleteSessions(n.user.id);let m=await e.context.internalAdapter.createSession(n.user.id,e.headers);if(!m)throw new P.APIError("INTERNAL_SERVER_ERROR",{message:"Unable to create session"});await I(e,{session:m,user:n.user})}return e.json(n.user)}),Xt=b("/set-password",{method:"POST",body:T.z.object({newPassword:T.z.string()}),metadata:{SERVER_ONLY:!0},use:[B]},async e=>{let{newPassword:t}=e.body,r=e.context.session,o=e.context.password.config.minPasswordLength;if(t.length<o)throw e.context.logger.error("Password is too short"),new P.APIError("BAD_REQUEST",{message:"Password is too short"});let n=e.context.password.config.maxPasswordLength;if(t.length>n)throw e.context.logger.error("Password is too long"),new P.APIError("BAD_REQUEST",{message:"Password too long"});let d=(await e.context.internalAdapter.findAccounts(r.user.id)).find(s=>s.providerId==="credential"&&s.password),u=await e.context.password.hash(t);if(!d)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:u}),e.json(r.user);throw new P.APIError("BAD_REQUEST",{message:"user already has a password"})}),er=b("/delete-user",{method:"POST",body:T.z.object({password:T.z.string()}),use:[B]},async e=>{let{password:t}=e.body,r=e.context.session,n=(await e.context.internalAdapter.findAccounts(r.user.id)).find(d=>d.providerId==="credential"&&d.password);if(!n||!n.password)throw new P.APIError("BAD_REQUEST",{message:"User does not have a password"});if(!await e.context.password.verify(n.password,t))throw new P.APIError("BAD_REQUEST",{message:"Incorrect password"});return await e.context.internalAdapter.deleteUser(r.user.id),await e.context.internalAdapter.deleteSessions(r.user.id),q(e),e.json(null)}),tr=b("/change-email",{method:"POST",query:T.z.object({currentURL:T.z.string().optional()}).optional(),body:T.z.object({newEmail:T.z.string().email(),callbackURL:T.z.string().optional()}),use:[B]},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new P.APIError("BAD_REQUEST",{message:"Change email is disabled"});if(e.body.newEmail===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new P.APIError("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(e.body.newEmail))throw e.context.logger.error("Email already exists"),new P.APIError("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){let n=await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:e.body.newEmail});return e.json({user:n,status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new P.APIError("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await $(e.context.secret,e.context.session.user.email,e.body.newEmail),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:e.body.newEmail,url:o,token:r},e.request),e.json({user:null,status:!0})});var Fr=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,rr=b("/error",{method:"GET",metadata:G},async e=>{let t=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(Fr(t),{headers:{"Content-Type":"text/html"}})});var or=b("/ok",{method:"GET",metadata:G},async e=>e.json({ok:!0}));var K=require("zod");var V=require("better-call");var nr=()=>b("/sign-up/email",{method:"POST",query:K.z.object({currentURL:K.z.string().optional()}).optional(),body:K.z.record(K.z.string(),K.z.any())},async e=>{if(!e.context.options.emailAndPassword?.enabled)throw new V.APIError("BAD_REQUEST",{message:"Email and password sign up is not enabled"});let t=e.body,{name:r,email:o,password:n,image:i,callbackURL:d,...u}=t;if(!K.z.string().email().safeParse(o).success)throw new V.APIError("BAD_REQUEST",{message:"Invalid email"});let a=e.context.password.config.minPasswordLength;if(n.length<a)throw e.context.logger.error("Password is too short"),new V.APIError("BAD_REQUEST",{message:"Password is too short"});let c=e.context.password.config.maxPasswordLength;if(n.length>c)throw e.context.logger.error("Password is too long"),new V.APIError("BAD_REQUEST",{message:"Password is too long"});if((await e.context.internalAdapter.findUserByEmail(o))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${o}`),new V.APIError("UNPROCESSABLE_ENTITY",{message:"User with this email already exists"});let f=ve(e.context.options,u),l;try{if(l=await e.context.internalAdapter.createUser({email:o.toLowerCase(),name:r,image:i,...f,emailVerified:!1}),!l)throw new V.APIError("BAD_REQUEST",{message:"Failed to create user"})}catch(y){throw e.context.logger.error("Failed to create user",y),new V.APIError("UNPROCESSABLE_ENTITY",{message:"Failed to create user",details:y})}if(!l)throw new V.APIError("UNPROCESSABLE_ENTITY",{message:"Failed to create user"});let p=await e.context.password.hash(n);if(await e.context.internalAdapter.linkAccount({userId:l.id,providerId:"credential",accountId:l.id,password:p,expiresAt:_(60*60*24*30,"sec")}),e.context.options.emailVerification?.sendOnSignUp){let y=await $(e.context.secret,l.email),h=`${e.context.baseURL}/verify-email?token=${y}&callbackURL=${t.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:l,url:h,token:y},e.request)}if(!e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({user:l,session:null});let g=await e.context.internalAdapter.createSession(l.id,e.request);if(!g)throw new V.APIError("BAD_REQUEST",{message:"Failed to create session"});return await I(e,{session:g,user:l}),e.json({user:l,session:g})});var Y=require("zod");var Ve=require("better-call");var ir=b("/list-accounts",{method:"GET",use:[B]},async e=>{let t=e.context.session,r=await e.context.internalAdapter.findAccounts(t.user.id);return e.json(r.map(o=>({id:o.id,provider:o.providerId})))}),sr=b("/link-social",{method:"POST",requireHeaders:!0,query:Y.z.object({currentURL:Y.z.string().optional()}).optional(),body:Y.z.object({callbackURL:Y.z.string().optional(),provider:Y.z.enum(ye)}),use:[B]},async e=>{let t=e.context.session;if((await e.context.internalAdapter.findAccounts(t.user.id)).find(u=>u.providerId===e.body.provider))throw new Ve.APIError("BAD_REQUEST",{message:"Social Account is already linked."});let n=e.context.socialProviders.find(u=>u.id===e.body.provider);if(!n)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new Ve.APIError("NOT_FOUND",{message:"Provider not found"});let i=await oe(e,{userId:t.user.id,email:t.user.email}),d=await n.createAuthorizationURL({state:i.state,codeVerifier:i.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${n.id}`});return e.json({url:d.toString(),redirect:!0})});function Ue(e,t){if(t.advanced?.ipAddress?.disableIpTracking)return null;let r="127.0.0.1";if(We)return r;let n=t.advanced?.ipAddress?.ipAddressHeaders||["x-client-ip","x-forwarded-for","cf-connecting-ip","fastly-client-ip","x-real-ip","x-cluster-client-ip","x-forwarded","forwarded-for","forwarded"],i=e instanceof Request?e.headers:e;for(let d of n){let u=i.get(d);if(typeof u=="string"){let s=u.split(",")[0].trim();if(s)return s}}return null}function $r(e,t,r){let o=Date.now(),n=t*1e3;return o-r.lastRequest<n&&r.count>=e}function jr(e){return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":e.toString()}})}function zr(e,t){let r=Date.now(),o=t*1e3;return Math.ceil((e+o-r)/1e3)}function Mr(e,t){let r="rateLimit",o=e.adapter;return{get:async n=>await o.findOne({model:r,where:[{field:"key",value:n}]}),set:async(n,i,d)=>{try{d?await o.update({model:t??"rateLimit",where:[{field:"key",value:n}],update:{count:i.count,lastRequest:i.lastRequest}}):await o.create({model:t??"rateLimit",data:{key:n,count:i.count,lastRequest:i.lastRequest}})}catch(u){e.logger.error("Error setting rate limit",u)}}}}var ar=new Map;function Hr(e){return e.rateLimit.storage==="secondary-storage"?{get:async r=>{let o=await e.options.secondaryStorage?.get(r);return o?JSON.parse(o):void 0},set:async(r,o)=>{await e.options.secondaryStorage?.set?.(r,JSON.stringify(o))}}:e.rateLimit.storage==="memory"?{async get(r){return ar.get(r)},async set(r,o,n){ar.set(r,o)}}:Mr(e,e.rateLimit.modelName)}async function dr(e,t){if(!t.rateLimit.enabled)return;let r=t.baseURL,o=e.url.replace(r,""),n=t.rateLimit.window,i=t.rateLimit.max,d=Ue(e,t.options)+o,s=Gr().find(f=>f.pathMatcher(o));s&&(n=s.window,i=s.max);for(let f of t.options.plugins||[])if(f.rateLimit){let l=f.rateLimit.find(p=>p.pathMatcher(o));if(l){n=l.window,i=l.max;break}}if(t.rateLimit.customRules){let f=t.rateLimit.customRules[o];f&&(n=f.window,i=f.max)}let a=Hr(t),c=await a.get(d),m=Date.now();if(!c)await a.set(d,{key:d,count:1,lastRequest:m});else{let f=m-c.lastRequest;if($r(i,n,c)){let l=zr(c.lastRequest,n);return jr(l)}else f>n*1e3?await a.set(d,{...c,count:1,lastRequest:m}):await a.set(d,{...c,count:c.count+1,lastRequest:m})}}function Gr(){return[{pathMatcher(t){return t.startsWith("/sign-in")||t.startsWith("/sign-up")||t.startsWith("/change-password")||t.startsWith("/change-email")},window:10,max:3}]}var Kr=require("better-call");function Fe(e,t){let r=t.plugins?.reduce((u,s)=>({...u,...s.endpoints}),{}),o=t.plugins?.map(u=>u.middlewares?.map(s=>{let a=async c=>s.middleware({...c,context:{...e,...c.context}});return a.path=s.path,a.options=s.middleware.options,a.headers=s.middleware.headers,{path:s.path,middleware:a}})).filter(u=>u!==void 0).flat()||[],i={...{signInSocial:$t,callbackOAuth:zt,getSession:De(),signOut:Ht,signUpEmail:nr(),signInEmail:jt,forgetPassword:Kt,resetPassword:Wt,verifyEmail:Ft,sendVerificationEmail:Vt,changeEmail:tr,changePassword:Yt,setPassword:Xt,updateUser:Jt(),deleteUser:er,forgetPasswordCallback:Qt,listSessions:Ct(),revokeSession:Bt,revokeSessions:Dt,revokeOtherSessions:Nt,linkSocialAccount:sr,listUserAccounts:ir},...r,ok:or,error:rr},d={};for(let[u,s]of Object.entries(i))d[u]=async(a={})=>{let c=await e;c.session=null;for(let l of t.plugins||[])if(l.hooks?.before)for(let p of l.hooks.before){let g={...s,...a,context:{...c,...a?.context}};if(p.matcher(g)){let h=await p.handler(g);h&&"context"in h&&(a={...h,...a})}}let m;try{m=await s({...a,context:{...c,...a.context}})}catch(l){if(l instanceof M.APIError){let p=t.plugins?.map(h=>{if(h.hooks?.after)return h.hooks.after}).filter(h=>h!==void 0).flat();if(!p?.length)throw l;let g=new Response(JSON.stringify(l.body),{status:M.statusCode[l.status],headers:l.headers}),y;for(let h of p||[]){let A={...s,...a,context:{...c,...a.context,endpoint:s,returned:g}};if(h.matcher(A)){let v=await h.handler(A);v&&"response"in v&&(y=v.response)}}if(y instanceof Response)return y;throw l}throw l}let f=m;for(let l of t.plugins||[])if(l.hooks?.after)for(let p of l.hooks.after){let g={...s,...a,context:{...c,...a.context,endpoint:s,returned:f}};if(p.matcher(g)){let h=await p.handler(g);h&&("response"in h&&(f=h.response),"responseHeader"in h&&(f instanceof Response?f=new Response(f.body,{status:f.status,headers:{...f.headers,...h.responseHeader}}):d[u].headers=h.responseHeader))}}return f},d[u].path=s.path,d[u].method=s.method,d[u].options=s.options,d[u].headers=s.headers;return{api:d,middlewares:o}}var cr=(e,t)=>{let{api:r,middlewares:o}=Fe(e,t),n=new URL(e.baseURL).pathname;return(0,M.createRouter)(r,{extraContext:e,basePath:n,routerMiddleware:[{path:"/**",middleware:Ke},...o],async onRequest(i){for(let d of e.options.plugins||[])if(d.onRequest){let u=await d.onRequest(i,e);if(u&&"response"in u)return u.response}return dr(i,e)},async onResponse(i){for(let d of e.options.plugins||[])if(d.onResponse){let u=await d.onResponse(i,e);if(u)return u.response}return i},onError(i){if(i instanceof M.APIError&&i.status==="FOUND")return;if(t.onAPIError?.throw)throw i;if(t.onAPIError?.onError){t.onAPIError.onError(i,e);return}let d=t.logger?.level,u=d==="error"||d==="warn"||d==="debug"?S:void 0;if(t.logger?.disabled!==!0){if(i&&typeof i=="object"&&"message"in i&&typeof i.message=="string"&&(i.message.includes("no column")||i.message.includes("column")||i.message.includes("relation")||i.message.includes("table")||i.message.includes("does not exist"))){e.logger?.error(i.message),e.logger?.error("If you are seeing this error, it is likely that you need to run the migrations for the database or you need to update your database schema. If you recently updated the package, make sure to run the migrations.");return}i instanceof M.APIError?(i.status==="INTERNAL_SERVER_ERROR"&&e.logger.error(i.status,i),u?.error(i.message)):e.logger?.error(i&&typeof i=="object"&&"name"in i?i.name:"",i)}}})};var Ar=require("defu");var se=require("oslo/encoding");var ur=require("@noble/hashes/scrypt"),lr=require("uncrypto"),X={N:16384,r:16,p:1,dkLen:64};async function pr(e,t){return await(0,ur.scryptAsync)(e.normalize("NFKC"),t,{N:X.N,p:X.p,r:X.r,dkLen:X.dkLen,maxmem:128*X.N*X.r*2})}var fr=async e=>{let t=(0,se.encodeHex)((0,lr.getRandomValues)(new Uint8Array(16))),r=await pr(e,t);return`${t}:${(0,se.encodeHex)(r)}`},mr=async(e,t)=>{let[r,o]=e.split(":"),n=await pr(t,r);return Ee(n,(0,se.decodeHex)(o))};function gr(e,t){let r=t.hooks;async function o(d,u,s){let a=d;for(let f of r||[]){let l=f[u]?.create?.before;if(l){let p=await l(d);if(p===!1)return null;typeof p=="object"&&"data"in p&&(a=p.data)}}let c=s?await s.fn(a):null,m=!s||s.executeMainFn?await e.create({model:u,data:a}):c;for(let f of r||[]){let l=f[u]?.create?.after;l&&await l(m)}return m}async function n(d,u,s,a){let c=d;for(let l of r||[]){let p=l[s]?.update?.before;if(p){let g=await p(d);if(g===!1)return null;c=typeof g=="object"?g.data:g}}let m=a?await a.fn(c):null,f=!a||a.executeMainFn?await e.update({model:s,update:c,where:u}):m;for(let l of r||[]){let p=l[s]?.update?.after;p&&await p(f)}return f}async function i(d,u,s,a){let c=d;for(let l of r||[]){let p=l[s]?.update?.before;if(p){let g=await p(d);if(g===!1)return null;c=typeof g=="object"?g.data:g}}let m=a?await a.fn(c):null,f=!a||a.executeMainFn?await e.updateMany({model:s,update:c,where:u}):m;for(let l of r||[]){let p=l[s]?.update?.after;p&&await p(f)}return f}return{createWithHooks:o,updateWithHooks:n,updateManyWithHooks:i}}var $e=(e,t)=>{let r=t.options,o=r.secondaryStorage,n=r.session?.expiresIn||60*60*24*7,{createWithHooks:i,updateWithHooks:d,updateManyWithHooks:u}=gr(e,t);return{createOAuthUser:async(s,a)=>{try{let c=await i({id:C(),createdAt:new Date,updatedAt:new Date,...s},"user"),m=await i({id:C(),...a,userId:c.id||s.id},"account");return{user:c,account:m}}catch(c){return console.log(c),null}},createUser:async s=>await i({id:C(),createdAt:new Date,updatedAt:new Date,emailVerified:!1,...s},"user"),createAccount:async s=>await i({id:C(),createdAt:new Date,updatedAt:new Date,...s},"account"),listSessions:async s=>{if(o){let c=await o.get(`active-sessions-${s}`);if(!c)return[];let m=W(c)||[],f=Date.now(),l=m.filter(g=>g.expiresAt>f),p=[];for(let g of l){let y=await o.get(g.id);if(y){let h=JSON.parse(y),A=xe(t.options,{...h.session,expiresAt:new Date(h.session.expiresAt)});p.push(A)}}return p}return await e.findMany({model:"session",where:[{field:"userId",value:s}]})},listUsers:async(s,a,c,m)=>await e.findMany({model:"user",limit:s,offset:a,sortBy:c,where:m}),deleteUser:async s=>{await e.deleteMany({model:"session",where:[{field:"userId",value:s}]}),await e.deleteMany({model:"account",where:[{field:"userId",value:s}]}),await e.delete({model:"user",where:[{field:"id",value:s}]})},createSession:async(s,a,c,m)=>{let f=a instanceof Request?a.headers:a,l={expiresAt:c?_(60*60*24,"sec"):_(n,"sec"),ipAddress:a&&Ue(a,t.options)||"",userAgent:f?.get("user-agent")||"",...m,id:C(32),userId:s};return await i(l,"session",o?{fn:async g=>{let y=await e.findOne({model:"user",where:[{field:"id",value:s}]});o.set(g.id,JSON.stringify({session:g,user:y}),n);let h=await o.get(`active-sessions-${s}`),A=[],w=Date.now();return h&&(A=W(h)||[],A=A.filter(v=>v.expiresAt>w)),A.push({id:g.id,expiresAt:w+n*1e3}),await o.set(`active-sessions-${s}`,JSON.stringify(A),n),g},executeMainFn:r.session?.storeSessionInDatabase}:void 0)},findSession:async s=>{if(o){let f=await o.get(s);if(f){let l=JSON.parse(f),p=xe(t.options,{...l.session,expiresAt:new Date(l.session.expiresAt)}),g=qe(t.options,{...l.user,createdAt:new Date(l.user.createdAt),updatedAt:new Date(l.user.updatedAt)});return{session:p,user:g}}}let a=await e.findOne({model:"session",where:[{value:s,field:"id"}]});if(!a)return null;let c=await e.findOne({model:"user",where:[{value:a.userId,field:"id"}]});if(!c)return null;let m=qe(t.options,c);return{session:xe(t.options,a),user:m}},findSessions:async s=>{if(o){let f=[];for(let l of s){let p=await o.get(l);if(p){let g=JSON.parse(p),y={session:{...g.session,expiresAt:new Date(g.session.expiresAt)},user:{...g.user,createdAt:new Date(g.user.createdAt),updatedAt:new Date(g.user.updatedAt)}};f.push(y)}}return f}let a=await e.findMany({model:"session",where:[{field:"id",value:s,operator:"in"}]}),c=a.map(f=>f.userId);if(!c.length)return[];let m=await e.findMany({model:"user",where:[{field:"id",value:c,operator:"in"}]});return a.map(f=>{let l=m.find(p=>p.id===f.userId);return l?{session:f,user:l}:null})},updateSession:async(s,a)=>await d(a,[{field:"id",value:s}],"session",o?{async fn(m){let f=await o.get(s),l=null;if(f){let p=JSON.parse(f);l={...p.session,...m},await o.set(s,JSON.stringify({session:l,user:p.user}),p.session.expiresAt?Math.floor((p.session.expiresAt.getTime()-Date.now())/1e3):n)}else return null},executeMainFn:r.session?.storeSessionInDatabase}:void 0),deleteSession:async s=>{if(o){await o.delete(s),r.session?.storeSessionInDatabase&&await e.delete({model:"session",where:[{field:"id",value:s}]});return}await e.delete({model:"session",where:[{field:"id",value:s}]})},deleteSessions:async s=>{if(o){if(typeof s=="string"){let a=await o.get(`active-sessions-${s}`),c=a?W(a):[];if(!c)return;for(let m of c)await o.delete(m.id)}else for(let a of s)await o.get(a)&&await o.delete(a);r.session?.storeSessionInDatabase&&await e.deleteMany({model:"session",where:[{field:Array.isArray(s)?"id":"userId",value:s,operator:Array.isArray(s)?"in":void 0}]});return}await e.deleteMany({model:"session",where:[{field:Array.isArray(s)?"id":"userId",value:s,operator:Array.isArray(s)?"in":void 0}]})},findUserByEmail:async(s,a)=>{let c=await e.findOne({model:"user",where:[{value:s.toLowerCase(),field:"email"}]});if(!c)return null;if(a?.includeAccounts){let m=await e.findMany({model:"account",where:[{value:c.id,field:"userId"}]});return{user:c,accounts:m}}return{user:c,accounts:[]}},findUserById:async s=>await e.findOne({model:"user",where:[{field:"id",value:s}]}),linkAccount:async s=>await i({id:C(),...s},"account"),updateUser:async(s,a)=>await d(a,[{field:"id",value:s}],"user"),updateUserByEmail:async(s,a)=>await d(a,[{field:"email",value:s}],"user"),updatePassword:async(s,a)=>{await u({password:a},[{field:"userId",value:s},{field:"providerId",value:"credential"}],"account")},findAccounts:async s=>await e.findMany({model:"account",where:[{field:"userId",value:s}]}),findAccount:async s=>await e.findOne({model:"account",where:[{field:"accountId",value:s}]}),findAccountByUserId:async s=>await e.findMany({model:"account",where:[{field:"userId",value:s}]}),updateAccount:async(s,a)=>await d(a,[{field:"id",value:s}],"account"),createVerificationValue:async s=>await i({id:C(),createdAt:new Date,...s},"verification"),findVerificationValue:async s=>(await e.findMany({model:"verification",where:[{field:"identifier",value:s}],sortBy:{field:"createdAt",direction:"desc"},limit:10}))[0],deleteVerificationValue:async s=>{await e.delete({model:"verification",where:[{field:"id",value:s}]})},deleteVerificationByIdentifier:async s=>{await e.delete({model:"verification",where:[{field:"identifier",value:s}]})},updateVerificationValue:async(s,a)=>await d(a,[{field:"id",value:s}],"verification")}};var ae=e=>{let t=e.plugins?.reduce((s,a)=>{let c=a.schema;if(!c)return s;for(let[m,f]of Object.entries(c))s[m]={fields:{...s[m]?.fields,...f.fields},modelName:f.modelName||m};return s},{}),r=e.rateLimit?.storage==="database",o={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:n,session:i,account:d,...u}=t||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...n?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...i?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},expiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.expiresAt||"expiresAt"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},...d?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"}},order:4},...u,...r?o:{}}};var Qr=require("zod");var de=require("kysely"),j=require("kysely");function hr(e){if("dialect"in e)return hr(e.dialect);if("createDriver"in e){if(e instanceof j.SqliteDialect)return"sqlite";if(e instanceof j.MysqlDialect)return"mysql";if(e instanceof j.PostgresDialect)return"postgres";if(e instanceof de.MssqlDialect)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":null}var je=async e=>{let t=e.database;if("db"in t)return{kysely:t.db,databaseType:t.type};if("dialect"in t)return{kysely:new de.Kysely({dialect:t.dialect}),databaseType:t.type};let r,o=hr(t);return"createDriver"in t&&(r=t),"aggregate"in t&&(r=new j.SqliteDialect({database:t})),"getConnection"in t&&(r=new j.MysqlDialect(t)),"connect"in t&&(r=new j.PostgresDialect({pool:t})),{kysely:r?new de.Kysely({dialect:r}):null,databaseType:o}};var Wr=(e,t,r)=>{let o=ae(t);function n(a,c){if(c==="id")return c;let m=o[a].fields[c];return m||console.log("Field not found",a,c),m.fieldName||c}function i(a,c,m){let{type:f="sqlite"}=r||{},l=o[c].fields[m];return l.type==="boolean"&&f==="sqlite"?a?1:0:l.type==="date"&&a&&a instanceof Date&&f==="sqlite"?a.toISOString():a}function d(a,c,m){let{type:f="sqlite"}=r||{},l=o[c].fields[m];return l.type==="boolean"&&f==="sqlite"&&a!==null?a===1:l.type==="date"&&a?new Date(a):a}function u(a){return o[a].modelName}let s=r?.generateId!==!1;return{transformInput(a,c){let m=a.id&&s?{id:r?.generateId?r.generateId():a.id}:{};for(let f in a){let l=o[c].fields[f];l&&(m[l.fieldName||f]=i(a[f],c,f))}return m},transformOutput(a,c,m=[]){if(!a)return null;let f=a.id?m.length===0||m.includes("id")?{id:a.id}:{}:{},l=o[c].fields;for(let p in l){if(m.length&&!m.includes(p))continue;let g=l[p];g&&(f[p]=d(a[g.fieldName||p],c,p))}return f},convertWhereClause(a,c){if(!c)return{and:null,or:null};let m={and:[],or:[]};return c.forEach(f=>{let{field:l,value:p,operator:g="=",connector:y="AND"}=f,h=n(a,l),A=w=>g.toLowerCase()==="in"?w(h,"in",Array.isArray(p)?p:[p]):g==="contains"?w(h,"like",`%${p}%`):g==="starts_with"?w(h,"like",`${p}%`):g==="ends_with"?w(h,"like",`%${p}`):g==="eq"?w(h,"=",p):g==="ne"?w(h,"<>",p):g==="gt"?w(h,">",p):g==="gte"?w(h,">=",p):g==="lt"?w(h,"<",p):g==="lte"?w(h,"<=",p):w(h,g,p);y==="OR"?m.or.push(A):m.and.push(A)}),{and:m.and.length?m.and:null,or:m.or.length?m.or:null}},async withReturning(a,c,m,f){let l;if(r?.type!=="mysql")l=await c.returningAll().executeTakeFirst();else{await c.execute();let p=a.id?"id":f[0].field?f[0].field:"id",g=a[p]||f[0].value;l=await e.selectFrom(u(m)).selectAll().where(n(m,p),"=",g).executeTakeFirst()}return l},getModelName:u,getField:n}},yr=(e,t)=>r=>{let{transformInput:o,withReturning:n,transformOutput:i,convertWhereClause:d,getModelName:u,getField:s}=Wr(e,r,t);return{id:"kysely",async create(a){let{model:c,data:m,select:f}=a,l=o(m,c),p=e.insertInto(u(c)).values(l);return i(await n(l,p,c,[]),c,f)},async findOne(a){let{model:c,where:m,select:f}=a,{and:l,or:p}=d(c,m),g=e.selectFrom(u(c)).selectAll();l&&(g=g.where(h=>h.and(l.map(A=>A(h))))),p&&(g=g.where(h=>h.or(p.map(A=>A(h)))));let y=await g.executeTakeFirst();return y?i(y,c,f):null},async findMany(a){let{model:c,where:m,limit:f,offset:l,sortBy:p}=a,{and:g,or:y}=d(c,m),h=e.selectFrom(u(c));g&&(h=h.where(w=>w.and(g.map(v=>v(w))))),y&&(h=h.where(w=>w.or(y.map(v=>v(w))))),h=h.limit(f||100),l&&(h=h.offset(l)),p&&(h=h.orderBy(s(c,p.field),p.direction));let A=await h.selectAll().execute();return A?A.map(w=>i(w,c)):[]},async update(a){let{model:c,where:m,update:f}=a,{and:l,or:p}=d(c,m),g=o(f,c),y=e.updateTable(u(c)).set(g);return l&&(y=y.where(h=>h.and(l.map(A=>A(h))))),p&&(y=y.where(h=>h.or(p.map(A=>A(h))))),i(await n(g,y,c,m),c)},async updateMany(a){let{model:c,where:m,update:f}=a,{and:l,or:p}=d(c,m),g=o(f,c),y=e.updateTable(u(c)).set(g);return l&&(y=y.where(A=>A.and(l.map(w=>w(A))))),p&&(y=y.where(A=>A.or(p.map(w=>w(A))))),(await y.execute()).length},async delete(a){let{model:c,where:m}=a,{and:f,or:l}=d(c,m),p=e.deleteFrom(u(c));f&&(p=p.where(g=>g.and(f.map(y=>y(g))))),l&&(p=p.where(g=>g.or(l.map(y=>y(g))))),await p.execute()},async deleteMany(a){let{model:c,where:m}=a,{and:f,or:l}=d(c,m),p=e.deleteFrom(u(c));return f&&(p=p.where(g=>g.and(f.map(y=>y(g))))),l&&(p=p.where(g=>g.or(l.map(y=>y(g))))),(await p.execute()).length},options:t}};async function wr(e){if(!e.database)throw new O("Database configuration is required");if(typeof e.database=="function")return e.database(e);let{kysely:t,databaseType:r}=await je(e);if(!t)throw new O("Failed to initialize database adapter");return yr(t,{generateId:"generateId"in e.database?e.database.generateId:void 0,type:r||"sqlite"})(e)}var ze="better-auth-secret-123456789";var Me=require("better-call");async function br(e,t){let o=(await t.context.internalAdapter.findAccounts(e))?.find(d=>d.providerId==="credential"),n=o?.password;if(!o||!n)throw new Me.APIError("BAD_REQUEST",{message:"No password credential found"});if(!await t.context.password.verify(n,t.body.password))throw new Me.APIError("BAD_REQUEST",{message:"Invalid password"});return!0}var kr=async e=>{let t=await wr(e),r=e.plugins||[],o=Jr(e),n=ne(e.logger),i=re(e.baseURL,e.basePath),d=e.secret||L.BETTER_AUTH_SECRET||L.AUTH_SECRET||ze;d===ze&&te&&n.error("You are using the default secret. Please set `BETTER_AUTH_SECRET` in your environment variables or pass `secret` in your auth config."),e={...e,secret:d,baseURL:i?new URL(i).origin:"",basePath:e.basePath||"/api/auth",plugins:r.concat(o),emailAndPassword:{...e.emailAndPassword,enabled:e.emailAndPassword?.enabled??!1,autoSignIn:e.emailAndPassword?.autoSignIn??!0}};let u=Ie(e),s=ae(e),a=Object.keys(e.socialProviders||{}).map(f=>{let l=e.socialProviders?.[f];return l.enabled===!1?null:((!l.clientId||!l.clientSecret)&&n.warn(`Social provider ${f} is missing clientId or clientSecret`),Be[f](l))}).filter(f=>f!==null),c={appName:e.appName||"Better Auth",socialProviders:a,options:e,tables:s,trustedOrigins:Yr(e),baseURL:i||"",sessionConfig:{updateAge:e.session?.updateAge||24*60*60,expiresIn:e.session?.expiresIn||60*60*24*7},secret:d,rateLimit:{...e.rateLimit,enabled:e.rateLimit?.enabled??te,window:e.rateLimit?.window||10,max:e.rateLimit?.max||100,storage:e.rateLimit?.storage||e.secondaryStorage?"secondary-storage":"memory"},authCookies:u,logger:n,uuid:C,session:null,secondaryStorage:e.secondaryStorage,password:{hash:e.emailAndPassword?.password?.hash||fr,verify:e.emailAndPassword?.password?.verify||mr,config:{minPasswordLength:e.emailAndPassword?.minPasswordLength||8,maxPasswordLength:e.emailAndPassword?.maxPasswordLength||128},checkPassword:br},adapter:t,internalAdapter:$e(t,{options:e,hooks:e.databaseHooks?[e.databaseHooks]:[]}),createAuthCookie:me(e)},{context:m}=Zr(c);return m};function Zr(e){let t=e.options,r=t.plugins||[],o=e,n=[];for(let i of r)if(i.init){let d=i.init(e);typeof d=="object"&&(d.options&&(d.options.databaseHooks&&n.push(d.options.databaseHooks),t=(0,Ar.defu)(t,d.options)),d.context&&(o={...o,...d.context}))}return n.push(t.databaseHooks),o.internalAdapter=$e(e.adapter,{options:t,hooks:n.filter(i=>i!==void 0)}),o.options=t,{context:o}}function Jr(e){let t=[];return e.advanced?.crossSubDomainCookies?.enabled,t}function Yr(e){let t=re(e.baseURL,e.basePath);if(!t)return[];let r=[new URL(t).origin];e.trustedOrigins&&r.push(...e.trustedOrigins);let o=L.BETTER_AUTH_TRUSTED_ORIGINS;return o&&r.push(...o.split(",")),r}var Xr=e=>{let t=kr(e),{api:r}=Fe(t,e);return{handler:async o=>{let n=await t,i=n.options.basePath||"/api/auth",d=new URL(o.url);if(!n.options.baseURL){let s=re(void 0,i)||`${d.origin}${i}`;n.options.baseURL=s,n.baseURL=s}if(n.trustedOrigins.push(d.origin),!n.options.baseURL)return new Response("Base URL not set",{status:400});if(d.pathname===i||d.pathname===`${i}/`)return new Response("Welcome to BetterAuth",{status:200});let{handler:u}=cr(n,e);return u(o)},api:r,options:e,$context:t,$Infer:{}}};0&&(module.exports={BetterAuthError,HIDE_METADATA,MissingDependencyError,betterAuth,capitalizeFirstLetter,createCookieGetter,createLogger,deleteSessionCookie,generateId,generateState,getCookies,levels,logger,parseCookies,parseSetCookieHeader,parseState,setSessionCookie,shouldPublishLog});
