import{getCurrentInstance as k,getCurrentScope as W,onScopeDispose as j,readonly as q,shallowRef as D}from"vue";function V(e){let t=k();if(t&&t.proxy){let n=t.proxy;("_nanostores"in n?n._nanostores:n._nanostores=[]).push(e)}}function U(e){let t=D(),n=e.subscribe(s=>{t.value=s});return W()&&j(n),process.env.NODE_ENV!=="production"?(V(e),q(t)):t}import{createFetch as K}from"@better-fetch/fetch";var S=Object.create(null),h=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?S:globalThis),d=new Proxy(S,{get(e,t){return h()[t]??S[t]},has(e,t){let n=h();return t in n||t in S},set(e,t,n){let s=h(!0);return s[t]=n,!0},deleteProperty(e,t){if(!t)return!1;let n=h(!0);return delete n[t],!0},ownKeys(){let e=h(!0);return Object.keys(e)}});function H(e){return e?e!=="false":!1}var N=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var ee=N==="test"||H(d.TEST);var b=class extends Error{constructor(t,n){super(t),this.name="BetterAuthError",this.message=t,this.cause=n,this.stack=""}};function M(e){try{return new URL(e).pathname!=="/"}catch{throw new b(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function T(e,t="/api/auth"){return M(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function w(e,t){if(e)return T(e,t);let n=d.BETTER_AUTH_URL||d.NEXT_PUBLIC_BETTER_AUTH_URL||d.PUBLIC_BETTER_AUTH_URL||d.NUXT_PUBLIC_BETTER_AUTH_URL||d.NUXT_PUBLIC_AUTH_URL||(d.BASE_URL!=="/"?d.BASE_URL:void 0);if(n)return T(n,t);if(typeof window<"u"&&window.location)return T(window.location.origin,t)}import"nanostores";import"@better-fetch/fetch";var F={id:"redirect",name:"Redirect",hooks:{onSuccess(e){if(e.data?.url&&e.data?.redirect&&typeof window<"u"&&window.location&&window.location)try{window.location.href=e.data.url}catch{}}}},v={id:"add-current-url",name:"Add current URL",hooks:{onRequest(e){if(typeof window<"u"&&window.location&&window.location)try{let t=new URL(e.url);t.searchParams.set("currentURL",window.location.href),e.url=t}catch{}return e}}};import{atom as X}from"nanostores";import"@better-fetch/fetch";import{atom as G,onMount as z}from"nanostores";var B=(e,t,n,s)=>{let o=G({data:null,error:null,isPending:!0,isRefetching:!1}),p=()=>{let a=typeof s=="function"?s({data:o.get().data,error:o.get().error,isPending:o.get().isPending}):s;return n(t,{...a,async onSuccess(l){o.set({data:l.data,error:null,isPending:!1,isRefetching:!1}),await a?.onSuccess?.(l)},async onError(l){o.set({error:l.error,data:null,isPending:!1,isRefetching:!1}),await a?.onError?.(l)},async onRequest(l){let i=o.get();o.set({isPending:i.data===null,data:i.data,error:null,isRefetching:!0}),await a?.onRequest?.(l)}})};e=Array.isArray(e)?e:[e];let f=!1;for(let a of e)a.subscribe(()=>{f?p():z(o,()=>(p(),f=!0,()=>{o.off(),a.off()}))});return o};function L(e){let t=X(!1);return{session:B(t,"/get-session",e,{method:"GET"}),$sessionSignal:t}}var C=e=>{let t="credentials"in Request.prototype,n=w(e?.baseURL),s=e?.plugins?.flatMap(r=>r.fetchPlugins).filter(r=>r!==void 0)||[],o=K({baseURL:n,...t?{credentials:"include"}:{},method:"GET",...e?.fetchOptions,plugins:e?.disableDefaultFetchPlugins?[...e?.fetchOptions?.plugins||[],...s]:[F,v,...e?.fetchOptions?.plugins||[],...s]}),{$sessionSignal:p,session:f}=L(o),a=e?.plugins||[],l={},i={$sessionSignal:p,session:f},c={"/sign-out":"POST","/revoke-sessions":"POST","/revoke-other-sessions":"POST"},u=[{signal:"$sessionSignal",matcher(r){return r==="/sign-out"||r==="/update-user"||r.startsWith("/sign-in")||r.startsWith("/sign-up")}}];for(let r of a)r.getAtoms&&Object.assign(i,r.getAtoms?.(o)),r.pathMethods&&Object.assign(c,r.pathMethods),r.atomListeners&&u.push(...r.atomListeners);let g={notify:r=>{i[r].set(!i[r].get())},listen:(r,m)=>{i[r].subscribe(m)},atoms:i};for(let r of a)r.getActions&&Object.assign(l,r.getActions?.(o,g));return{pluginsActions:l,pluginsAtoms:i,pluginPathMethods:c,atomListeners:u,$fetch:o,$store:g}};function E(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Q(e,t,n){let s=t[e],{fetchOptions:o,query:p,...f}=n||{};return s||(o?.method?o.method:f&&Object.keys(f).length>0?"POST":"GET")}function _(e,t,n,s,o){function p(f=[]){return new Proxy(function(){},{get(a,l){let i=[...f,l],c=e;for(let u of i)if(c&&typeof c=="object"&&u in c)c=c[u];else{c=void 0;break}return typeof c=="function"?c:p(i)},apply:async(a,l,i)=>{let c="/"+f.map(O=>O.replace(/[A-Z]/g,R=>`-${R.toLowerCase()}`)).join("/"),u=i[0]||{},g=i[1]||{},{query:r,fetchOptions:m,...y}=u,P={...g,...m},x=Q(c,n,u);return await t(c,{...P,body:x==="GET"?void 0:{...y,...P?.body||{}},query:r||P?.query,method:x,async onSuccess(O){await P?.onSuccess?.(O);let R=o?.find($=>$.matcher(c));if(!R)return;let A=s[R.signal];if(!A)return;let I=A.get();setTimeout(()=>{A.set(!I)},10)}})}})}return p()}function Z(e){return`use${E(e)}`}function we(e){let{pluginPathMethods:t,pluginsActions:n,pluginsAtoms:s,$fetch:o,$store:p,atomListeners:f}=C(e),a={};for(let[u,g]of Object.entries(s))a[Z(u)]=()=>U(g);function l(u){if(u){let g=U(s.$sessionSignal),r=e?.fetchOptions?.baseURL||e?.baseURL,m=r?new URL(r).pathname:"/api/auth";return u(`${m}/get-session`,{ref:g}).then(y=>({data:y.data,isPending:!1,error:y.error}))}return a.useSession()}let i={...n,...a,useSession:l,$fetch:o,$store:p};return _(i,o,t,s,f)}export{we as createAuthClient};
