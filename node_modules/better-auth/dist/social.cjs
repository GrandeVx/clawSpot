"use strict";var v=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var de=(e,t)=>{for(var r in t)v(e,r,{get:t[r],enumerable:!0})},pe=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ce(t))!le.call(e,o)&&o!==r&&v(e,o,{get:()=>t[o],enumerable:!(i=se(t,o))||i.enumerable});return e};var ue=e=>pe(v({},"__esModule",{value:!0}),e);var we={};de(we,{apple:()=>y,discord:()=>x,dropbox:()=>T,facebook:()=>P,getApplePublicKey:()=>J,github:()=>A,gitlab:()=>C,google:()=>k,linkedin:()=>z,microsoft:()=>R,socialProviderList:()=>Pe,socialProviders:()=>ae,spotify:()=>L,twitch:()=>O,twitter:()=>I});module.exports=ue(we);var F=require("@better-fetch/fetch"),H=require("better-call"),f=require("jose"),M=require("oslo/jwt");var S=require("oslo/crypto"),V=require("oslo/encoding");var $=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));async function B(e){let t=await(0,S.sha256)(new TextEncoder().encode(e));return V.base64url.encode(new Uint8Array(t),{includePadding:!1})}function D(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?$(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function d({id:e,options:t,authorizationEndpoint:r,state:i,codeVerifier:o,scopes:n,claims:a,redirectURI:c}){let s=new URL(r);if(s.searchParams.set("response_type","code"),s.searchParams.set("client_id",t.clientId),s.searchParams.set("state",i),s.searchParams.set("scope",n.join(" ")),s.searchParams.set("redirect_uri",t.redirectURI||c),o){let p=await B(o);s.searchParams.set("code_challenge_method","S256"),s.searchParams.set("code_challenge",p)}if(a){let p=a.reduce((u,b)=>(u[b]=null,u),{});s.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...p}}))}return s}var j=require("@better-fetch/fetch");async function l({code:e,codeVerifier:t,redirectURI:r,options:i,tokenEndpoint:o,authentication:n}){let a=new URLSearchParams,c={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(a.set("grant_type","authorization_code"),a.set("code",e),t&&a.set("code_verifier",t),a.set("redirect_uri",r),n==="basic"){let b=btoa(`${i.clientId}:${i.clientSecret}`);c.authorization=`Basic ${b}`}else a.set("client_id",i.clientId),a.set("client_secret",i.clientSecret);let{data:s,error:p}=await(0,j.betterFetch)(o,{method:"POST",body:a,headers:c});if(p)throw p;return D(s)}var N=require("oslo/oauth2"),ge=require("zod"),he=require("better-call");var _=Object.create(null),h=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?_:globalThis),G=new Proxy(_,{get(e,t){return h()[t]??_[t]},has(e,t){let r=h();return t in r||t in _},set(e,t,r){let i=h(!0);return i[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=h(!0);return delete r[t],!0},ownKeys(){let e=h(!0);return Object.keys(e)}});function me(e){return e?e!=="false":!1}var fe=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var ze=fe==="test"||me(G.TEST);var m=class extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}};var y=e=>{let t="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:i,redirectURI:o}){let n=i||["email","name"];return e.scope&&n.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${o||e.redirectURI}&scope=${n.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:async({code:r,codeVerifier:i,redirectURI:o})=>l({code:r,codeVerifier:i,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:t}),async verifyIdToken(r,i){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,i);let o=(0,f.decodeProtectedHeader)(r),{kid:n,alg:a}=o;if(!n||!a)return!1;let c=await J(n),{payload:s}=await(0,f.jwtVerify)(r,c,{algorithms:[a],issuer:"https://appleid.apple.com",audience:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(p=>{s[p]!==void 0&&(s[p]=!!s[p])}),i&&s.nonce!==i?!1:!!s},async getUserInfo(r){if(!r.idToken)return null;let i=(0,M.parseJWT)(r.idToken)?.payload;if(!i)return null;let o=i.user?`${i.user.name.firstName} ${i.user.name.lastName}`:i.email;return{user:{id:i.sub,name:o,emailVerified:!1,email:i.email},data:i}}}},J=async e=>{let t="https://appleid.apple.com",r="/auth/keys",{data:i}=await(0,F.betterFetch)(`${t}${r}`);if(!i?.keys)throw new H.APIError("BAD_REQUEST",{message:"Keys not found"});let o=i.keys.find(n=>n.kid===e);if(!o)throw new Error(`JWK with kid ${e} not found`);return await(0,f.importJWK)(o,o.alg)};var K=require("@better-fetch/fetch");var x=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let o=r||["identify","email"];return e.scope&&o.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${o.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||i)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>l({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){let{data:r,error:i}=await(0,K.betterFetch)("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(i)return null;if(r.avatar===null){let o=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${o}.png`}else{let o=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${o}`}return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url},data:r}}});var W=require("@better-fetch/fetch");var P=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let o=r||["email","public_profile"];return e.scope&&o.push(...e.scope),await d({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:o,state:t,redirectURI:i})},validateAuthorizationCode:async({code:t,redirectURI:r})=>l({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async getUserInfo(t){let{data:r,error:i}=await(0,W.betterFetch)("https://graph.facebook.com/me?fields=id,name,email,picture",{auth:{type:"Bearer",token:t.accessToken}});return i?null:{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified},data:r}}});var w=require("@better-fetch/fetch");var A=e=>{let t="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:i,codeVerifier:o,redirectURI:n}){let a=i||["user:email"];return e.scope&&a.push(...e.scope),d({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:a,state:r,redirectURI:n})},validateAuthorizationCode:async({code:r,redirectURI:i})=>l({code:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:t}),async getUserInfo(r){let{data:i,error:o}=await(0,w.betterFetch)("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(o)return null;let n=!1;if(!i.email){let{data:a,error:c}=await(0,w.betterFetch)("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});c||(i.email=(a.find(s=>s.primary)??a[0])?.email,n=a.find(s=>s.email===i.email)?.verified??!1)}return{user:{id:i.id.toString(),name:i.name||i.login,email:i.email,image:i.avatar_url,emailVerified:n},data:i}}}};var Q=require("oslo/jwt");var q=require("consola"),U=["info","success","warn","error","debug"];function _e(e,t){return U.indexOf(t)<=U.indexOf(e)}var be=(0,q.createConsola)({formatOptions:{date:!1,colors:!0,compact:!0},defaults:{tag:"Better Auth"}}),ve=e=>{let t=e?.disabled!==!0,r=e?.level??"error",i=(o,n,a=[])=>{if(!(!t||!_e(r,o))){if(!e||typeof e.log!="function"){be[o]("",n,...a);return}e.log(o==="success"?"info":o,n,a)}};return Object.fromEntries(U.map(o=>[o,(...[n,...a])=>i(o,n,a)]))},g=ve();var X=require("@better-fetch/fetch"),k=e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:o}){if(!e.clientId||!e.clientSecret)throw g.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new m("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new m("codeVerifier is required for Google");let n=r||["email","profile","openid"];e.scope&&n.push(...e.scope);let a=await d({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:n,state:t,codeVerifier:i,redirectURI:o});return e.accessType&&a.searchParams.set("access_type",e.accessType),e.prompt&&a.searchParams.set("prompt",e.prompt),a},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>l({code:t,codeVerifier:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let i=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${t}`,{data:o}=await(0,X.betterFetch)(i);return o?o.aud===e.clientId&&o.iss==="https://accounts.google.com":!1},async getUserInfo(t){if(!t.idToken)return null;let r=(0,Q.parseJWT)(t.idToken)?.payload;return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified},data:r}}});var Y=require("@better-fetch/fetch"),Z=require("oslo/jwt");var R=e=>{let t=e.tenantId||"common",r=`https://login.microsoftonline.com/${t}/oauth2/v2.0/authorize`,i=`https://login.microsoftonline.com/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(o){let n=o.scopes||["openid","profile","email","User.Read"];return e.scope&&n.push(...e.scope),d({id:"microsoft",options:e,authorizationEndpoint:r,state:o.state,codeVerifier:o.codeVerifier,scopes:n,redirectURI:o.redirectURI})},validateAuthorizationCode({code:o,codeVerifier:n,redirectURI:a}){return l({code:o,codeVerifier:n,redirectURI:e.redirectURI||a,options:e,tokenEndpoint:i})},async getUserInfo(o){if(!o.idToken)return null;let n=(0,Z.parseJWT)(o.idToken)?.payload,a=e.profilePhotoSize||48;return await(0,Y.betterFetch)(`https://graph.microsoft.com/v1.0/me/photos/${a}x${a}/$value`,{headers:{Authorization:`Bearer ${o.accessToken}`},async onResponse(c){if(!(e.disableProfilePhoto||!c.response.ok))try{let p=await c.response.clone().arrayBuffer(),u=Buffer.from(p).toString("base64");n.picture=`data:image/jpeg;base64, ${u}`}catch(s){g.error(s&&typeof s=="object"&&"name"in s?s.name:"",s)}}}),{user:{id:n.sub,name:n.name,email:n.email,image:n.picture,emailVerified:!0},data:n}}}};var ee=require("@better-fetch/fetch");var L=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:o}){let n=r||["user-read-email"];return e.scope&&n.push(...e.scope),d({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:n,state:t,codeVerifier:i,redirectURI:o})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>l({code:t,codeVerifier:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){let{data:r,error:i}=await(0,ee.betterFetch)("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});return i?null:{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1},data:r}}});var ye=require("nanoid");var re=require("oslo/jwt");var O=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let o=r||["user:read:email","openid"];return e.scope&&o.push(...e.scope),d({id:"twitch",redirectURI:i,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:o,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>l({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){let r=t.idToken;if(!r)return g.error("No idToken found in token"),null;let i=(0,re.parseJWT)(r)?.payload;return{user:{id:i.sub,name:i.preferred_username,email:i.email,image:i.picture,emailVerified:!1},data:i}}});var te=require("@better-fetch/fetch");var I=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){let r=t.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),d({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>l({code:t,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||i,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){let{data:r,error:i}=await(0,te.betterFetch)("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});return i?null:{user:{id:r.data.id,name:r.data.name,email:r.data.email||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1},data:r}}});var ie=require("@better-fetch/fetch");var T=e=>{let t="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:i,codeVerifier:o,redirectURI:n})=>{let a=i||["account_info.read"];return e.scope&&a.push(...e.scope),await d({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:a,state:r,redirectURI:n,codeVerifier:o})},validateAuthorizationCode:async({code:r,codeVerifier:i,redirectURI:o})=>await l({code:r,codeVerifier:i,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:t}),async getUserInfo(r){let{data:i,error:o}=await(0,ie.betterFetch)("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});return o?null:{user:{id:i.account_id,name:i.name?.display_name,email:i.email,emailVerified:i.email_verified||!1,image:i.profile_photo_url},data:i}}}};var oe=require("@better-fetch/fetch");var z=e=>{let t="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:i,scopes:o,redirectURI:n})=>{let a=o||["profile","email","openid"];return e.scope&&a.push(...e.scope),await d({id:"linkedin",options:e,authorizationEndpoint:t,scopes:a,state:i,redirectURI:n})},validateAuthorizationCode:async({code:i,redirectURI:o})=>await l({code:i,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:r}),async getUserInfo(i){let{data:o,error:n}=await(0,oe.betterFetch)("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});return n?null:{user:{id:o.sub,name:o.name,email:o.email,emailVerified:o.email_verified||!1,image:o.picture},data:o}}}};var ne=require("@better-fetch/fetch");var E=(e="")=>e.split("://").map(t=>t.replace(/\/{2,}/g,"/")).join("://"),xe=e=>{let t=e||"https://gitlab.com";return{authorizationEndpoint:E(`${t}/oauth/authorize`),tokenEndpoint:E(`${t}/oauth/token`),userinfoEndpoint:E(`${t}/api/v4/user`)}},C=e=>{let{authorizationEndpoint:t,tokenEndpoint:r,userinfoEndpoint:i}=xe(e.issuer),o="gitlab";return{id:o,name:"Gitlab",createAuthorizationURL:async({state:a,scopes:c,codeVerifier:s,redirectURI:p})=>{let u=c||["read_user"];return e.scope&&u.push(...e.scope),await d({id:o,options:e,authorizationEndpoint:t,scopes:u,state:a,redirectURI:p,codeVerifier:s})},validateAuthorizationCode:async({code:a,redirectURI:c,codeVerifier:s})=>l({code:a,redirectURI:e.redirectURI||c,options:e,codeVerifier:s,tokenEndpoint:r}),async getUserInfo(a){let{data:c,error:s}=await(0,ne.betterFetch)(i,{headers:{authorization:`Bearer ${a.accessToken}`}});return s||c.state!=="active"||c.locked?null:{user:{id:c.id.toString(),name:c.name??c.username,email:c.email,image:c.avatar_url,emailVerified:!0},data:c}}}};var ae={apple:y,discord:x,facebook:P,github:A,microsoft:R,google:k,spotify:L,twitch:O,twitter:I,dropbox:T,linkedin:z,gitlab:C},Pe=Object.keys(ae);0&&(module.exports={apple,discord,dropbox,facebook,getApplePublicKey,github,gitlab,google,linkedin,microsoft,socialProviderList,socialProviders,spotify,twitch,twitter});
