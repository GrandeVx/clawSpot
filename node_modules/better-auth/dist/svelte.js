import{createFetch as M}from"@better-fetch/fetch";var P=Object.create(null),g=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?P:globalThis),p=new Proxy(P,{get(e,t){return g()[t]??P[t]},has(e,t){let r=g();return t in r||t in P},set(e,t,r){let i=g(!0);return i[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=g(!0);return delete r[t],!0},ownKeys(){let e=g(!0);return Object.keys(e)}});function $(e){return e?e!=="false":!1}var k=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var D=k==="test"||$(p.TEST);var A=class extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}};function W(e){try{return new URL(e).pathname!=="/"}catch{throw new A(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function T(e,t="/api/auth"){return W(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function S(e,t){if(e)return T(e,t);let r=p.BETTER_AUTH_URL||p.NEXT_PUBLIC_BETTER_AUTH_URL||p.PUBLIC_BETTER_AUTH_URL||p.NUXT_PUBLIC_BETTER_AUTH_URL||p.NUXT_PUBLIC_AUTH_URL||(p.BASE_URL!=="/"?p.BASE_URL:void 0);if(r)return T(r,t);if(typeof window<"u"&&window.location)return T(window.location.origin,t)}import"nanostores";import"@better-fetch/fetch";var B={id:"redirect",name:"Redirect",hooks:{onSuccess(e){if(e.data?.url&&e.data?.redirect&&typeof window<"u"&&window.location&&window.location)try{window.location.href=e.data.url}catch{}}}},F={id:"add-current-url",name:"Add current URL",hooks:{onRequest(e){if(typeof window<"u"&&window.location&&window.location)try{let t=new URL(e.url);t.searchParams.set("currentURL",window.location.href),e.url=t}catch{}return e}}};import{atom as H}from"nanostores";import"@better-fetch/fetch";import{atom as j,onMount as q}from"nanostores";var w=(e,t,r,i)=>{let o=j({data:null,error:null,isPending:!0,isRefetching:!1}),f=()=>{let c=typeof i=="function"?i({data:o.get().data,error:o.get().error,isPending:o.get().isPending}):i;return r(t,{...c,async onSuccess(l){o.set({data:l.data,error:null,isPending:!1,isRefetching:!1}),await c?.onSuccess?.(l)},async onError(l){o.set({error:l.error,data:null,isPending:!1,isRefetching:!1}),await c?.onError?.(l)},async onRequest(l){let a=o.get();o.set({isPending:a.data===null,data:a.data,error:null,isRefetching:!0}),await c?.onRequest?.(l)}})};e=Array.isArray(e)?e:[e];let u=!1;for(let c of e)c.subscribe(()=>{u?f():q(o,()=>(f(),u=!0,()=>{o.off(),c.off()}))});return o};function x(e){let t=H(!1);return{session:w(t,"/get-session",e,{method:"GET"}),$sessionSignal:t}}var v=e=>{let t="credentials"in Request.prototype,r=S(e?.baseURL),i=e?.plugins?.flatMap(n=>n.fetchPlugins).filter(n=>n!==void 0)||[],o=M({baseURL:r,...t?{credentials:"include"}:{},method:"GET",...e?.fetchOptions,plugins:e?.disableDefaultFetchPlugins?[...e?.fetchOptions?.plugins||[],...i]:[B,F,...e?.fetchOptions?.plugins||[],...i]}),{$sessionSignal:f,session:u}=x(o),c=e?.plugins||[],l={},a={$sessionSignal:f,session:u},s={"/sign-out":"POST","/revoke-sessions":"POST","/revoke-other-sessions":"POST"},d=[{signal:"$sessionSignal",matcher(n){return n==="/sign-out"||n==="/update-user"||n.startsWith("/sign-in")||n.startsWith("/sign-up")}}];for(let n of c)n.getAtoms&&Object.assign(a,n.getAtoms?.(o)),n.pathMethods&&Object.assign(s,n.pathMethods),n.atomListeners&&d.push(...n.atomListeners);let m={notify:n=>{a[n].set(!a[n].get())},listen:(n,O)=>{a[n].subscribe(O)},atoms:a};for(let n of c)n.getActions&&Object.assign(l,n.getActions?.(o,m));return{pluginsActions:l,pluginsAtoms:a,pluginPathMethods:s,atomListeners:d,$fetch:o,$store:m}};function C(e){return e.charAt(0).toUpperCase()+e.slice(1)}function G(e,t,r){let i=t[e],{fetchOptions:o,query:f,...u}=r||{};return i||(o?.method?o.method:u&&Object.keys(u).length>0?"POST":"GET")}function L(e,t,r,i,o){function f(u=[]){return new Proxy(function(){},{get(c,l){let a=[...u,l],s=e;for(let d of a)if(s&&typeof s=="object"&&d in s)s=s[d];else{s=void 0;break}return typeof s=="function"?s:f(a)},apply:async(c,l,a)=>{let s="/"+u.map(b=>b.replace(/[A-Z]/g,y=>`-${y.toLowerCase()}`)).join("/"),d=a[0]||{},m=a[1]||{},{query:n,fetchOptions:O,...E}=d,h={...m,...O},U=G(s,r,d);return await t(s,{...h,body:U==="GET"?void 0:{...E,...h?.body||{}},query:n||h?.query,method:U,async onSuccess(b){await h?.onSuccess?.(b);let y=o?.find(I=>I.matcher(s));if(!y)return;let R=i[y.signal];if(!R)return;let _=R.get();setTimeout(()=>{R.set(!_)},10)}})}})}return f()}function he(e){let{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:i,$fetch:o,atomListeners:f,$store:u}=v(e),c={};for(let[s,d]of Object.entries(i))c[`use${C(s)}`]=()=>d;let l={...r,...c,$fetch:o,$store:u};return L(l,o,t,i,f)}export{he as createAuthClient};
